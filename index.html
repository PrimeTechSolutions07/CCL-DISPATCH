<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coastal City Logistics — Dispatch Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#0a0f1a;--panel:#111827;--ink:#f8fafc;--muted:#9fb2c8;--line:#1f2937;--brand:#2563eb;--brand-2:#0f766e;--ios:#0A84FF;--ios-hover:#007AFF}
    body{background:var(--bg);color:var(--ink)}
    .brand-grad{background:linear-gradient(120deg,#1e3a8a 0%, var(--brand-2) 100%)}
    .card{border:1px solid #1e293b;border-radius:16px;background:var(--panel);box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .pill{border:1px solid #1f2a44;background:#0f172a;border-radius:9999px;padding:6px 10px;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:left;white-space:nowrap}
    th{background:#121a27;color:#e2e8f0;font-size:13px;letter-spacing:.02em;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    tr:nth-child(even){background:#0f1623}
    tr:nth-child(odd){background:#111827}
    .chk{width:18px;height:18px;cursor:pointer;accent-color:#94a3b8;filter:grayscale(1)}
    .chk.active{accent-color:#3b82f6;filter:none}
    tbody tr:hover{background:#0e1422}
    tbody tr.selected{background:#1e3a8acc}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid #243045;background:#0b1220;color:#cdd8e3;font-size:13px;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease}
    .tab.active{background:#0f2140;border-color:#4a6aa0;box-shadow:0 0 0 2px rgba(74,106,160,.45) inset,0 0 0 1px rgba(180,200,230,.25),0 4px 12px rgba(0,0,0,.35)}
    .tab.active span{filter:brightness(1.25);}
    .tab:hover{border-color:#33507a}
    .btn{padding:8px 16px;border-radius:10px}
    .btn-ios{background:var(--ios)} .btn-ios:hover{background:var(--ios-hover)}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.7);display:none;align-items:center;justify-content:center;z-index:80}
    .modal .box{background:#0b1220;border:1px solid #243045;border-radius:20px;max-width:560px;width:94%;padding:18px}
    .modal .msg{white-space:pre-line}
    /* Dark theme scrollbars */
    * { scrollbar-width: thin; scrollbar-color: #334155 #0b1220; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #0b1220; border-radius: 9999px; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 9999px; border: 2px solid #0b1220; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    /* Draggable column header visuals */
    th.colhdr{user-select:none}
    th.colhdr.dragging{opacity:.6; outline:1px dashed #4a6aa0}
  
    th.colhdr{position:relative; user-select:none; transition:background .18s ease, box-shadow .18s ease}
    th.colhdr.dragging{background:#1e3a8a; box-shadow:inset 0 0 0 3px #60a5fa, 0 0 0 2px rgba(96,165,250,.35)}
    th.colhdr.drop-target{background:#0b1731; box-shadow:inset 0 0 0 3px #93c5fd}
    
/* === STICKY HEADERS (all tabs) === */
.relative.overflow-auto thead th{position:sticky;top:0;z-index:20;background:#0f172a;}
.relative.overflow-auto thead tr{position:sticky;top:0;z-index:19;background:#0f172a;}

thead th.colhdr{ text-align:center; }

/* Centered dash for empty cells only */
.dash-center{display:block;text-align:center;}

</style>
        

<style>
/* === Canva-style Header Highlight (Dark) — CSS-only === */
:root{
  --hdr-bg:#0f172a;
  --hdr-glass:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 40%),
    linear-gradient(180deg, #0f172a 0%, #121a27 70%, #0f172a 100%);
  --hdr-line:#2b3a55;

  /* Section accent suggestions (used if matching IDs/classes exist) */
  --acc-pending:#fde047;   /* yellow-300  (Main Dispatch / Pending) */
  --acc-pickups:#60a5fa;   /* sky-400     (Pickups) */
  --acc-assigned:#cbd5e1;  /* slate-300   (Assigned) */
  --acc-completed:#34d399; /* emerald-400 (Completed) */
}

/* Base header glass + elevation */
.relative.overflow-auto table thead th{
  background: var(--hdr-glass);
  border-bottom: 1px solid var(--hdr-line);
  backdrop-filter: saturate(140%) blur(4px);
  letter-spacing:.02em;
  box-shadow:
    inset 0 -2px 0 0 var(--hdr-line),
    0 8px 18px rgba(0,0,0,.35);
}

/* Neon accent line under sticky header row */
.relative.overflow-auto thead tr::after{
  content:"";
  position: sticky;
  left:0; right:0; bottom:-1px; height:5px;
  display:block; z-index:21; pointer-events:none;
  background: linear-gradient(90deg, transparent 0%,
              var(--acc-current, var(--acc-pending)) 18%,
              var(--acc-current, var(--acc-pending)) 82%,
              transparent 100%);
  box-shadow:
    0 0 14px var(--acc-current, var(--acc-pending)),
    0 0 32px var(--acc-current, var(--acc-pending)),
    0 0 64px var(--acc-current, var(--acc-pending)),
    0 0 96px var(--acc-current, var(--acc-pending));
  filter: saturate(160%) brightness(1.35);
  opacity: 1;
}

/* If your sections have these IDs, each gets its own accent color automatically */
#section_pending   thead tr{ --acc-current: var(--acc-pending); }
#section_pickups   thead tr{ --acc-current: var(--acc-pickups); }
#section_assigned  thead tr{ --acc-current: var(--acc-assigned); }
#section_completed thead tr{ --acc-current: var(--acc-completed); }

/* Subtle column separators + hover glow */
thead th.colhdr + th.colhdr{ box-shadow: -1px 0 0 0 rgba(51,65,85,.35) inset; }
thead th.colhdr:hover{
  box-shadow:
    inset 0 -2px 0 0 var(--hdr-line),
    0 0 0 1px rgba(96,165,250,.25),
    0 6px 16px rgba(2,6,23,.6);
}
/* === End Canva-style Header Highlight === */

</style>
</head>
<body class="min-h-screen">
  <header class="brand-grad p-4 flex items-center justify-between">
    <h1 class="text-lg font-semibold">Coastal City Logistics — Dispatch Board</h1>
  </header>

  <main class="max-w-screen-2xl w-full mx-auto p-6 space-y-6">
    <div id="tabs_container" class="flex items-center gap-2">
      <!-- Original order: Pickups, Assigned, Completed, Pending (renamed visually) -->
      <button id="tab_pending" class="tab active" onclick="switchTab('pending')">Main Dispatch <span id="badge_pending" class="ml-2 px-2 py-0.5 rounded-full text-xs bg-yellow-900 text-yellow-200">0</span></button>
      <button id="tab_pickups" class="tab" onclick="switchTab('pickups')">Pickups <span id="badge_pickups" class="ml-2 px-2 py-0.5 rounded-full text-xs bg-blue-900 text-blue-200">0</span></button>
      <button id="tab_assigned" class="tab" onclick="switchTab('assigned')">Assigned <span id="badge_assigned" class="ml-2 px-2 py-0.5 rounded-full text-xs bg-slate-700 text-slate-200">0</span></button>
      <button id="tab_inprogress" class="tab" onclick="switchTab('inprogress')">In‑Progress <span id="badge_inprogress" class="ml-2 px-2 py-0.5 rounded-full text-xs bg-amber-900 text-amber-200">0</span></button>
      <button id="tab_completed" class="tab" onclick="switchTab('completed')">Completed <span id="badge_completed" class="ml-2 px-2 py-0.5 rounded-full text-xs bg-emerald-900 text-emerald-200">0</span></button>
      <div class="ml-auto text-xs opacity-80 pill">Coastal City Logistics</div>
    </div>

    <!-- PICKUPS -->
    <section id="section_pickups" class="space-y-4">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-sky-300 mb-3">Pickups</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:320px">
          <table>
            <thead><tr></tr></thead>
            <tbody id="p1_body"></tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn_assign" class="btn bg-blue-600 hover:bg-blue-700 disabled:opacity-40">Assign</button>
        <button id="btn_edit" class="btn" style="background:#065f46; border-color:#047857; color:#d1fae5;">Edit</button>
        <button id="btn_move" class="btn bg-slate-600 hover:bg-slate-500">Move</button>
      </div>
    </section>

    <!-- ASSIGNED -->
    <section id="section_assigned" class="space-y-4 hidden">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-sky-300 mb-3">Assigned</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:320px">
          <table>
            <thead><tr></tr></thead>
            <tbody id="assigned_body"></tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn_remove" class="btn bg-slate-700 hover:bg-slate-600 disabled:opacity-40">Remove</button>
        <button id="btn_update" class="btn btn-ios disabled:opacity-40">Update Driver</button>
      </div>
    </section>

    <!-- COMPLETED -->
    
    <!-- IN-PROGRESS -->
    <section id="section_inprogress" class="space-y-4 hidden">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-sky-300 mb-3">In‑Progress</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:320px">
          <table>
            <thead><tr></tr></thead>
            <tbody id="inprogress_body"></tbody>
          </table>
        </div>
      </div>
          <div class="flex items-center gap-3">
        <button id="btn_ip_move" class="btn bg-slate-700 hover:bg-slate-600 disabled:opacity-40">Move</button>
        
      </div>
    </section>

    <section id="section_completed" class="space-y-4 hidden">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-sky-300 mb-3">Completed</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:320px">
          <table>
            <thead><tr></tr></thead>
            <tbody id="completed_body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MAIN DISPATCH (Pending) -->
    <section id="section_pending" class="space-y-4 hidden">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-yellow-300 mb-3">Main Dispatch</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:320px">
          <table>
            <thead><tr></tr></thead>
            <tbody id="pending_body"></tbody>
          </table>
        </div>
      </div>
      <!-- Only Create New + Move -->
      <div class="flex items-center gap-3 mt-3">
        <button id="btn_create_pending" class="btn bg-blue-600 hover:bg-blue-700">Create New</button>
        <button id="btn_edit_pending" class="btn" style="background:#065f46; border-color:#047857; color:#d1fae5;">Edit</button>
        <button id="btn_move_from_pending" class="btn bg-slate-600 hover:bg-slate-500">Move</button>
      </div>
    </section>

    <!-- DRIVERS (BOTTOM) -->
    <section id="section_drivers_bottom" class="space-y-4">
      <div class="card p-5">
        <h2 class="text-xl font-bold text-sky-300 mb-3">Drivers</h2>
        <div class="relative overflow-auto rounded-xl" style="max-height:220px">
          <table>
            <thead>
              <tr>
                <th style="width:42px"></th>
                <th>Driver</th>
                <th>Assigned</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="drv_body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b1220;border:1px solid #243045;border-radius:12px;padding:10px 14px;color:#e5eefb;display:none;z-index:60"></div>

  <!-- Alert Modal -->
  <div id="alert_modal" class="modal">
    <div class="box">
      <h3 class="text-lg font-semibold mb-2 text-red-200">Driver Mismatch</h3>
      <p id="alert_text" class="text-sm opacity-90 mb-4 msg">You selected the wrong driver.</p>
      <div class="flex justify-end gap-2">
        <button class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600" onclick="closeAlert()">OK</button>
      </div>
    </div>
  </div>

  <!-- EDIT POPUP -->
  <div id="edit_modal" class="modal">
    <div class="box p-0 overflow-hidden" style="max-width:420px">
      <div class="brand-grad px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-slate-900/25 grid place-items-center font-semibold">CC</div>
          <div class="text-sm font-semibold">Coastal City Logistics</div>
        </div>
        <div class="text-xs opacity-80">LTE • 100%</div>
      </div>
      <div class="p-5 space-y-4">
        <div><h3 id="edit_title" class="text-2xl font-bold text-slate-100">Update Pick Up</h3></div>
        <div class="rounded-2xl border border-slate-700 bg-[#0e1523] p-4 space-y-4">
          <div class="flex items-center gap-2"><span id="f_jobpill" class="tab">Job #</span></div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><label class="block text-slate-400 text-xs mb-1">From → To</label><textarea id="f_from" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" rows="3" placeholder="BBT → Costco DC (Ontario)"></textarea></div>
            <div><label class="block text-slate-400 text-xs mb-1">Load In</label><input id="f_loadin" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" /></div>
            <div><label class="block text-slate-400 text-xs mb-1">Container #</label><input id="f_container" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" /></div>
            <div><label class="block text-slate-400 text-xs mb-1">Appt #</label><input id="f_appt" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" /></div>
            <div><label class="block text-slate-400 text-xs mb-1">BK #</label><input id="f_bk" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" /></div>
            <div><label class="block text-slate-400 text-xs mb-1">Window</label><input id="f_window" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" /></div>
          </div>
          <div><label class="block text-slate-400 text-xs mb-1">Instruction</label><textarea id="f_instruction" class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" rows="2" placeholder="Chassis back to Compton yard"></textarea></div>
        </div>
        <div class="flex items-center justify-between gap-3 pt-1">
          <button id="btn_modal_cancel" class="flex-1 px-4 py-2 rounded-xl border border-slate-600 bg-slate-800 hover:bg-slate-700">Cancel</button>
          <button id="btn_modal_update" class="flex-1 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- YES/NO CONFIRM -->
  <div id="confirm_modal" class="modal">
    <div class="box max-w-sm">
      <p id="confirm_text" class="mb-4"></p>
      <div class="flex justify-end gap-2">
        <button id="confirm_no" class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600">No</button>
        <button id="confirm_yes" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700">Yes</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- DATA ----------
    const pickups = [
      {id:'CCL-5001',from:'BBT',to:'Yusen Logistics, Torrance',container:'MSCU1029384',appt:'671800',bk:'BK77001',window:'07–08 AM',status:'Open'},
      {id:'CCL-5002',from:'SSA Pier A',to:'Maersk Depot, Carson',container:'CMAU6654321',appt:'671901',bk:'BK77002',window:'08–09 AM',status:'Open'},
      {id:'CCL-5003',from:'ITS (LB)',to:'Amazon LGB3',container:'TEMU5567123',appt:'672002',bk:'BK77003',window:'09–10 AM',status:'Open'},
      {id:'CCL-5004',from:'Pier C',to:'Target RDC (Fontana)',container:'TCLU2948210',appt:'672103',bk:'BK77004',window:'10–11 AM',status:'Open'},
      {id:'CCL-5005',from:'BBT',to:'Costco DC (Ontario)',container:'MSCU8812001',appt:'672204',bk:'BK77005',window:'11–12 PM',status:'Open'},
      {id:'CCL-5006',from:'Pier E',to:'Walmart RDC',container:'MAEU4433221',appt:'672305',bk:'BK77006',window:'12–01 PM',status:'Open'},
      {id:'CCL-5007',from:'LBCT',to:'Nike DC',container:'OOLU4422110',appt:'672406',bk:'BK77007',window:'01–02 PM',status:'Open'},
      {id:'CCL-5008',from:'TRAPAC',to:'Home Depot DC',container:'APZU7788991',appt:'672507',bk:'BK77008',window:'02–03 PM',status:'Open'},
      {id:'CCL-5009',from:'PCT',to:'UPS Hub',container:'SEGU9988776',appt:'672608',bk:'BK77009',window:'03–04 PM',status:'Open'},
      {id:'CCL-5010',from:'YTI',to:'FedEx Ground',container:'TRLU3344552',appt:'672709',bk:'BK77010',window:'04–05 PM',status:'Open'}
    ];

    const drivers = [
      {id:'DRV-1',name:'Prime Tech Solutions',status:'AVL'},
      {id:'DRV-2',name:'CCL CEO Jorge',status:'AVL'},
      {id:'DRV-3',name:'Jose',status:'AVL'},
      {id:'DRV-4',name:'Kevin',status:'AVL'}
    ];

    let assigned = [];
    let completed = [];
    let pending = [...pickups]; // All start on Main Dispatch
    pickups.length = 0;

    // ---------- STATE ----------
    const state = { selectedPickups:new Set(), selectedAssigned:new Set(), selectedPending:new Set(), selectedInprogress:new Set(), selectedDriver:null, editOriginalId:null, editScope:null, currentTab:'pickups', createMode:null };

    // ---------- COLUMN DEFINITIONS ----------
    const COLUMN_LABELS = {
      arrival: 'Date Arrived',
      container: 'Container #',
      chassis: 'Chassis',
      size: 'Size / Type',
      pin: 'PIN #',
      ie: 'Import / Export',
      bk: 'BK/EDO',
      from: 'Pick Port',
      pudate: 'P/U Date',
      appt: 'Appointment',
      deliveryDate: 'Delivery Date',
      to: 'Delivery',
      lfd: 'LFD Date',
      returnDate: 'Return Date',
      returnPort: 'Return Port',
      customer: 'Customer',
      remark: 'Remark',
      carrier: 'Carrier Name',	
      mbl: 'MB/L No.',
      status: 'Drop / Live'
    };
    const DEFAULT_ORDER = ['arrival','container','chassis','size','pin','ie','bk','from','pudate','appt','deliveryDate','to','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status'];
    function getOrder(){
      try{ const s=localStorage.getItem('ccl_col_order'); if(s){ const arr=JSON.parse(s); if(Array.isArray(arr)&&arr.length){ return arr.filter(k=>COLUMN_LABELS[k]); }} }catch(e){}
      return [...DEFAULT_ORDER];
    }
    function setOrder(arr){ try{ localStorage.setItem('ccl_col_order', JSON.stringify(arr)); }catch(e){} }
    let COL_ORDER = getOrder();

    function statusPill(s){// Show a centered dash when empty or 'pending'; otherwise plain text
  const v = (s == null) ? '' : String(s);
  if(!v.trim() || v.trim().toLowerCase()==='pending'){
    return '<span class="dash-center">—</span>';
  }
  return v;}
    function toast(msg){ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},1600); }
    function updateBadges(){
      document.getElementById('badge_pickups').textContent = pickups.length;
      document.getElementById('badge_assigned').textContent = assigned.length;
      document.getElementById('badge_completed').textContent = completed.length;
      document.getElementById('badge_pending').textContent = pending.length;
    
      var _ip=document.getElementById('badge_inprogress'); if(_ip){ try{ _ip.textContent=(typeof inprogress!=='undefined'&&inprogress&&inprogress.length)||0; }catch(e){ _ip.textContent=0; } }}
    function syncActionButtons(){
      const btnAssign=document.getElementById('btn_assign');
      const btnRemove=document.getElementById('btn_remove');
      const btnUpdate=document.getElementById('btn_update');
      const btnIpMove=document.getElementById('btn_ip_move');
      
      if(btnAssign) btnAssign.disabled=!(state.selectedPickups.size>0 && state.selectedDriver);
      if(btnRemove) btnRemove.disabled=!(state.selectedAssigned.size>0);
      if(btnUpdate) btnUpdate.disabled=!(state.selectedAssigned.size>0 && state.selectedDriver);
      if(btnIpMove) btnIpMove.disabled=!(state.selectedInprogress.size>0);
      
    }

    // ---------- Column builders & DnD ----------
    function buildHeader(theadEl, withCheckbox, includeDriver){
      const tr=document.createElement('tr'); theadEl.innerHTML=''; theadEl.appendChild(tr);
      if(withCheckbox){ const th=document.createElement('th'); th.style.width='42px'; tr.appendChild(th);
        /* MASTER CB */ const master=document.createElement('input'); master.type='checkbox'; master.className='h-4 w-4 align-middle';
        th.appendChild(master);
        master.addEventListener('change', function(){
          const table = theadEl.closest('table'); if(!table) return;
          const tb = (table.tBodies && table.tBodies[0]) ? table.tBodies[0] : null; if(!tb) return;
          const boxes = tb.querySelectorAll('input[type="checkbox"]');
          boxes.forEach(cb => { cb.checked = master.checked; cb.dispatchEvent(new Event('change', {bubbles:true})); });
        });
      }
      if(includeDriver){ const th=document.createElement('th'); th.textContent='Driver'; tr.appendChild(th); }
      COL_ORDER.forEach(function(key){
        const th=document.createElement('th'); th.textContent = COLUMN_LABELS[key] || key; th.dataset.key=key; th.className='colhdr'; tr.appendChild(th);
      });
      enableHeaderDnD(theadEl, includeDriver ? 1 : 0, withCheckbox ? 1 : 0);
    }
    function cellFor(a, key, statusOverride){
if(key==='status') return statusPill(statusOverride || a.status);
  const norm = (val) => {
    const s = (val==null) ? '' : String(val);
    return (!s.trim() || s==='—') ? '<span class="dash-center">—</span>' : s;
  };
  if(key==='customer') return norm(a.customer || (a.to));
  if(key==='to') return norm(a.to);
  if(key==='from') return norm(a.from);
  if(key==='appt') return norm(a.appt);
  if(key==='deliveryDate') return norm(a.deliveryDate);
  if(key==='lfd') return norm(a.lfd);
  if(key==='arrival') return norm(a.arrival);
  if(key==='container') return norm(a.container);
  if(key==='pudate') return norm(a.pudate);
  if(key==='bk') return norm(a.bk);
  if(key==='pin') return norm(a.pin);
  if(key==='size') return norm(a.size);
  if(key==='ie') return norm(a.ie);
  if(key==='chassis') return norm(a.chassis);
  if(key==='returnDate') return norm(a.returnDate);
  if(key==='returnPort') return norm(a.returnPort);
  if(key==='remark') return norm(a.remark);
  if(key==='carrier') return norm(a.carrier);
  if(key==='mbl') return norm(a.mbl);
  return norm(a[key]);
}
    function buildRowCells(tr, a, statusOverride){
      COL_ORDER.forEach(function(key){
        const td=document.createElement('td'); td.innerHTML = cellFor(a, key, statusOverride); tr.appendChild(td);
      });
    }
    
function enableHeaderDnD(theadEl, driverOffset, checkboxOffset){
  const table = theadEl.closest('table');
  if(!table || !theadEl || !theadEl.rows || !theadEl.rows.length) return;
  const tr = theadEl.rows[0];

  // Helper: key for a header cell (supports data-key, Driver, and the blank checkbox)
  function headerKey(th, idx){
    if(th.dataset && th.dataset.key) return th.dataset.key;
    const txt = (th.textContent||'').trim();
    if(txt==='Driver') return 'DRIVER';
    if(txt==='' && idx===0) return 'CHECK';
    return txt || ('COL_'+idx);
  }
  // Helper: move a column across header + all body rows
  function moveColumn(from, to){
    if(from===to || from<0 || to<0) return;
    const moveInRow = (row, f, t) => {
      const cell = row.children[f];
      if(!cell) return;
      if(t >= row.children.length) row.appendChild(cell);
      else row.insertBefore(cell, row.children[t]);
    };
    moveInRow(tr, from, to);
    Array.from(table.tBodies).forEach(tb => Array.from(tb.rows).forEach(r => moveInRow(r, from, to)));
  }
  // Apply saved order (global across tabs), if present
  try{
    const saved = JSON.parse(localStorage.getItem('ccl_col_order_all')||'[]');
    if(Array.isArray(saved) && saved.length){
      // Build current keys
      const ths = Array.from(tr.children);
      const keys = ths.map((th, i)=>headerKey(th, i));
      // Reorder to match saved sequence for keys we have
      const desired = [];
      const used = new Set();
      saved.forEach(k=>{
        const idx = keys.indexOf(k);
        if(idx>-1 && !used.has(idx)){ desired.push(idx); used.add(idx); }
      });
      // Append any missing columns in their current order
      keys.forEach((k, idx)=>{ if(!used.has(idx)) desired.push(idx); });
      // Execute moves to reach desired order
      let mapping = desired.slice();
      for(let to=0; to<mapping.length; to++){
        let from = mapping.indexOf(to);
        if(from===-1 || from===to) continue;
        moveColumn(from, to);
        const val = mapping[from];
        mapping.splice(from,1);
        mapping.splice(to,0,val);
      }
    }
  }catch(_){}

  // Enable drag on EVERY header (including Driver + checkbox)
  Array.from(tr.children).forEach((th, i) => {
    th.classList.add('colhdr');
    th.onmousedown = (e) => {
      e.preventDefault();
      const dragTh = th;
      dragTh.classList.add('dragging');

      const onMove = (ev) => {
        const headers = Array.from(tr.children);
        // Find insertion point by midpoint comparison
        let target = null;
        for(const cand of headers){
          if(cand===dragTh) continue;
          const rect = cand.getBoundingClientRect();
          const mid = rect.left + rect.width/2;
          if(ev.clientX < mid){ target = cand; break; }
        }
        headers.forEach(h => h.classList.remove('drop-target'));
        if(target) target.classList.add('drop-target');

        const fromIndex = headers.indexOf(dragTh);
        const toIndex = target ? headers.indexOf(target) : headers.length;
        if(fromIndex!==toIndex){
          moveColumn(fromIndex, toIndex);
        }
      };

      const onUp = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        dragTh.classList.remove('dragging');
        tr.querySelectorAll('.drop-target').forEach(x=>x.classList.remove('drop-target'));
        // Save new global order: include special DRIVER/CHECK tokens and data keys
        const newKeys = Array.from(tr.children).map((el, idx)=>headerKey(el, idx));
        try{ localStorage.setItem('ccl_col_order_all', JSON.stringify(newKeys)); }catch(_){}
      };

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    };
  });
}

    // ---------- RENDERERS ----------
    function renderPickups(){
      const table=document.querySelector('#section_pickups table');
      const body=document.getElementById('p1_body'); body.innerHTML='';
      buildHeader(table.tHead, true, true);
      pickups.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked=state.selectedPickups.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          if(cb.checked){ state.selectedPickups.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedPickups.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        // Driver cell (Pickups has no assigned driver yet)
        (function(){ 
          var drec = drivers.find(function(d){ return d.id===a.driverId; });
          var dname = drec ? drec.name : '—';
          const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname || '—'); 
          tr.appendChild(tdDriver);
        })();
        buildRowCells(tr, a, 'Open');
        tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges(); syncActionButtons();
    }

    function renderDrivers(){
      const body=document.getElementById('drv_body'); body.innerHTML='';
      const source = (state.currentTab==='completed') ? completed : assigned;
      const counts=source.reduce(function(m,a){ m[a.driverId]=(m[a.driverId]||0)+1; return m; },{});
      drivers.forEach(function(d){
        const tr=document.createElement('tr');
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedDriver===d.id;
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          state.selectedDriver = cb.checked ? d.id : null;
          var boxes=document.querySelectorAll('#drv_body input[type="checkbox"]');
          boxes.forEach(function(x){ if(x!==cb){ x.checked=false; x.classList.remove('active'); var row = x.closest ? x.closest('tr') : null; if(row){ row.classList.remove('selected'); } }});
          if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); } else { tr.classList.remove('selected'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        const load=counts[d.id]||0;
        tr.insertAdjacentHTML('beforeend','<td>'+d.name+'</td><td><span class="ml-1 px-2 py-0.5 rounded-full text-xs bg-blue-900 text-blue-200">'+load+'</span></td><td>'+d.status+'</td>');
        tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
    }

    function renderAssigned(){
      const table=document.querySelector('#section_assigned table');
      const body=document.getElementById('assigned_body'); body.innerHTML='';
      buildHeader(table.tHead, true, true);
      assigned.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked=state.selectedAssigned.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          if(cb.checked){ state.selectedAssigned.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedAssigned.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Assigned');
        tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges(); syncActionButtons();
    }

    function renderCompleted(){
      const table=document.querySelector('#section_completed table');
      const body=document.getElementById('completed_body'); if(!body) return; body.innerHTML='';
      buildHeader(table.tHead, true, true);
      completed.forEach(function(a){
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        // Checkbox (display-only; no selection logic needed here)
        const td0_c=document.createElement('td');
        const cb_c=document.createElement('input'); cb_c.type='checkbox'; cb_c.className='chk';
        td0_c.appendChild(cb_c); tr.appendChild(td0_c);
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Completed');
        body.appendChild(tr);
      });
      updateBadges();
    }


    function renderInprogress(){
      const table=document.querySelector('#section_inprogress table');
      if(!table) return;
      const body=document.getElementById('inprogress_body'); if(!body) return;
      body.innerHTML='';
      if(typeof inprogress==='undefined' || !Array.isArray(inprogress)){ window.inprogress = []; }
      buildHeader(table.tHead, true, true);
      inprogress.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        // Checkbox with selection state
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedInprogress.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change', function(){
          if(cb.checked){ state.selectedInprogress.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedInprogress.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        // Driver cell
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        // Cells
        buildRowCells(tr, a, 'In-Progress');
        // /* ACK badge */ inject into first data cell after Driver
        try {
          const cells = tr.querySelectorAll('td');
          // cells[0] = checkbox, cells[1] = driver, cells[2] = first data cell (ID)
          if (cells && cells.length > 2) {
            const idCell = cells[2];
            const badge = document.createElement('span');
            badge.textContent = 'ACK';
            badge.style.marginLeft = '6px';
            badge.style.fontSize = '10px';
            badge.style.padding = '2px 6px';
            badge.style.borderRadius = '10px';
            badge.style.border = '1px solid #16a34a';
            badge.style.color = '#16a34a';
            badge.style.opacity = (a.acknowledged ? '1' : '0.25');
            idCell.appendChild(badge);
          }
        } catch(_) {}
        tr.addEventListener('click', function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges();
    }


    function renderPending(){
      const table=document.querySelector('#section_pending table');
      const body=document.getElementById('pending_body'); if(!body) return; body.innerHTML='';
      buildHeader(table.tHead, true, true); // include driver col in Main Dispatch
      pending.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedPending.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change', function(){
          if(cb.checked){ state.selectedPending.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedPending.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
        });
        td0.appendChild(cb); tr.appendChild(td0);
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Pending');
        tr.addEventListener('click', function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
    }

    // ---------- ALERT MODAL ----------
    function openAlert(msg){ const m=document.getElementById('alert_modal'); const t=document.getElementById('alert_text'); if(t) t.textContent=msg; if(m) m.style.display='flex'; }
    function closeAlert(){ const m=document.getElementById('alert_modal'); if(m) m.style.display='none'; }

    
    
    // ---------- INLINE EDIT (DBLCLICK) ----------
    // Edit in place, and lock the column key on the TD to prevent any misalignment.
    document.addEventListener('dblclick', function(e){
      const td = e.target.closest('td'); if(!td) return;
      const table = td.closest('table'); if(!table || !table.tHead || !table.tHead.rows.length) return;
      const tr = td.parentElement;
      const section = td.closest('section'); if(!section) return;

      // Header + column key
      const theadTr = table.tHead.rows[0];
      const cellIndex = Array.from(tr.children).indexOf(td);
      const th = theadTr.children[cellIndex];
      const headerText = th ? (th.textContent||'').trim() : '';
      const keyAttr = th && th.dataset ? th.dataset.key : null;
      const colKey = (td.dataset.colKey) || keyAttr || (headerText ? headerText.toLowerCase().replace(/[^a-z0-9]+/g,'_') : '');
      td.dataset.colKey = colKey;

      // Skip ONLY the checkbox column
      if(headerText==='' && cellIndex===0) return;

      // Resolve dataset by section
      let arr=null, sectionStatus=null, sid=section.id;
      if(sid==='section_pickups'){ arr=pickups; sectionStatus='Open'; }
      else if(sid==='section_assigned'){ arr=assigned; sectionStatus='Assigned'; }
      else if(sid==='section_completed'){ arr=completed; sectionStatus='Completed'; }
      else if(sid==='section_pending'){ arr=pending; sectionStatus='Pending'; }
      else { return; }

      // Locate record
      const rowId = tr.dataset ? tr.dataset.id : null;
      let rec = null;
      if(rowId){ rec = (arr||[]).find(x => x.id===rowId) || null; }
      if(!rec){
        const idx = Array.from(tr.parentElement.children).indexOf(tr);
        rec = (arr && arr[idx]) ? arr[idx] : null;
      }
      if(!rec) return;

      // Create inline input
      const oldHTML = td.innerHTML;
      const oldText = td.textContent.trim();
      const input = document.createElement('input');
      input.type='text';
      input.value = oldText;
      input.style.width='100%';
      input.style.background='#0f172a';
      input.style.border='1px solid #243045';
      input.style.borderRadius='8px';
      input.style.padding='6px 8px';
      input.style.color='#e2e8f0';
      td.innerHTML='';
      td.appendChild(input);
      input.focus();
      input.select();

      let pendingValue = oldText;
      input.addEventListener('input', () => { pendingValue = input.value; });

      function renderCellInPlace(){
        if(colKey==='status'){
          if(typeof statusPill==='function'){
            td.innerHTML = statusPill(rec.status) || (rec.status || '—');
          } else {
            td.textContent = rec.status || '—';
          }
          return;
        }
        if(colKey==='driver'){
          const drec = drivers.find(x=>x.id===rec.driverId);
          const dname = drec ? drec.name : '—';
          td.textContent = (rec.driverName || dname);
          return;
        }
        if(typeof cellFor==='function'){
          td.innerHTML = cellFor(rec, colKey, sectionStatus);
        } else {
          td.textContent = rec[colKey] ?? '';
        }
      }

      function applyChange(){
        const newVal = (pendingValue||'').trim();
        if(colKey==='status'){
          rec.status = newVal;
        } else if(colKey==='driver'){
          const d = drivers.find(drv => (drv.name||'').toLowerCase() === newVal.toLowerCase());
          if(d){ rec.driverId = d.id; delete rec.driverName; }
          else { rec.driverName = newVal; }
        } else {
          rec[colKey] = newVal;
        }
        renderCellInPlace();
        // subtle confirm flash
        td.classList.add('ring-2','ring-blue-500/60');
        setTimeout(()=>td.classList.remove('ring-2','ring-blue-500/60'), 500);
      }

      input.addEventListener('blur', function(){
        if(pendingValue===oldText){ td.innerHTML = oldHTML; return; }
        openConfirm('Save change to '+(COLUMN_LABELS[colKey]||headerText||'field')+'?\n\nOld: '+oldText+'\nNew: '+pendingValue, applyChange);
      });
      input.addEventListener('keydown', function(ev){
        if(ev.key==='Enter'){ input.blur(); }
        if(ev.key==='Escape'){ pendingValue=oldText; input.blur(); }
      });
    });
    // ---------- EDIT MODAL ----------
    
    const editModal = document.getElementById('edit_modal');
    const fFrom = document.getElementById('f_from');
    const fLoadIn = document.getElementById('f_loadin');
    const fContainer = document.getElementById('f_container');
    const fAppt = document.getElementById('f_appt');
    const fBk = document.getElementById('f_bk');
    const fWindow = document.getElementById('f_window');
    const fInstruction = document.getElementById('f_instruction');

    function openEdit(){
      if(state.selectedPickups.size!==1){ toast('Select exactly 1 pickup to edit'); return; }
      const id=[...state.selectedPickups][0];
      state.editOriginalId = id;
      const rec = pickups.find(p=>p.id===id);
      if(!rec){ toast('Pickup not found'); return; }
      document.getElementById('f_jobpill').textContent = `${rec.id} • ${rec.window}`;
      fFrom.value = `${rec.from} → ${rec.to||''}`;
      fLoadIn.value = (rec.to||'').split(',')[0] || '';
      fContainer.value = rec.container || '';
      fAppt.value = rec.appt || '';
      fBk.value = rec.bk || '';
      fWindow.value = rec.window || '';
      fInstruction.value = '';
      editModal.style.display='flex';
    }
    function closeEdit(){ editModal.style.display='none'; }

    document.getElementById('btn_edit').addEventListener('click', openEdit);
    document.getElementById('btn_modal_cancel').addEventListener('click', function(){
      openConfirm('Cancel changes?', function(){ state.createMode=null; closeEdit(); });
    });
    document.getElementById('btn_modal_update').addEventListener('click', function(){
      if(state.createMode==='pending'){
        openConfirm('Create this Main Dispatch pickup?', function(){
          const parts = fFrom.value.split('→');
          const from = (parts[0]||'').trim();
          const to = (parts[1]||'').trim();
          const newId = 'NEW-' + Date.now();
          const item = { id:newId, from:from||'—', to:to||'', container:fContainer.value.trim(), appt:fAppt.value.trim(), bk:fBk.value.trim(), window:fWindow.value.trim(), status:'Pending' };
          pending.push(item);
          state.createMode=null;
          closeEdit();
          renderPending(); updateBadges(); toast('Created in Main Dispatch');
        });
      } else if(state.editScope==='pending'){
        openConfirm('Update this Main Dispatch row?', function(){
          const id = state.editOriginalId;
          const rec = pending.find(p=>p.id===id);
          if(rec){
            const parts = fFrom.value.split('→');
            rec.from = (parts[0]||rec.from||'').trim();
            rec.to = (parts[1]||rec.to||'').trim();
            rec.container = fContainer.value.trim();
            rec.appt = fAppt.value.trim();
            rec.bk = fBk.value.trim();
            rec.window = fWindow.value.trim();
            rec.remark = fInstruction.value.trim();
          }
          state.editScope=null;
          closeEdit();
          renderPending();
          toast('Main Dispatch updated');
        });
      } else {
        openConfirm('Update this assignment?', function(){
          const id = state.editOriginalId;
          const rec = pickups.find(p=>p.id===id);
          if(rec){
            const parts = fFrom.value.split('→');
            rec.from = (parts[0]||rec.from).trim();
            rec.to = (parts[1]||rec.to||'').trim();
            rec.container = fContainer.value.trim();
            rec.appt = fAppt.value.trim();
            rec.bk = fBk.value.trim();
            rec.window = fWindow.value.trim();
          }
          closeEdit();
          renderPickups();
          toast('Pickup updated');
        });
      }
    });

    
    // Edit (Main Dispatch) - edit exactly one selected pending row
    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='btn_edit_pending'){
        if(state.selectedPending.size!==1){ toast('Select exactly 1 row in Main Dispatch to edit'); return; }
        const id=[...state.selectedPending][0];
        state.editOriginalId = id;
        state.editScope = 'pending';
        const rec = pending.find(p=>p.id===id);
        if(!rec){ toast('Row not found'); return; }
        document.getElementById('edit_title').textContent = 'Edit Main Dispatch';
        document.getElementById('f_jobpill').textContent = `${rec.id} • ${rec.window||''}`;
        fFrom.value = `${rec.from||''} → ${rec.to||''}`;
        fLoadIn.value = (rec.to||'').split(',')[0] || '';
        fContainer.value = rec.container || '';
        fAppt.value = rec.appt || '';
        fBk.value = rec.bk || '';
        fWindow.value = rec.window || '';
        fInstruction.value = rec.remark || '';
        editModal.style.display='flex';
      }
    });


    // ---------- CONFIRM ----------
    function openConfirm(msg, onYes){
      const m=document.getElementById('confirm_modal');
      const t=document.getElementById('confirm_text');
      const yes=document.getElementById('confirm_yes');
      const no=document.getElementById('confirm_no');
      t.textContent=msg;
      function cleanup(){ yes.replaceWith(yes.cloneNode(true)); no.replaceWith(no.cloneNode(true)); }
      m.style.display='flex';
      m.querySelector('#confirm_yes').addEventListener('click', function(){ m.style.display='none'; cleanup(); if(onYes) onYes(); });
      m.querySelector('#confirm_no').addEventListener('click', function(){ m.style.display='none'; cleanup(); });
    }

    // ---------- ACTIONS ----------
    document.addEventListener('click', function(e){
      // Assign (Pickups -> Assigned)
      if(e.target && e.target.id==='btn_assign'){
        const driver=drivers.find(function(d){ return d.id===state.selectedDriver; });
        if(!driver || state.selectedPickups.size===0) return;
        const ids=[...state.selectedPickups];
        ids.forEach(function(id){
          const idx=pickups.findIndex(function(p){ return p.id===id; });
          if(idx>-1){
            const item=pickups.splice(idx,1)[0];
            assigned.push(Object.assign({}, item, {driverId: driver.id, status:'Assigned'}));
          }
        });
        state.selectedPickups.clear();
        state.selectedDriver=null;
        renderPickups(); renderAssigned(); renderDrivers();
        updateBadges(); syncActionButtons();
        switchTab('assigned');
        toast('Assigned to driver');
      }

      // Remove (Assigned -> Pickups)
      if(e.target && e.target.id==='btn_remove'){
        if(state.selectedAssigned.size===0) return;
        const ids=[...state.selectedAssigned];
        ids.forEach(function(id){
          const idx=assigned.findIndex(function(a){ return a.id===id; });
          if(idx>-1){
            const item=assigned.splice(idx,1)[0];
            const rest={ id:item.id, from:item.from, to:item.to, container:item.container, appt:item.appt, bk:item.bk, window:item.window, status:'Open' };
            pickups.push(rest);
          }
        });
        state.selectedAssigned.clear();
        renderPickups(); renderAssigned(); renderDrivers();
        updateBadges(); syncActionButtons();
        toast('Returned to Pickups');
      }

      // Update Driver (Assigned -> Completed), safeguard mismatch
      if(e.target && e.target.id==='btn_update'){
        const driver=drivers.find(function(d){ return d.id===state.selectedDriver; });
        if(!driver || state.selectedAssigned.size===0) return;
        const ids=[...state.selectedAssigned];
        const mismatches=[];
        ids.forEach(function(id){
          const row=assigned.find(function(x){ return x.id===id; });
          if(row && row.driverId!==driver.id){
            var _dcur = drivers.find(function(d){ return d.id===row.driverId; });
            var currentName = _dcur ? _dcur.name : 'Unknown';
            mismatches.push(row.id+' is assigned to '+currentName);
          }
        });
        if(mismatches.length>0){
          openAlert('You selected '+driver.name+', but:\\n\\n• '+mismatches.join('\\n• ')+'\\n\\nSelect the driver that matches the Assigned rows to proceed.');
          return;
        }
        let moved=0;
        const movedRows=[];
        ids.forEach(function(id){
          const idx=assigned.findIndex(function(x){ return x.id===id; });
          if(idx>-1){
            const row=assigned.splice(idx,1)[0];
            row.status='In-Progress';
            if(typeof inprogress==='undefined' || !Array.isArray(inprogress)){ window.inprogress = []; }
            inprogress.push(row);
            moved++;
            movedRows.push({ id: row.id, from: row.from, to: row.to, container: row.container, appt: row.appt, bk: row.bk, window: row.window, driverId: driver.id, driverName: driver.name });
          }
        });
        try {
          if (window.parent && window.parent !== window && movedRows.length) {
            window.parent.postMessage({ type: 'dispatch_assigned', driverId: driver.id, driverName: driver.name, jobs: movedRows }, '*');
            if(window.__publishAssignmentToChannel){ window.__publishAssignmentToChannel({ driverId: driver.id, driverName: driver.name, jobs: movedRows }); }
          }
        } catch(_){}
        state.selectedAssigned.clear();
        state.selectedDriver=null;
        renderAssigned(); renderInprogress(); renderDrivers();
        updateBadges(); syncActionButtons();
        switchTab('inprogress');
        toast('Notified '+driver.name+': '+moved+' pickup(s) moved to In‑Progress');
      }

      
      // In-Progress -> Pickups (dispatcher removes from phone app list)
      if(e.target && e.target.id==='btn_ip_move'){
        if(state.selectedInprogress.size===0){ toast('Select at least 1 In‑Progress row'); return; }
        openConfirm('Move selected pickup(s) back to Pickups?', function(){
          const ids=[...state.selectedInprogress];
          ids.forEach(function(id){
            const idx=(inprogress||[]).findIndex(function(x){ return x.id===id; });
            if(idx>-1){
              const row=inprogress.splice(idx,1)[0];
              const rest={ id:row.id, from:row.from, to:row.to, container:row.container, appt:row.appt, bk:row.bk, window:row.window, status:'Open' };
              pickups.push(rest);
            }
          });
          state.selectedInprogress.clear();
          renderPickups(); renderInprogress(); updateBadges(); syncActionButtons();
          switchTab('pickups');
          toast('Moved back to Pickups');
        });
      }


      // Move (Pickups -> Pending) WITH CONFIRM
      if(e.target && e.target.id==='btn_move'){
        if(state.selectedPickups.size===0){ toast('Select at least 1 pickup to move'); return; }
        openConfirm('Move selected pickup(s) to Main Dispatch?', function(){
          const ids=[...state.selectedPickups];
          ids.forEach(function(id){
            const idx=pickups.findIndex(function(p){ return p.id===id; });
            if(idx>-1){
              const item=pickups.splice(idx,1)[0];
              pending.push(Object.assign({}, item, { status:'Pending' }));
            }
          });
          state.selectedPickups.clear();
          renderPickups(); renderPending();
          updateBadges(); syncActionButtons();
          switchTab('pending');
          toast('Moved to Main Dispatch');
        });
      }
    });

    // Pending -> Pickups (with confirm)
    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='btn_move_from_pending'){
        if(state.selectedPending.size===0){ toast('Select at least 1 pending pickup'); return; }
        openConfirm('Move selected pickup(s) to Pickups?', function(){
          const ids=[...state.selectedPending];
          ids.forEach(function(id){
            const idx=pending.findIndex(function(p){ return p.id===id; });
            if(idx>-1){
              const item=pending.splice(idx,1)[0];
              pickups.push(Object.assign({}, item, { status:'Open' }));
            }
          });
          state.selectedPending.clear();
          renderPickups(); renderPending();
          updateBadges();
          switchTab('pending');
          toast('Moved to Pickups');
        });
      }
    });

    // Create New under Main Dispatch
    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='btn_create_pending'){
        state.createMode = 'pending';
        state.editOriginalId = null;
        document.getElementById('edit_title').textContent = 'Create Pickup';
        document.getElementById('f_jobpill').textContent = 'New Job';
        fFrom.value = ''; fLoadIn.value=''; fContainer.value=''; fAppt.value=''; fBk.value=''; fWindow.value=''; fInstruction.value='';
        editModal.style.display='flex';
      }
    });

    // ---------- Driver App Hook ----------
    // Receive driver acknowledgments from the bridge
    window.receiveDriverAck = function(ids){
      try{
        if(typeof ids==='string'){ ids=[ids]; }
        if(!Array.isArray(ids) || !ids.length) return false;
        let updated=0;
        (inprogress||[]).forEach(function(r){
          if(ids.indexOf(r.id) !== -1){ r.acknowledged = true; updated++; }
        });
        if(updated){ renderInprogress(); updateBadges(); }
        return updated>0;
      }catch(_){ return false; }
    };

    // Call window.driverComplete(['CCL-5001','CCL-5002']) from the phone app to auto-complete.
    window.driverComplete = function(ids){
      try{
        if(typeof ids==='string'){ ids=[ids]; }
        if(!Array.isArray(ids) || ids.length===0) return false;
        let moved=0;
        ids.forEach(function(id){
          const idx=(inprogress||[]).findIndex(function(x){ return x.id===id; });
          if(idx>-1){
            const row=inprogress.splice(idx,1)[0];
            row.status='Completed';
            completed.push(row);
            moved++;
          }
        });
        if(moved>0){
          renderInprogress(); renderCompleted(); updateBadges();
          return true;
        }
        return false;
      }catch(_){ return false; }
    };

    // ---------- TABS ----------
    function switchTab(which){
      document.getElementById('section_pickups').classList.toggle('hidden',which!=='pickups');
      document.getElementById('section_assigned').classList.toggle('hidden',which!=='assigned');
      var _sip=document.getElementById('section_inprogress'); if(_sip) _sip.classList.toggle('hidden',which!=='inprogress');
      document.getElementById('section_completed').classList.toggle('hidden',which!=='completed');
      document.getElementById('section_pending').classList.toggle('hidden',which!=='pending');
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      if(which==='pickups') document.getElementById('tab_pickups').classList.add('active');
      if(which==='assigned') document.getElementById('tab_assigned').classList.add('active');
      if(which==='inprogress') document.getElementById('tab_inprogress')?.classList.add('active');
      if(which==='completed') document.getElementById('tab_completed').classList.add('active');
      if(which==='pending') document.getElementById('tab_pending').classList.add('active');
      state.currentTab = which;
      if(which==='inprogress'){ try{ renderInprogress(); }catch(e){} }
      // Hide Drivers panel on Main Dispatch
      var drvSec=document.getElementById('section_drivers_bottom'); if(drvSec){ drvSec.classList.toggle('hidden', which==='pending'); }
      renderDrivers();
    }

    // ---------- INIT ----------
    function init(){
      renderPickups(); renderDrivers(); renderAssigned(); renderCompleted(); renderPending(); renderInprogress();
      updateBadges(); syncActionButtons();
      switchTab('pending'); // start on Main Dispatch per your request
    }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  // HEADER RENAME (dblclick)

// HEADER RENAME (dblclick): confirm and update label text only (no key/logic changes)
document.addEventListener('dblclick', function(e){
  const th = e.target.closest('th.colhdr'); if(!th) return;
  const key = th.dataset && th.dataset.key; if(!key) return;
  const oldName = (th.textContent||'').trim();
  const typed = prompt('Rename header:', oldName);
  if(typed==null) return;
  const next = (typed||'').trim();
  if(!next || next===oldName) return;
  if(typeof openConfirm==='function'){
    openConfirm('Change "'+oldName+'" to "'+next+'"?', function(){ COLUMN_LABELS[key]=next; th.textContent=next; });
  } else { COLUMN_LABELS[key]=next; th.textContent=next; }
});
</script>

<!-- CCL Channel: Dispatch side -->
<script>
(function(){
  const ccl = new BroadcastChannel('ccl_dispatch_driver');
  ccl.onmessage = (ev) => {
    const data = ev.data || {};
    try{
      if(data.type === 'driver_completed' && Array.isArray(data.ids)) {
        if(typeof window.driverComplete === 'function') window.driverComplete(data.ids);
      }
      if(data.type === 'driver_ack' && Array.isArray(data.ids)) {
        if(typeof window.receiveDriverAck === 'function') window.receiveDriverAck(data.ids);
      }
    }catch(e){ console.warn('Channel error (dispatch onmessage):', e); }
  };
  window.__publishAssignmentToChannel = function(payload){
    try { ccl.postMessage({ type: 'new_assignment', ...payload }); } catch(e){}
  };
})();
</script>
</body>
</html>
