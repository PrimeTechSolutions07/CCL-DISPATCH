<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Coastal City Logistics — Dispatch Board</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    :root{--bg:#0a0f1a;--panel:#111827;--ink:#f8fafc;--muted:#9fb2c8;--line:#1f2937;--brand:#2563eb;--brand-2:#0f766e;--ios:#0A84FF;--ios-hover:#007AFF}
    body{background:var(--bg);color:var(--ink)}
    .brand-grad{background:linear-gradient(120deg,#1e3a8a 0%, var(--brand-2) 100%)}
    .card{border:1px solid #1e293b;border-radius:16px;background:var(--panel);box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .pill{border:1px solid #1f2a44;background:#0f172a;border-radius:9999px;padding:6px 10px;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:left;white-space:nowrap}
    th{background:#121a27;color:#e2e8f0;font-size:13px;letter-spacing:.02em;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    tr:nth-child(even){background:#0f1623}
    tr:nth-child(odd){background:#111827}
    .chk{width:18px;height:18px;cursor:pointer;accent-color:#94a3b8;filter:grayscale(1)}
    .chk.active{accent-color:#3b82f6;filter:none}
    tbody tr:hover{background:#0e1422}
    tbody tr.selected{background:#1e3a8acc}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid #243045;background:#0b1220;color:#cdd8e3;font-size:13px;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease}
    .tab.active{background:#0f2140;border-color:#4a6aa0;box-shadow:0 0 0 2px rgba(74,106,160,.45) inset,0 0 0 1px rgba(180,200,230,.25),0 4px 12px rgba(0,0,0,.35)}
    .tab.active span{filter:brightness(1.25);}
    .tab:hover{border-color:#33507a}
    .btn{padding:8px 16px;border-radius:10px}
    .btn-ios{background:var(--ios)} .btn-ios:hover{background:var(--ios-hover)}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.7);display:none;align-items:center;justify-content:center;z-index:80}
    .modal .box{background:#0b1220;border:1px solid #243045;border-radius:20px;max-width:560px;width:94%;padding:18px}
    .modal .msg{white-space:pre-line}
    /* Dark theme scrollbars */
    * { scrollbar-width: thin; scrollbar-color: #334155 #0b1220; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #0b1220; border-radius: 9999px; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 9999px; border: 2px solid #0b1220; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    /* Draggable column header visuals */
    th.colhdr{user-select:none}
    th.colhdr.dragging{opacity:.6; outline:1px dashed #4a6aa0}
  
    th.colhdr{position:relative; user-select:none; transition:background .18s ease, box-shadow .18s ease}
    th.colhdr.dragging{background:#1e3a8a; box-shadow:inset 0 0 0 3px #60a5fa, 0 0 0 2px rgba(96,165,250,.35)}
    th.colhdr.drop-target{background:#0b1731; box-shadow:inset 0 0 0 3px #93c5fd}
    
/* === STICKY HEADERS (all tabs) === */
.relative.overflow-auto thead th{position:sticky;top:0;z-index:20;background:#0f172a;}
.relative.overflow-auto thead tr{position:sticky;top:0;z-index:19;background:#0f172a;}

thead th.colhdr{ text-align:center; }

/* Centered dash for empty cells only */
.dash-center{display:block;text-align:center;}

#driverMsgModal .btn.primary:hover{ filter:brightness(1.05); }

/* === CCL SEARCH UI (compact) === */
.card.p-5{ position:relative; }
.ccl-search-wrap{ position:absolute; right:14px; top:10px; width:280px; }
@media (max-width:1200px){ .ccl-search-wrap{ width:220px; } }
.ccl-search{ height:34px; line-height:34px; width:100%;
  background:#0b1220; color:#e6edf7; border:1px solid #2b3a55; border-radius:10px; padding:0 12px; font-size:14px; }
.ccl-search::placeholder{ color:#9fb2c8; letter-spacing:.02em; }
.ccl-search:focus{ outline:none; border-color:#3b82f6; box-shadow:none; }
/* === CCL SEARCH highlight (simple blue, no glow) === */
.ccl-hl{ background:#3b82f6; color:#fff; font-weight:700; padding:0 .2em; border-radius:3px; }

</style>
<style>
/* === Canva-style Header Highlight (Dark) — CSS-only === */
:root{
  --hdr-bg:#0f172a;
  --hdr-glass:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 40%),
    linear-gradient(180deg, #0f172a 0%, #121a27 70%, #0f172a 100%);
  --hdr-line:#2b3a55;

  /* Section accent suggestions (used if matching IDs/classes exist) */
  --acc-pending:#fde047;   /* yellow-300  (Main Dispatch / Pending) */
  --acc-pickups:#60a5fa;   /* sky-400     (Pickups) */
  --acc-assigned:#cbd5e1;  /* slate-300   (Assigned) */
  --acc-completed:#34d399; /* emerald-400 (Completed) */
}

/* Base header glass + elevation */
.relative.overflow-auto table thead th{
  background: var(--hdr-glass);
  border-bottom: 1px solid var(--hdr-line);
  backdrop-filter: saturate(140%) blur(4px);
  letter-spacing:.02em;
  box-shadow:
    inset 0 -2px 0 0 var(--hdr-line),
    0 8px 18px rgba(0,0,0,.35);
}

/* Neon accent line under sticky header row */
.relative.overflow-auto thead tr::after{
  content:"";
  position: sticky;
  left:0; right:0; bottom:-1px; height:5px;
  display:block; z-index:21; pointer-events:none;
  background: linear-gradient(90deg, transparent 0%,
              var(--acc-current, var(--acc-pending)) 18%,
              var(--acc-current, var(--acc-pending)) 82%,
              transparent 100%);
  box-shadow:
    0 0 14px var(--acc-current, var(--acc-pending)),
    0 0 32px var(--acc-current, var(--acc-pending)),
    0 0 64px var(--acc-current, var(--acc-pending)),
    0 0 96px var(--acc-current, var(--acc-pending));
  filter: saturate(160%) brightness(1.35);
  opacity: 1;
}

/* If your sections have these IDs, each gets its own accent color automatically */
#section_pending   thead tr{ --acc-current: var(--acc-pending); }
#section_pickups   thead tr{ --acc-current: var(--acc-pickups); }
#section_assigned  thead tr{ --acc-current: var(--acc-assigned); }
#section_completed thead tr{ --acc-current: var(--acc-completed); }

/* Subtle column separators + hover glow */
thead th.colhdr + th.colhdr{ box-shadow: -1px 0 0 0 rgba(51,65,85,.35) inset; }
thead th.colhdr:hover{
  box-shadow:
    inset 0 -2px 0 0 var(--hdr-line),
    0 0 0 1px rgba(96,165,250,.25),
    0 6px 16px rgba(2,6,23,.6);
}
/* === End Canva-style Header Highlight === */

</style>
<style>
/* Scoped ONLY to the edit modal */
#edit_modal .ccl-dd { position: relative; }
#edit_modal .ccl-dd-trigger {
  width: 100%; text-align: left;
  background: #0f172a; border: 1px solid #334155; color:#e5e7eb;
  border-radius: 0.75rem; padding: 8px 12px; min-height: 40px;
}
#edit_modal .ccl-dd-trigger:after {
  content: "▾"; float: right; opacity:.6;
}
#edit_modal .ccl-dd-trigger:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
#edit_modal .ccl-dd-menu {
  position: absolute; left: 0; right: 0; top: calc(100% + 6px);
  background: #0b1220; border: 1px solid #334155; border-radius: 12px;
  padding: 6px; box-shadow: 0 10px 24px rgba(0,0,0,.45); z-index: 120;
}
#edit_modal .ccl-dd-menu div { padding: 8px 10px; border-radius: 10px; color:#e5e7eb; cursor: pointer; }
#edit_modal .ccl-dd-menu div:hover { background:#111827; }
</style>
<style>
/* === Fullscreen Create Modal (scoped) === */
#create_modal{ z-index:200; }
#create_modal .box{ width:96vw; height:92vh; max-width:none; padding:0; display:flex; flex-direction:column; background:#0b1220; }
#create_modal .hdr{ background:linear-gradient(120deg,#1e3a8a 0%, #0f766e 100%); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #243045; }
#create_modal .title{ font-weight:700; }
#create_modal .content{ padding:18px; overflow:auto; }
#create_modal .grid2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; }
#create_modal label{ display:block; font-size:12px; color:#94a3b8; margin-bottom:6px; }
#create_modal input, #create_modal textarea{ width:100%; background:#0b0f1a; color:#e5e7eb; border:1px solid #334155; border-radius:12px; padding:10px; }
#create_modal textarea{ min-height:80px; }
#create_modal .actions{ display:flex; gap:10px; padding:12px 16px; border-top:1px solid #243045; background:#0b1220; }
#create_modal .btn{ padding:10px 16px; border-radius:10px; }
#create_modal .btn-outline{ background:#111827; border:1px solid #334155; }
#create_modal .btn-primary{ background:#2563eb; }
#create_modal .ccl-dd { position: relative; }
#create_modal .ccl-dd-trigger {
  width: 100%; text-align: left;
  background: #0b0f1a; border: 1px solid #334155; color:#e5e7eb;
  border-radius: 0.75rem; padding: 10px 12px; min-height: 40px;
}
#create_modal .ccl-dd-trigger:after { content: "▾"; float:right; opacity:.6; }
#create_modal .ccl-dd-menu {
  position: absolute; left:0; right:0; top: calc(100% + 6px);
  background:#0b1220; border:1px solid #334155; border-radius:12px; padding:6px;
  box-shadow:0 10px 24px rgba(0,0,0,.45); z-index:240;
}
#create_modal .ccl-dd-menu div{ padding:8px 10px; border-radius:10px; color:#e5e7eb; cursor:pointer; }
#create_modal .ccl-dd-menu div:hover{ background:#111827; }

/* === Pro pass: compressed UI & accent borders === */
#create_modal .box{box-shadow:0 16px 40px rgba(0,0,0,.55)}
#create_modal .content{padding:14px}
#create_modal .panel{border:1px solid #2b3a55; border-radius:16px; background:#0d1524; padding:12px}
#create_modal .panel .panel-title{font-size:12px; letter-spacing:.02em; color:#c7d2fe; margin-bottom:8px; opacity:.9}
#create_modal .grid3{display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:10px}
@media (min-width: 900px){ #create_modal .grid3{grid-template-columns:repeat(3,minmax(0,1fr));} }
#create_modal label{font-size:11px; color:#9fb2c8; margin-bottom:4px}
#create_modal input, #create_modal textarea{border-radius:10px; padding:8px 10px; min-height:36px}
#create_modal textarea{min-height:72px}
#create_modal .panel{position:relative; overflow:hidden}
#create_modal .panel:after{
  content:""; position:absolute; inset:-1px; border-radius:16px; pointer-events:none;
  box-shadow:0 0 0 1px rgba(99,102,241,.35), 0 0 24px rgba(99,102,241,.15) inset;
}

/* Drivers scoped normal height + MSG icon + elapsed blink */
#section_drivers_bottom thead th{ font-size: inherit;            /* match Main Dispatch font */
  line-height: 1.1;              /* tighten a bit for normal row height */
                /* NORMAL row padding */ padding-top:6px; padding-bottom:6px; }
#section_drivers_bottom tbody td{ font-size: inherit;            /* match Main Dispatch font */
  line-height: 1.1;              /* tighten a bit for normal row height */
                /* NORMAL row padding */ padding-top:8px; padding-bottom:8px; }
#section_drivers_bottom td.msg-cell{ text-align:center; }
#section_drivers_bottom .msg-btn{
  display:inline-grid; place-items:center;
  width:28px; height:28px;       /* smaller button so row height stays normal */
  padding:0;                     /* no extra padding */
  border-radius:8px;
  border:1px solid #334155;
  background:#0f172a; color:#cbd5e1;
  vertical-align:middle;
}
#section_drivers_bottom .msg-btn:hover{ background:#101a2b; }
#section_drivers_bottom .elapsed{ color:#cfe7ff; opacity:.9; }
#section_drivers_bottom .elapsed.late{ color:#ff3b30; animation:drv-blink 0.9s steps(2,start) infinite; font-weight:400; text-shadow:none; }
@keyframes drv-blink{ 50%{ opacity:.35; } }


/* drivers col-resize */
#section_drivers_bottom{ overflow-x:auto; }
#section_drivers_bottom table{ table-layout:auto; min-width:max-content; }
#section_drivers_bottom thead th{ position:relative; }
#section_drivers_bottom .col-grip{ position:absolute; top:0; right:-2px; width:8px; height:100%; cursor:col-resize; user-select:none; }
body.dragging-col{ cursor:col-resize; user-select:none; }


/* Accumulated Hours coloring */
#section_drivers_bottom td.acc-hrs.ok{ color:#44d07e; }
#section_drivers_bottom td.acc-hrs.over{ color:#ff3b30; }


/* Driver header sort icon */
#section_drivers_bottom thead th{ position:relative; padding-right:28px; }
#section_drivers_bottom .sort-btn{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  width:16px; height:16px; display:inline-flex; align-items:center; justify-content:center;
  cursor:pointer; opacity:.6; transition:opacity .15s ease, filter .15s ease;
}
#section_drivers_bottom .sort-btn svg{ width:16px; height:16px; stroke:#49a2ff; fill:none; stroke-width:2; }
#section_drivers_bottom .sort-btn:hover{ opacity:1; filter:drop-shadow(0 0 4px rgba(73,162,255,.7)); }
#section_drivers_bottom thead th.active-sort .sort-btn{ opacity:1; }
#section_drivers_bottom thead th.active-sort.asc .sort-btn svg{ stroke:#7cc4ff; }
#section_drivers_bottom thead th.active-sort.desc .sort-btn svg{ stroke:#7cc4ff; transform:translateY(-50%) rotate(180deg); }


/* === Drivers column filter dropdown === */
#section_drivers_bottom .sort-btn{ pointer-events:auto; } /* allow clicking icon */
#section_drivers_bottom .sort-btn svg{ color:#3aa3ff; }   /* iPhone blue */
.pp-col-filter{
  position:fixed; z-index:10005; width:320px; max-height:380px; overflow:hidden;
  background:#0f1726; color:#eaf2ff; border:1px solid #263350; border-radius:12px;
  box-shadow:0 20px 45px rgba(0,0,0,.45);
}
.pp-col-filter .ppf-head{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid #203050;
}
.pp-col-filter .ppf-head input{
  flex:1; background:#0b1220; border:1px solid #2a3b62; color:#cfe3ff; border-radius:8px;
  padding:10px 12px; outline:none;
}
.pp-col-filter .ppf-list{
  max-height:300px; overflow:auto; padding:6px 0;
}
.pp-col-filter .ppf-item{
  display:flex; align-items:center; gap:10px; padding:8px 12px; cursor:pointer;
}
.pp-col-filter .ppf-item:hover{ background:#111b32; }
.pp-col-filter .ppf-item input{ width:16px; height:16px; }
.pp-col-filter .ppf-foot{
  display:flex; justify-content:space-between; align-items:center; gap:8px;
  padding:10px 12px; border-top:1px solid #203050;
}
.pp-col-filter .ppf-btn{
  background:#0b1220; color:#cfe3ff; border:1px solid #2a3b62; border-radius:8px;
  padding:8px 12px; cursor:pointer;
}
.pp-col-filter .ppf-btn.primary{
  background:linear-gradient(90deg,#1b78ff,#41c0ff); color:#021225; border:none;
}

</style><style id="portpro_theme_overrides">
/* === PortPro-style Theme Overrides (STYLE-ONLY) ===
   NOTE: No HTML/JS/words/features changed. Pure CSS overrides.
*/
:root{
  --bg:#0b1220;          /* deeper canvas */
  --panel:#0e1523;       /* darker card */
  --ink:#e6edf7;         /* text */
  --muted:#a4b8d4;
  --line:#223049;        /* border */
  --brand:#0ea5e9;       /* sky */
  --brand-2:#06b6d4;     /* cyan */
  --accent:#93c5fd;      /* header accent */
}
body{ color:var(--ink); background:var(--bg); }

/* Cards: stronger borders + subtle neon edge */
.card{
  background:var(--panel)!important;
  border:1px solid var(--line)!important;
  border-radius:16px!important;
  box-shadow:
    0 10px 28px rgba(0,0,0,.45),
    inset 0 0 0 1px rgba(56,189,248,.10);
}
.card:hover{ box-shadow:
  0 14px 34px rgba(0,0,0,.5),
  inset 0 0 0 1px rgba(56,189,248,.18);
}

/* Tabs: crisp pill with inner glow on active */
.tab{
  background:#0b1220!important;
  border:1px solid #2a3d61!important;
  color:#d7e3f4!important;
  transition:box-shadow .18s ease, border-color .18s ease, background .18s ease;
}
.tab:hover{ border-color:#3a5a8f!important; }
.tab.active{
  background:#0f2140!important;
  border-color:#4a6aa0!important;
  box-shadow:0 0 0 2px rgba(74,106,160,.35) inset, 0 6px 16px rgba(0,0,0,.35)!important;
  color:#eaf2ff!important;
}

/* Pills (badges) */
.pill{
  background:#0f172a!important;
  border:1px solid var(--line)!important;
  color:#dbe7ff!important;
}

/* Buttons: unify radius and border, keep existing IDs/flows */
.btn{
  background:#0b1220;
  border:1px solid var(--line);
  color:#e5efff;
  border-radius:12px;
}
.btn:hover{ background:#10192e; }
.btn:disabled{ opacity:.45; cursor:not-allowed; }

/* iOS primary variant stays, just smoother hover via variable */
.btn-ios{ background:var(--brand); border-color:var(--brand); }
.btn-ios:hover{ background:#1aa3ff; }

/* Table header: glassy gradient + accent underglow */
.relative.overflow-auto thead th{
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 40%),
    linear-gradient(180deg, #0f172a 0%, #121a27 70%, #0f172a 100%) !important;
  border-bottom:1px solid #2b3a55!important;
  backdrop-filter:saturate(140%) blur(4px);
  color:#e6edf7!important;
  letter-spacing:.02em;
  box-shadow:
    inset 0 -2px 0 0 #2b3a55,
    0 8px 18px rgba(0,0,0,.35);
}
.relative.overflow-auto thead tr::after{
  content:"";
  position:sticky; left:0; right:0; bottom:-1px; height:5px; display:block; z-index:21; pointer-events:none;
  background: linear-gradient(90deg, transparent 0%, var(--accent) 18%, var(--accent) 82%, transparent 100%);
  box-shadow:0 0 14px var(--accent), 0 0 32px var(--accent), 0 0 64px var(--accent), 0 0 96px var(--accent);
  filter:saturate(160%) brightness(1.25);
}

/* Table rows: subtle zebra + hover */
tbody tr:nth-child(odd){ background:#141d2c!important; }
tbody tr:nth-child(even){ background:#0f1623!important; }
tbody tr:hover{ background:#12203a!important; }
tbody tr.selected{ background:#213c74cc!important; }

/* Column header separators + drag states */
thead th.colhdr + th.colhdr{ box-shadow:-1px 0 0 0 rgba(51,65,85,.35) inset; }
thead th.colhdr.dragging{ background:#1e3a8a!important; box-shadow:inset 0 0 0 3px #60a5fa, 0 0 0 2px rgba(96,165,250,.35)!important; }
thead th.colhdr.drop-target{ background:#0b1731!important; box-shadow:inset 0 0 0 3px #93c5fd!important; }

/* Checkboxes */
.chk{ accent-color:#94a3b8; filter:grayscale(1); }
.chk.active{ accent-color:#3b82f6; filter:none; }

/* Modals: borders + depth only (no functional changes) */
.modal .box{
  background:#0b1220!important;
  border:1px solid #2b3a55!important;
  border-radius:18px!important;
  box-shadow:0 16px 40px rgba(0,0,0,.55);
}

/* Edit/Create modal inner cards */
#edit_modal .rounded-2xl,
#create_modal .panel{
  border:1px solid #2b3a55!important;
  background:#0d1524!important;
  box-shadow: inset 0 0 0 1px rgba(99,102,241,.15);
}
#edit_modal .rounded-2xl:after,
#create_modal .panel:after{
  content:"";
  position:absolute; inset:-1px; border-radius:16px; pointer-events:none;
  box-shadow:0 0 0 1px rgba(99,102,241,.25), 0 0 24px rgba(99,102,241,.12) inset;
}

/* Inputs inside modals */
#edit_modal input, #edit_modal textarea,
#create_modal input, #create_modal textarea{
  background:#0f172a!important;
  border:1px solid #334155!important;
  color:#e5e7eb!important;
  border-radius:12px!important;
}

/* Custom dropdown triggers in modals */
#edit_modal .ccl-dd-trigger, #create_modal .ccl-dd-trigger{
  background:#0f172a!important;
  border:1px solid #334155!important;
  color:#e5e7eb!important;
}

/* Header gradient bar */
.brand-grad{
  background:linear-gradient(120deg, #0b2a55 0%, #0f766e 100%)!important;
  border-bottom:1px solid #1f2e49;
}

/* Driver badge counts (no text/feature change) */
#drv_body .text-xs{ font-weight:600; letter-spacing:.01em; }

/* Smooth scrollbars (dark) */
* { scrollbar-width: thin; scrollbar-color: #334155 #0b1220; }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: #0b1220; border-radius: 9999px; }
::-webkit-scrollbar-thumb { background: #334155; border-radius: 9999px; border: 2px solid #0b1220; }
::-webkit-scrollbar-thumb:hover { background: #475569; }
</style><style id="tab_tray_active_theme">
/* === Tab Tray + Active Highlight (style-only) === */
.tab-tray{
  display:flex; gap:8px; padding:6px;
  border:1px solid rgba(60,90,130,.55);
  background: radial-gradient(1200px 240px at 10% -20%, rgba(59,130,246,0.08), transparent 40%),
              linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border-radius: 18px;
  box-shadow: inset 0 0 0 1px rgba(56,189,248,.12), 0 10px 24px rgba(0,0,0,.35);
}
.tab{
  border:1px solid rgba(70,100,140,.55);
  background:#0b1220;
  color:#cfe4ff;
  border-radius: 12px;
  padding:10px 14px;
  transition: background .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.tab:hover{ border-color:#3a5a8f; background:#0f1830; }
.tab.active{
  background: linear-gradient(180deg, #0f213c, #0a1628);
  border-color:#4a6aa0;
  box-shadow:
    inset 0 0 0 2px rgba(99,102,241,.28),
    0 0 0 1px rgba(56,189,248,.2),
    0 8px 22px rgba(0,0,0,.45);
  color:#eaf2ff;
}
/* Small number badges already rendered; keep color but add subtle ring */
.tab .badge, .tab .count, .tab span.rounded-full{
  box-shadow: 0 0 0 1px rgba(56,189,248,.25);
}

/* Align tray area if wrapper exists */
.tabs-wrap, nav .tabs, .tab-container{ display:block; }
</style><style id="tab_border_override">
/* === Tabs: remove inner borders (style-only) === */
.tab { border: none !important; }
.tab:hover { border-color: transparent !important; }
.tab.active {
  border: none !important;
  /* keep the active look without an inner ring */
  box-shadow:
    0 8px 22px rgba(0,0,0,.45),
    0 0 14px rgba(56,189,248,.22);
}
</style><style id="tab_bright_override">
/* === Brighter tray + active tab highlight (style-only) === */
.tab-tray{
  border-color: rgba(140, 190, 255, 0.85) !important;
  box-shadow:
    inset 0 0 0 1px rgba(99, 179, 237, .20),
    0 0 0 1px rgba(99, 179, 237, .25),
    0 10px 24px rgba(0,0,0,.45) !important;
  background:
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0) 40%) !important;
}
.tab{
  border: none !important;
  background: #0b1220 !important;
}
.tab:hover{
  background:#0f1830 !important;
  box-shadow: 0 0 0 1px rgba(99,179,237,.18) !important;
}
.tab.active{
  background: linear-gradient(180deg, #0f213c, #0a1628) !important;
  box-shadow:
    0 0 0 1px rgba(99,179,237,.40),
    0 8px 22px rgba(0,0,0,.50),
    0 0 24px rgba(99,179,237,.25) !important;
  color:#eaf2ff !important;
}
.tab .badge, .tab .count, .tab span.rounded-full{
  box-shadow: 0 0 0 1px rgba(99,179,237,.30) !important;
}
</style><style id="tab_visual_pass_v2">
/* === Tabs visual pass v2 (style-only) === */
/* 1) Main tray: brighter, clearer outline */
.tab-tray{
  border-color: rgba(140,190,255,0.95) !important;
  box-shadow:
    inset 0 0 0 1px rgba(99,179,237,.25),
    0 0 0 2px rgba(99,179,237,.20),
    0 14px 28px rgba(0,0,0,.45) !important;
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0) 45%) !important;
  border-radius: 18px !important;
  padding: 6px !important;
}

/* 2) Tabs default: blended (no inner border), subtle dark background */
.tab{
  border: none !important;
  background: rgba(10,16,28,.55) !important;
  color: #d7e8ff !important;
  border-radius: 12px !important;
  padding: 10px 14px !important;
  transition: box-shadow .15s ease, background .15s ease, transform .15s ease;
  box-shadow: none !important;
  opacity: .92;
}
.tab:hover{
  background: rgba(14,22,38,.72) !important;
  box-shadow: 0 0 0 1px rgba(99,179,237,.20) !important;
}
/* 3) Active tab: obvious highlight */
.tab.active{
  background: linear-gradient(180deg, #1a2943, #0f1c32) !important;
  color: #ffffff !important;
  box-shadow:
    0 0 0 2px rgba(99,179,237,.45),
    0 10px 24px rgba(0,0,0,.55),
    0 0 28px rgba(99,179,237,.22) !important;
  transform: translateZ(0);
}

/* 4) Badges inside tabs: unify color */
.tab .badge,
.tab .count,
.tab span.rounded-full,
.tab .pill{
  background: rgba(27,102,177,.95) !important;  /* unified blue */
  color: #eaf6ff !important;
  border: none !important;
  box-shadow: 0 0 0 1px rgba(99,179,237,.35) !important;
}

/* Keep non-tab chips elsewhere unchanged */
</style><style>
/* --- Stop funnel icon flipping --- */
#section_drivers_bottom thead th.active-sort.asc .sort-btn svg,
#section_drivers_bottom thead th.active-sort.desc .sort-btn svg{
  transform:none !important;
}
</style>

<style>
/* === FORCE-HIDE FILTER ICONS on specific Driver columns ===
   Drivers header order:
   1: Checkbox | 2: ID | 3: Acc Hrs | 4: Driver | 5: MSG | 6: Status | 7: ETA | 8: Elaps Time
   Hide on 1,2,3,5,7,8 (keep Driver + Status).
*/
#section_drivers_bottom thead th:nth-child(1) .sort-btn,
#section_drivers_bottom thead th:nth-child(2) .sort-btn,
#section_drivers_bottom thead th:nth-child(3) .sort-btn,
#section_drivers_bottom thead th:nth-child(5) .sort-btn,
#section_drivers_bottom thead th:nth-child(7) .sort-btn,
#section_drivers_bottom thead th:nth-child(8) .sort-btn { display: none !important; }
#section_drivers_bottom thead th:nth-child(1) svg,
#section_drivers_bottom thead th:nth-child(2) svg,
#section_drivers_bottom thead th:nth-child(3) svg,
#section_drivers_bottom thead th:nth-child(5) svg,
#section_drivers_bottom thead th:nth-child(7) svg,
#section_drivers_bottom thead th:nth-child(8) svg { display: none !important; }
</style>


<style>
/* v11 — Search bar spacing tweak */
.ccl-search-tight { margin-top: 0 !important; margin-bottom: 6px !important; padding-top: 0 !important; }
.ccl-search-tight input[type="search"],
.ccl-search-tight input[type="text"] { margin-top: 0 !important; }
</style>
<script>
// v11 — tighten search bar spacing + brighter highlight + force-first-row
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    // 1) Tighten the search bar spacing
    (function tightenSearch(){
      // Heuristic: find a search input near the tabs/header and pull it up visually
      const candidates = Array.from(document.querySelectorAll('input[type="search"], input[type="text"]'))
        .filter(el => {
          const ph = (el.getAttribute('placeholder')||'').toLowerCase();
          const id = (el.id||'').toLowerCase();
          const cls = (el.className||'').toLowerCase();
          // Likely search fields
          return ph.includes('search') || id.includes('search') || cls.includes('search');
        });
      // Pick the first visible candidate
      const vis = candidates.find(el => {
        const s = getComputedStyle(el);
        return s.display!=='none' && s.visibility!=='hidden' && el.offsetParent!==null;
      });
      if(vis){
        const holder = vis.closest('.search, .search-bar, .searchbar, .controls, .toolbar, .panel, .row, div');
        if(holder){ holder.classList.add('ccl-search-tight'); }
        // Also nudge up by negative margin if needed (subtle)
        vis.style.marginTop = '0px';
        if(holder && !/ccl-tabs|tabs_container/.test(holder.id||'')){
          holder.style.marginTop = '0px';
        }
      }
    })();

    // 2) Override highlight to be REALLY bright and always first row
    function brightFocusRowById(id){
      const body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
      if(!body || !id) return;
      const row = body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
      if(!row) return;
      // Move to very top
      if(body.firstChild !== row){
        body.insertBefore(row, body.firstChild);
      }
      // Very bright highlight (vivid yellow)
      row.style.transition = 'background 120ms ease-in';
      const old = row.style.backgroundColor;
      row.style.backgroundColor = 'rgba(255, 238, 0, 0.9)'; // brighter
      setTimeout(function(){ row.style.backgroundColor = old || ''; }, 800);
      try{ row.scrollIntoView({block:'center'}); }catch(_){}
    }

    // Hook into the v10 flow after render
    document.addEventListener('click', function(e){
      const t = e.target;
      if(!t) return;
      if(t.id === 'btn_create_update' || (t.closest && t.closest('#btn_create_update'))){
        setTimeout(function(){
          try{
            const id = (document.getElementById('c_id')||{}).value || '';
            if(id) brightFocusRowById(id.trim());
          }catch(_){}
        }, 150);
      }
    }, true);
  });
})();
</script>

<style>

<style>

/* === CCL: Freeze first (checkbox) column across tables (header + body) === */
.relative.overflow-auto table thead th:first-child,
.relative.overflow-auto table tbody td:first-child{
  position: sticky;
  left: 0;
  z-index: 4; /* keep header above body cells */
  background: #0f172a; /* dark bg to match */
}
/* Divider on the right edge of the frozen column */
.relative.overflow-auto table thead th:first-child,
.relative.overflow-auto table tbody td:first-child{
  box-shadow: 2px 0 0 rgba(255,255,255,0.06);
}

</style>
<style>

/* === CCL: Robust sticky first column (fix disappearing on horizontal scroll) === */
/* Ensure the scroll container is the positioning context */
.relative.overflow-auto{ position: relative; overflow: auto; }
.relative.overflow-auto table{ border-collapse: separate; border-spacing: 0; }
/* Freeze first column (header + body) and keep it above other cells */
.relative.overflow-auto thead th:first-child,
.relative.overflow-auto tbody td:first-child{
  position: sticky;
  left: 0;
  z-index: 50; /* higher than other cells, so it never gets covered */
  background: #0f172a; /* match the dark theme */
  /* Maintain a consistent width so it doesn't jitter */
  min-width: 44px; width: 44px; max-width: 44px;
}
/* Slight divider on the right edge for separation */
.relative.overflow-auto thead th:first-child,
.relative.overflow-auto tbody td:first-child{
  box-shadow: 2px 0 0 rgba(255,255,255,0.06);
}

</style>

<style id="no_flicker_modal">
/* Disable animations/transitions while opening the Edit modal */
#edit_modal.no-anim *, #edit_modal.no-anim { 
  transition: none !important; 
  animation: none !important; 
}
</style>

<style id="create_modal_compact_v1">
/* === Create Modal: 35% overall size reduction (no font-size changes) === */
#create_modal .box{ width:62vw !important; height:60vh !important; }
#create_modal .hdr{ padding:8px 12px !important; }
#create_modal .content{ padding:10px !important; }
#create_modal .grid3{ gap:8px !important; }
#create_modal .panel{ padding:8px !important; border-radius:14px !important; }
#create_modal label{ margin-bottom:3px !important; }
#create_modal input, #create_modal textarea{ padding:6px 8px !important; min-height:32px !important; }
#create_modal textarea{ min-height:64px !important; }
#create_modal .actions{ padding:8px 12px !important; gap:8px !important; }
#create_modal .btn{ padding:8px 12px !important; border-radius:10px !important; }
</style>
<style id="create_modal_compact_v2">
/* === Create Modal: Extra 10% compression (excluding From/To/Customer) === */
#create_modal .grid3 > div:not(:has(#c_from)):not(:has(#c_to)):not(:has(#c_customer)){
  flex: 1 1 0;
  max-width: 85% !important;
}
#create_modal input, #create_modal textarea{
  padding:5px 7px !important;
}
#create_modal .panel{ padding:6px !important; }
</style>
<style id="create_modal_grow_13">
/* === Create Modal: +13% size tweak (no font change) === */
#create_modal .box{ width:70vw !important; height:68vh !important; }
#create_modal .hdr{ padding:10px 14px !important; }
#create_modal .content{ padding:12px !important; }
#create_modal .panel{ padding:9px !important; }
</style>
<style id="customer_btn_compact_ios">
/* === Customer dropdown buttons: compact + iPhone blue === */
#c_btn_save_customer{ padding:4px 10px !important; border-radius:10px !important; background:var(--ios) !important; border-color:var(--ios) !important; }
#c_btn_save_customer:hover{ background:var(--ios-hover) !important; }
#c_btn_delete_customer{ padding:4px 10px !important; border-radius:10px !important; }
</style>
<style id="customer_btn_shrink30">
/* === Customer dropdown buttons smaller by 30% === */
#c_btn_save_customer, #c_btn_delete_customer{
  font-size: 0.8em !important;
  padding:3px 8px !important;
  border-radius:8px !important;
}
</style>
<style id="customer_dd_menu_style">
/* === Customer dropdown menu styling === */
.ccl-dd{ position:relative; display:inline-block; width:100%; }
.ccl-dd-trigger{ width:100%; background:#111827; border:1px solid #374151; border-radius:8px; padding:6px 10px; text-align:left; color:#fff; }
.ccl-dd-menu{ position:absolute; top:100%; left:0; right:0; background:#1f2937; border:1px solid #374151; border-radius:8px; max-height:220px; overflow-y:auto; z-index:50; }
.ccl-dd-menu div{ padding:6px 10px; cursor:pointer; }
.ccl-dd-menu div:hover{ background:#2563eb; color:#fff; }
.hidden{ display:none; }
</style>
<style id="customer_dd_menu_height">
/* === Customer dropdown: show at least 10 items === */
.ccl-dd-menu{ max-height: 360px !important; }
</style>
<style id="customer_dd_overlay_10rows">
/* === Customer dropdown: overlay (no clipping) + 10-row view === */
.ccl-dd{ position:relative; overflow:visible; }
.ccl-dd-menu{
  position: fixed !important;   /* detach from clipped parents */
  z-index: 10050 !important;    /* above modals */
  max-height: none !important;
  height: 360px !important;     /* ~10 items */
  overflow-y: auto !important;
  width: auto;                   /* set in JS to match trigger */
  box-shadow: 0 14px 32px rgba(0,0,0,.45);
}
</style>
</head>
<body class="min-h-screen">
<header class="brand-grad p-4 flex items-center justify-between">
<h1 class="text-lg font-semibold">Coastal City Logistics — Dispatch Board</h1>
</header>
<main class="max-w-screen-2xl w-full mx-auto p-6 space-y-6">
<div class="flex items-center gap-2 tab-tray" id="tabs_container">
<!-- Original order: Pickups, Assigned, Completed, Pending (renamed visually) -->
<button class="tab active" id="tab_pending" onclick="switchTab('pending')">Main Dispatch <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-yellow-900 text-yellow-200" id="badge_pending">0</span></button>
<button class="tab" id="tab_pickups" onclick="switchTab('pickups')">Pickups <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-blue-900 text-blue-200" id="badge_pickups">0</span></button>
<button class="tab" id="tab_assigned" onclick="switchTab('assigned')">Assigned <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-slate-700 text-slate-200" id="badge_assigned">0</span></button>
<button class="tab" id="tab_inprogress" onclick="switchTab('inprogress')">In‑Progress <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-amber-900 text-amber-200" id="badge_inprogress">0</span></button>
<button class="tab" id="tab_completed" onclick="switchTab('completed')">Completed <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-emerald-900 text-emerald-200" id="badge_completed">0</span></button>
<button class="tab flex items-center gap-2" id="tab_drivergps" title="Open Driver GPS in a new window"><span>Driver GPS</span>
<svg aria-hidden="true" class="opacity-80" height="16" viewbox="0 0 24 24" width="16">
<path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z" fill="currentColor"></path>
<path d="M5 5h7V3H3v9h2V5z" fill="currentColor"></path>
</svg>
</button><div class="ml-auto text-xs opacity-80 pill">Coastal City Logistics</div>
</div>
<!-- PICKUPS -->
<section class="space-y-4" id="section_pickups">
<div class="card p-5">
<h2 class="text-xl font-bold text-sky-300 mb-3"><span style="color:#007AFF;">Pickups</span></h2>
<div class="relative overflow-auto rounded-xl" style="max-height:320px">
<table>
<thead><tr></tr></thead>
<tbody id="p1_body"></tbody>
</table>
</div>
</div>
<div class="flex items-center gap-3">
<button class="btn bg-blue-600 hover:bg-blue-700 disabled:opacity-40" id="btn_assign">Assign</button>
<button class="btn bg-slate-600 hover:bg-slate-500" id="btn_move">Move</button>
</div>
</section>
<!-- ASSIGNED -->
<section class="space-y-4 hidden" id="section_assigned">
<div class="card p-5">
<h2 class="text-xl font-bold text-sky-300 mb-3"><span style="color:#007AFF;">Assigned</span></h2>
<div class="relative overflow-auto rounded-xl" style="max-height:320px">
<table>
<thead><tr></tr></thead>
<tbody id="assigned_body"></tbody>
</table>
</div>
</div>
<div class="flex items-center gap-3">
<button class="btn bg-slate-700 hover:bg-slate-600 disabled:opacity-40" id="btn_remove">Remove</button>
<button id="btn_update" style="background-color:#2563eb; color:white; padding:0.5rem 1rem; border-radius:0.5rem;" onmouseover="this.style.backgroundColor=\'#1d4ed8\'" onmouseout="this.style.backgroundColor=\'#2563eb\'">Update Driver</button>
</div>
</section>
<!-- COMPLETED -->
<!-- IN-PROGRESS -->
<section class="space-y-4 hidden" id="section_inprogress">
<div class="card p-5">
<h2 class="text-xl font-bold text-sky-300 mb-3">In‑Progress</h2>
<div class="relative overflow-auto rounded-xl" style="max-height:320px">
<table>
<thead><tr></tr></thead>
<tbody id="inprogress_body"></tbody>
</table>
</div>
</div>
<div class="flex items-center gap-3">
<button class="btn" id="btn_ip_edit" style="background:#065f46; border-color:#047857; color:#d1fae5;">Edit</button>
<button class="btn bg-slate-700 hover:bg-slate-600 disabled:opacity-40" id="btn_ip_move">Retract</button>
</div>
</section>
<section class="space-y-4 hidden" id="section_completed">
<div class="card p-5">
<h2 class="text-xl font-bold text-sky-300 mb-3"><span style="color:#007AFF;">Completed</span></h2>
<div class="relative overflow-auto rounded-xl" style="max-height:320px">
<table>
<thead><tr></tr></thead>
<tbody id="completed_body"></tbody>
</table>
</div>
</div>
</section>
<!-- MAIN DISPATCH (Pending) -->
<section class="space-y-4 hidden" id="section_pending">
<div class="card p-5">
<h2 class="text-xl font-bold text-yellow-300 mb-3"><span style="color:#007AFF;"><span style="color:#007AFF;">Main Dispatch</span></span></h2><div class="ccl-search-wrap"><input id="pending_search" class="ccl-search" type="text" placeholder="SEARCH" /></div>
<div class="relative overflow-auto rounded-xl" style="max-height:320px">
<table>
<thead><tr></tr></thead>
<tbody id="pending_body"></tbody>
</table>
</div>
</div>
<!-- Only Create New + Move -->
<div class="flex items-center gap-3 mt-3">
<button class="btn bg-blue-600 hover:bg-blue-700" id="btn_create_pending">Create New</button>
<button class="btn bg-gray-500 hover:bg-gray-600" id="btn_delete_pending">Delete</button>
<button class="btn" id="btn_edit_pending" style="background:#065f46; border-color:#047857; color:#d1fae5;">Edit</button><button class="btn bg-blue-600 hover:bg-blue-700" id="btn_move_from_pending">Dispatch</button>
</div>
</section>
<!-- DRIVERS (BOTTOM) -->
<section class="space-y-4" id="section_drivers_bottom">
<div class="card p-5">
<h2 class="text-xl font-bold text-sky-300 mb-3"><span style="color:#007AFF;">Drivers</span></h2>
<div class="relative overflow-auto rounded-xl" style="max-height:220px">
<table>
<thead>
<tr>
<th style="width:42px"></th>
<th style="width:100px">ID</th>
<th style="width:90px">Acc Hrs</th>
<th style="width:220px">Driver</th>
<th style="width:74px" class="right">MSG</th>
<th>Status</th>
<th style="width:90px">ETA</th>
<th style="width:120px">Elaps Time</th>
</tr>
</thead>
<tbody id="drv_body"></tbody>
</table>
</div>
</div>
</section>
</main>
<!-- Toast -->
<div id="toast" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b1220;border:1px solid #243045;border-radius:12px;padding:10px 14px;color:#e5eefb;display:none;z-index:60"></div>
<!-- Alert Modal -->
<div class="modal" id="alert_modal">
<div class="box">
<h3 class="text-lg font-semibold mb-2 text-red-200">Driver Mismatch</h3>
<p class="text-sm opacity-90 mb-4 msg" id="alert_text">You selected the wrong driver.</p>
<div class="flex justify-end gap-2">
<button class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600" onclick="closeAlert()">OK</button>
</div>
</div>
</div>
<!-- EDIT POPUP -->
<!-- EDIT POPUP (Driver App layout, all fields blank) -->
<div class="modal" id="edit_modal">
<div class="box p-0 overflow-hidden" style="max-width:420px">
<div class="brand-grad px-4 py-3 flex items-center justify-between">
<div class="flex items-center gap-2">
<div class="w-8 h-8 rounded-full bg-slate-900/25 grid place-items-center font-semibold">CC</div>
<div class="text-sm font-semibold">Coastal City Logistics</div>
</div>
<div class="text-xs opacity-80">LTE • 100%</div>
</div>
<div class="p-5 space-y-4">
<div><h3 class="text-2xl font-bold text-slate-100" id="edit_title">Edit Job</h3></div>
<div class="rounded-2xl border border-slate-700 bg-[#0e1523] p-4 space-y-4">
<div class="flex items-center gap-2"><span class="tab" id="e_jobpill">Job #</span></div>
<div class="grid grid-cols-2 gap-4 text-sm">
<div>
<label class="block text-slate-400 text-xs mb-1">From</label>
<textarea class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_from" placeholder="" rows="3"></textarea>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">To</label>
<textarea class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_to" placeholder="" rows="3"></textarea>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">Container #</label>
<input class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_container" placeholder=""/>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">LOAD / EMPTY</label>
<input id="e_loadempty" type="hidden" value=""/>
<div class="ccl-dd">
<button class="ccl-dd-trigger" id="dd_loadempty" type="button"></button>
<div class="ccl-dd-menu hidden" id="menu_loadempty">
<div data-val="LOAD">LOAD</div>
<div data-val="EMPTY">EMPTY</div>
</div>
</div>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">BK # / PIN</label>
<input class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_bkpin" placeholder=""/>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">Import / Export</label>
<input id="e_impexp" type="hidden" value=""/>
<div class="ccl-dd">
<button class="ccl-dd-trigger" id="dd_impexp" type="button"></button>
<div class="ccl-dd-menu hidden" id="menu_impexp">
<div data-val="Import">Import</div>
<div data-val="Export">Export</div>
</div>
</div>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">Seal #</label>
<input class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_seal" placeholder=""/>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">Window</label>
<input class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_window" placeholder=""/>
</div>
</div>
<div>
<label class="block text-slate-400 text-xs mb-1">Instruction</label>
<textarea class="w-full bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2" id="e_instruction" placeholder="" rows="2"></textarea>
</div>
</div>
<div class="flex items-center justify-between gap-3 pt-1">
<button class="flex-1 px-4 py-2 rounded-xl border border-slate-600 bg-slate-800 hover:bg-slate-700" id="btn_modal_cancel">Cancel</button>
<button class="flex-1 px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700" id="btn_modal_update">Save</button>
</div>
</div>
</div>
</div>
<div class="modal" id="create_modal" style="display:none">
<div class="box border border-slate-700 rounded-2xl overflow-hidden">
<div class="hdr">
<div class="flex items-center gap-2">
<div class="w-8 h-8 rounded-full bg-slate-900/25 grid place-items-center font-semibold">CC</div>
<div class="text-sm font-semibold">Coastal City Logistics</div>
</div>
<div class="title">Create Pickup</div>
<div class="text-xs opacity-80">LTE • 100%</div>
</div>
<div class="content">
<div class="space-y-3"><div class="panel"><div class="panel-title">Job</div><div class="grid3"><div><label>Job #</label><input id="c_id"/></div><div><label>Window</label><input id="c_window"/></div><div><label>BK # / PIN</label><input id="c_bkpin"/></div></div></div><div class="panel"><div class="panel-title">Locations</div><div class="grid3"><div><label>From</label><textarea id="c_from" rows="3"></textarea></div><div><label>To</label><textarea id="c_to" rows="3"></textarea></div><div><label>Customer</label><input id="c_customer" type="hidden"/><div class="ccl-dd"><button class="ccl-dd-trigger" id="c_dd_customer" type="button">Select…</button><div class="ccl-dd-menu hidden" id="c_menu_customer"></div></div><div class="mt-2 flex gap-2"><button id="c_btn_save_customer" class="btn btn-ios" type="button" style="padding:6px 10px;">Save Customer</button><button id="c_btn_delete_customer" class="btn" type="button" style="padding:6px 10px;">Delete</button></div></div></div></div><div class=\"panel\"><div class=\"grid3\"><div><label>Customer Email</label><input id=\"c_email\"/></div><div><label>Customer Phone</label><input id=\"c_phone\"/></div></div></div><div class="panel"><div class="panel-title">Container • Type</div><div class="grid3"><div><label>Container #</label><input id="c_container"/></div><div><label>Load / Empty</label><input id="c_loadempty" type="hidden"/><div class="ccl-dd"><button class="ccl-dd-trigger" id="c_dd_loadempty" type="button">Select…</button><div class="ccl-dd-menu hidden" id="c_menu_loadempty"><div data-val="LOAD">LOAD</div><div data-val="EMPTY">EMPTY</div></div></div></div><div><label>Import / Export</label><input id="c_impexp" type="hidden"/><div class="ccl-dd"><button class="ccl-dd-trigger" id="c_dd_impexp" type="button">Select…</button><div class="ccl-dd-menu hidden" id="c_menu_impexp"><div data-val="Import">Import</div><div data-val="Export">Export</div></div></div></div></div></div><div class="panel"><div class="panel-title">Dates • Appt</div><div class="grid3"><div><label>Appointment</label><input id="c_appt"/></div><div><label>P/U Date</label><input id="c_pudate"/></div><div><label>Delivery Date</label><input id="c_deliveryDate"/></div><div><label>LFD Date</label><input id="c_lfd"/></div><div><label>Return Date</label><input id="c_returnDate"/></div></div></div><div class="panel"><div class="panel-title">Ports • Equipment</div><div class="grid3"><div><label>Return Port</label><input id="c_returnPort"/></div><div><label>Chassis</label><input id="c_chassis"/></div><div><label>Size / Type</label><input id="c_size"/></div><div><label>PIN #</label><input id="c_pin"/></div><div><label>Seal #</label><input id="c_seal"/></div></div></div><div class="panel"><div class="panel-title">Instruction</div><div class="grid3"><div style="grid-column:1/-1"><label>Instruction</label><textarea id="c_instruction" rows="3"></textarea></div></div></div></div>
</div>
<div class="actions">
<button class="btn btn-outline" id="btn_create_cancel">Cancel</button>
<button class="btn btn-primary" id="btn_create_update">Update</button>
</div>
</div>
</div>
<!-- YES/NO CONFIRM -->
<div class="modal" id="confirm_modal">
<div class="box max-w-sm">
<p class="mb-4" id="confirm_text"></p>
<div class="flex justify-end gap-2">
<button class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600" id="confirm_no">No</button>
<button class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700" id="confirm_yes">Yes</button>
</div>
</div>
</div>
<script>
    // ---------- DATA ----------
    const pickups = [
      {id:'CCL-5001',from:'BBT',to:'Yusen Logistics, Torrance',container:'MSCU1029384',appt:'671800',bk:'BK77001',window:'07–08 AM',status:'Open'},
      {id:'CCL-5002',from:'SSA Pier A',to:'Maersk Depot, Carson',container:'CMAU6654321',appt:'671901',bk:'BK77002',window:'08–09 AM',status:'Open'},
      {id:'CCL-5003',from:'ITS (LB)',to:'Amazon LGB3',container:'TEMU5567123',appt:'672002',bk:'BK77003',window:'09–10 AM',status:'Open'},
      {id:'CCL-5004',from:'Pier C',to:'Target RDC (Fontana)',container:'TCLU2948210',appt:'672103',bk:'BK77004',window:'10–11 AM',status:'Open'},
      {id:'CCL-5005',from:'BBT',to:'Costco DC (Ontario)',container:'MSCU8812001',appt:'672204',bk:'BK77005',window:'11–12 PM',status:'Open'},
      {id:'CCL-5006',from:'Pier E',to:'Walmart RDC',container:'MAEU4433221',appt:'672305',bk:'BK77006',window:'12–01 PM',status:'Open'},
      {id:'CCL-5007',from:'LBCT',to:'Nike DC',container:'OOLU4422110',appt:'672406',bk:'BK77007',window:'01–02 PM',status:'Open'},
      {id:'CCL-5008',from:'TRAPAC',to:'Home Depot DC',container:'APZU7788991',appt:'672507',bk:'BK77008',window:'02–03 PM',status:'Open'},
      {id:'CCL-5009',from:'PCT',to:'UPS Hub',container:'SEGU9988776',appt:'672608',bk:'BK77009',window:'03–04 PM',status:'Open'},
      {id:'CCL-5010',from:'YTI',to:'FedEx Ground',container:'TRLU3344552',appt:'672709',bk:'BK77010',window:'04–05 PM',status:'Open'}
    ];

    const drivers = [{id:'DRV-1',name:'Prime Tech Solutions',status:'AVL',empId:'53939'},
      {id:'DRV-2',name:'CCL CEO Jorge',status:'AVL',empId:'54545'},
      {id:'DRV-3',name:'Jose',status:'AVL',empId:'554421'},
      {id:'DRV-4',name:'Kevin',status:'AVL',empId:'598771'}];

    let assigned = [];
    let completed = [];
    let pending = [...pickups];
/* === CCL CLEAN RESET 10 — inside app scope (overwrite scoped arrays) === */
(function(){
  try{
    try{ localStorage.removeItem('ccl_pending_extras_v1'); }catch(_){}
    try{ localStorage.removeItem('ccl_pending_deleted_ids'); }catch(_){}
    function R(a){ return a[Math.floor(Math.random()*a.length)]; }
    function D(n){ let s=''; for(let i=0;i<n;i++) s+=String(Math.floor(Math.random()*10)); return s; }
    function C(){ var L='ABCDEFGHIJKLMNOPQRSTUVWXYZ', p=''; for(var i=0;i<4;i++) p+=L[Math.floor(Math.random()*L.length)]; return p + String(1000000 + Math.floor(Math.random()*9000000)); }
    var F=['YTI','LBCT','APM','Fenix','SSA','TTI','Trapac','FMS'];
    var T=['FedEx Ground','Amazon LGB3','Target DC','Costco DC','Walmart RDC','UPS','Best Buy DC','Home Depot'];
    var W=['08–09 AM','09–10 AM','10–11 AM','11–12 PM','12–01 PM','01–02 PM','02–03 PM','03–04 PM','04–05 PM'];
    var seed = Array.from({length:10}).map(function(_,i){ return { id:'CCL-'+String(8000+i)+'-'+D(2), from:R(F), to:R(T), container:C(), appt:String(650000+Math.floor(Math.random()*349999)), bk:'BK'+String(78000+Math.floor(Math.random()*1000)), window:R(W), status:'Open' }; });
    pending = seed.slice(); pickups = []; assigned = []; completed = []; try{ inprogress = []; }catch(_){}
    try{ localStorage.setItem('ccl_pending_extras_v1', JSON.stringify(seed)); }catch(_){}
    try{ document.querySelectorAll('#pending_search').forEach(function(inp){ inp.value=''; }); }catch(_){}
    try{ var body=document.getElementById('pending_body')||document.querySelector('#section_pending tbody'); if(body){ Array.from(body.rows).forEach(function(tr){ if(tr&&tr.style) tr.style.display=''; }); body.querySelectorAll('span.ccl-hl').forEach(function(s){ s.replaceWith(document.createTextNode(s.textContent)); }); } }catch(_){}
    try{ if(typeof renderPending==='function') renderPending(); }catch(_){}
    try{ if(typeof updateBadges==='function') updateBadges(); }catch(_){}
    try{ if(typeof switchTab==='function') switchTab('pending'); }catch(_){}
  }catch(e){ console.warn('CCL CLEAN RESET 10 (inner) error', e); }
})();
/* === end CCL CLEAN RESET 10 === */
 // All start on Main Dispatch
    pickups.length = 0;

    // ---------- STATE ----------
    const state = { selectedPickups:new Set(), selectedAssigned:new Set(), selectedPending:new Set(), selectedInprogress:new Set(), selectedDriver:null, editOriginalId:null, editScope:null, currentTab:'pickups', createMode:null };

    // ---------- COLUMN DEFINITIONS ----------
    
    const COLUMN_LABELS = {
      arrival: 'DATE OF ARRIVAL',
      id: 'JOB',
      container: 'CONTAINER',
      chassis: 'CHASSIS',
      size: 'SIZE TYPE',
      pin: 'PIN',
      ie: 'IMPORT / EXPORT',
      bk: 'BK/EDO',
      from: 'PICK PORT',
      pudate: 'P/U DATE',
      appt: 'APPT TIME',
      deliveryDate: 'DEL DATE',
      to: 'DELIVERY',
      lfd: 'LFD DATE',
      returnDate: 'RETURN DATE',
      returnPort: 'RETURN PORT',
      customer: 'CUSTOMER',
      remark: 'REMARK',
      carrier: 'CARRIER NAME',
      mbl: 'MB/L NO.',
      status: 'DROP / LIVE'
    ,
      email: 'EMAIL',
      phone: 'PHONE'
    };

    
    const DEFAULT_ORDER = [
      'arrival','id','container','chassis','size','pin','ie','bk',
      'from','pudate','appt','deliveryDate','to','lfd','returnDate','returnPort',
      'appt','customer','remark','carrier','mbl','status','email','phone'
    ];

    try{ localStorage.removeItem('ccl_col_order'); localStorage.removeItem('ccl_col_order_all'); }catch(_){}
function getOrder(){
      try{ const s=localStorage.getItem('ccl_col_order'); if(s){ const arr=JSON.parse(s); if(Array.isArray(arr)&&arr.length){ return arr.filter(k=>COLUMN_LABELS[k]); }} }catch(e){}
      return [...DEFAULT_ORDER];
    }
    function setOrder(arr){ try{ localStorage.setItem('ccl_col_order', JSON.stringify(arr)); }catch(e){} }
    let COL_ORDER = getOrder();

    function statusPill(s){// Show a centered dash when empty or 'pending'; otherwise plain text
  const v = (s == null) ? '' : String(s);
  if(!v.trim() || v.trim().toLowerCase()==='pending'){
    return '<span class="dash-center">—</span>';
  }
  return v;}
    function toast(msg){ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},1600); }
    function updateBadges(){
      document.getElementById('badge_pickups').textContent = pickups.length;
      document.getElementById('badge_assigned').textContent = assigned.length;
      document.getElementById('badge_completed').textContent = completed.length;
      document.getElementById('badge_pending').textContent = pending.length;
    
      var _ip=document.getElementById('badge_inprogress'); if(_ip){ try{ _ip.textContent=(typeof inprogress!=='undefined'&&inprogress&&inprogress.length)||0; }catch(e){ _ip.textContent=0; } }}
    function syncActionButtons(){
      const btnAssign=document.getElementById('btn_assign');
      const btnRemove=document.getElementById('btn_remove');
      const btnUpdate=document.getElementById('btn_update');
      const btnIpMove=document.getElementById('btn_ip_move');
      
      if(btnAssign) btnAssign.disabled=!(state.selectedPickups.size>0 && state.selectedDriver);
      if(btnRemove) btnRemove.disabled=!(state.selectedAssigned.size>0);
      if(btnUpdate) btnUpdate.disabled=!(state.selectedAssigned.size>0 && state.selectedDriver);
      if(btnIpMove) btnIpMove.disabled=!(state.selectedInprogress.size>0);
      
    }

    // ---------- Column builders & DnD ----------
    function buildHeader(theadEl, withCheckbox, includeDriver){
      const tr=document.createElement('tr'); theadEl.innerHTML=''; theadEl.appendChild(tr);
      if(withCheckbox){ const th=document.createElement('th'); th.style.width='42px'; tr.appendChild(th);
        /* MASTER CB */ const master=document.createElement('input'); master.type='checkbox'; master.className='h-4 w-4 align-middle';
        th.appendChild(master);
        master.addEventListener('change', function(){
          const table = theadEl.closest('table'); if(!table) return;
          const tb = (table.tBodies && table.tBodies[0]) ? table.tBodies[0] : null; if(!tb) return;
          const boxes = tb.querySelectorAll('input[type="checkbox"]');
          boxes.forEach(cb => { cb.checked = master.checked; cb.dispatchEvent(new Event('change', {bubbles:true})); });
        });
      }
      if(includeDriver){ const th=document.createElement('th'); th.textContent='Driver'; tr.appendChild(th); }
      COL_ORDER.forEach(function(key){
        const th=document.createElement('th'); th.textContent = COLUMN_LABELS[key] || key; th.dataset.key=key; th.className='colhdr'; tr.appendChild(th);
      });
      enableHeaderDnD(theadEl, includeDriver ? 1 : 0, withCheckbox ? 1 : 0);
    }
    function cellFor(a, key, statusOverride){
if(key==='status') return statusPill(statusOverride || a.status);
  const norm = (val) => {
    const s = (val==null) ? '' : String(val);
    return (!s.trim() || s==='—') ? '<span class="dash-center">—</span>' : s;
  };
  if(key==='customer') return norm(a.customer || (a.to));
  if(key==='to') return norm(a.to);
  if(key==='from') return norm(a.from);
  if(key==='appt') return norm(a.appt);
  if(key==='deliveryDate') return norm(a.deliveryDate);
  if(key==='lfd') return norm(a.lfd);
  if(key==='arrival') return norm(a.arrival);
  if(key==='container') return norm(a.container);
  if(key==='pudate') return norm(a.pudate);
  if(key==='bk') return norm(a.bk);
  if(key==='pin') return norm(a.pin);
  if(key==='size') return norm(a.size);
  if(key==='ie') return norm(a.ie);
  if(key==='chassis') return norm(a.chassis);
  if(key==='returnDate') return norm(a.returnDate);
  if(key==='returnPort') return norm(a.returnPort);
  if(key==='remark') return norm(a.remark);
  if(key==='carrier') return norm(a.carrier);
  if(key==='mbl') return norm(a.mbl);
if(key==='email') return norm(a.email);
  if(key==='phone') return norm(a.phone);
  return norm(a[key]);
}
    function buildRowCells(tr, a, statusOverride){
      COL_ORDER.forEach(function(key){
        const td=document.createElement('td'); td.innerHTML = cellFor(a, key, statusOverride); tr.appendChild(td);
      });
    }
    
function enableHeaderDnD(theadEl, driverOffset, checkboxOffset){
  const table = theadEl.closest('table');
  if(!table || !theadEl || !theadEl.rows || !theadEl.rows.length) return;
  const tr = theadEl.rows[0];

  // Helper: key for a header cell (supports data-key, Driver, and the blank checkbox)
  function headerKey(th, idx){
    if(th.dataset && th.dataset.key) return th.dataset.key;
    const txt = (th.textContent||'').trim();
    if(txt==='Driver') return 'DRIVER';
    if(txt==='' && idx===0) return 'CHECK';
    return txt || ('COL_'+idx);
  }
  // Helper: move a column across header + all body rows
  function moveColumn(from, to){
    if(from===to || from<0 || to<0) return;
    const moveInRow = (row, f, t) => {
      const cell = row.children[f];
      if(!cell) return;
      if(t >= row.children.length) row.appendChild(cell);
      else row.insertBefore(cell, row.children[t]);
    };
    moveInRow(tr, from, to);
    Array.from(table.tBodies).forEach(tb => Array.from(tb.rows).forEach(r => moveInRow(r, from, to)));
  }
  // Apply saved order (global across tabs), if present
  try{
    const saved = JSON.parse(localStorage.getItem('ccl_col_order_all')||'[]');
    if(Array.isArray(saved) && saved.length){
      // Build current keys
      const ths = Array.from(tr.children);
      const keys = ths.map((th, i)=>headerKey(th, i));
      // Reorder to match saved sequence for keys we have
      const desired = [];
      const used = new Set();
      saved.forEach(k=>{
        const idx = keys.indexOf(k);
        if(idx>-1 && !used.has(idx)){ desired.push(idx); used.add(idx); }
      });
      // Append any missing columns in their current order
      keys.forEach((k, idx)=>{ if(!used.has(idx)) desired.push(idx); });
      // Execute moves to reach desired order
      let mapping = desired.slice();
      for(let to=0; to<mapping.length; to++){
        let from = mapping.indexOf(to);
        if(from===-1 || from===to) continue;
        moveColumn(from, to);
        const val = mapping[from];
        mapping.splice(from,1);
        mapping.splice(to,0,val);
      }
    }
  }catch(_){}

  // Enable drag on EVERY header (including Driver + checkbox)
  Array.from(tr.children).forEach((th, i) => {
    th.classList.add('colhdr');
    th.onmousedown = (e) => {
      e.preventDefault();
      const dragTh = th;
      dragTh.classList.add('dragging');

      const onMove = (ev) => {
        const headers = Array.from(tr.children);
        // Find insertion point by midpoint comparison
        let target = null;
        for(const cand of headers){
          if(cand===dragTh) continue;
          const rect = cand.getBoundingClientRect();
          const mid = rect.left + rect.width/2;
          if(ev.clientX < mid){ target = cand; break; }
        }
        headers.forEach(h => h.classList.remove('drop-target'));
        if(target) target.classList.add('drop-target');

        const fromIndex = headers.indexOf(dragTh);
        const toIndex = target ? headers.indexOf(target) : headers.length;
        if(fromIndex!==toIndex){
          moveColumn(fromIndex, toIndex);
        }
      };

      const onUp = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        dragTh.classList.remove('dragging');
        tr.querySelectorAll('.drop-target').forEach(x=>x.classList.remove('drop-target'));
        // Save new global order: include special DRIVER/CHECK tokens and data keys
        const newKeys = Array.from(tr.children).map((el, idx)=>headerKey(el, idx));
        try{ localStorage.setItem('ccl_col_order_all', JSON.stringify(newKeys)); }catch(_){}
      };

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    };
  });
}

    // ---------- RENDERERS ----------
    function renderPickups(){
      const table=document.querySelector('#section_pickups table');
      const body=document.getElementById('p1_body'); body.innerHTML='';
      buildHeader(table.tHead, true, true);
      pickups.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked=state.selectedPickups.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          if(cb.checked){ state.selectedPickups.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedPickups.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        // Driver cell (Pickups has no assigned driver yet)
        (function(){ 
          var drec = drivers.find(function(d){ return d.id===a.driverId; });
          var dname = drec ? drec.name : '—';
          const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname || '—'); 
          tr.appendChild(tdDriver);
        })();
        buildRowCells(tr, a, 'Open');
        tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges(); syncActionButtons();
    }

    function renderDrivers(){
      const body=document.getElementById('drv_body'); body.innerHTML='';
      const source = (state.currentTab==='completed') ? completed : assigned;
      const counts=source.reduce(function(m,a){ m[a.driverId]=(m[a.driverId]||0)+1; return m; },{});
      drivers.forEach(function(d){
        const tr=document.createElement('tr');
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedDriver===d.id;
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          state.selectedDriver = cb.checked ? d.id : null;
          var boxes=document.querySelectorAll('#drv_body input[type="checkbox"]');
          boxes.forEach(function(x){ if(x!==cb){ x.checked=false; x.classList.remove('active'); var row = x.closest ? x.closest('tr') : null; if(row){ row.classList.remove('selected'); } }});
          if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); } else { tr.classList.remove('selected'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        const load=counts[d.id]||0;
        
    // New columns: ID, Driver, MSG, Status, ETA, Elaps Time
    const tdId=document.createElement('td'); tdId.textContent=(d.empId||"—"); tr.appendChild(tdId);
    
    const tdAcc=document.createElement('td'); tdAcc.className='acc-hrs'; tdAcc.textContent=(d._accHrsStr||'—');
    if(d._accOver){ tdAcc.classList.add('over'); } else { tdAcc.classList.add('ok'); }
    tr.appendChild(tdAcc);
const tdName=document.createElement('td'); tdName.textContent=d.name; tr.appendChild(tdName);
    const tdMsg=document.createElement('td'); tdMsg.className='msg-cell';
    tdMsg.innerHTML='<button class="msg-btn" title="Message driver" data-emp="'+(d.empId||'')+'">'+
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">'+
      '<rect x="3" y="5" width="18" height="14" rx="3" stroke="currentColor" stroke-width="1.5"/>'+
      '<path d="M5 7l7 6 7-6" stroke="currentColor" stroke-width="1.5" fill="none"/></svg></button>';
    tr.appendChild(tdMsg);
    const tdStatus=document.createElement('td'); tdStatus.textContent=(d.status||"AVL"); tr.appendChild(tdStatus);
    const tdEta=document.createElement('td'); tdEta.className='eta'; tdEta.textContent=(d.etaStr||"—"); tr.appendChild(tdEta);
    const tdEl=document.createElement('td'); tdEl.className='elapsed'; tdEl.textContent=(d._elapsedStr||"—"); if(d._isLate) tdEl.classList.add('late'); tr.appendChild(tdEl);
tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
    }

    function renderAssigned(){
      const table=document.querySelector('#section_assigned table');
      const body=document.getElementById('assigned_body'); body.innerHTML='';
      buildHeader(table.tHead, true, true);
      assigned.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked=state.selectedAssigned.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change',function(){
          if(cb.checked){ state.selectedAssigned.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedAssigned.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Assigned');
        tr.addEventListener('click',function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges(); syncActionButtons();
    }

    function renderCompleted(){
      const table=document.querySelector('#section_completed table');
      const body=document.getElementById('completed_body'); if(!body) return; body.innerHTML='';
      buildHeader(table.tHead, true, true);
      completed.forEach(function(a){
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        // Checkbox (display-only; no selection logic needed here)
        const td0_c=document.createElement('td');
        const cb_c=document.createElement('input'); cb_c.type='checkbox'; cb_c.className='chk';
        td0_c.appendChild(cb_c); tr.appendChild(td0_c);
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Completed');
        body.appendChild(tr);
      });
      updateBadges();
    }


    function renderInprogress(){
      const table=document.querySelector('#section_inprogress table');
      if(!table) return;
      const body=document.getElementById('inprogress_body'); if(!body) return;
      body.innerHTML='';
      if(typeof inprogress==='undefined' || !Array.isArray(inprogress)){ window.inprogress = []; }
      buildHeader(table.tHead, true, true);
      inprogress.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        // Checkbox with selection state
        const td0=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedInprogress.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change', function(){
          if(cb.checked){ state.selectedInprogress.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedInprogress.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
          syncActionButtons();
        });
        td0.appendChild(cb); tr.appendChild(td0);
        // Driver cell
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        // Cells
        buildRowCells(tr, a, 'In-Progress');
        tr.addEventListener('click', function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
      updateBadges();
    }


    function renderPending(){
      const table=document.querySelector('#section_pending table');
      const body=document.getElementById('pending_body'); if(!body) return; body.innerHTML='';
      buildHeader(table.tHead, true, true); // include driver col in Main Dispatch
      try{
        var hdrRow = table.tHead && table.tHead.rows && table.tHead.rows[0];
        if(hdrRow && hdrRow.cells && hdrRow.cells.length > 1){
          var cell = hdrRow.cells[1];
          var label = (cell.textContent||'').trim();
          if(label !== 'Job #'){ cell.textContent = 'Job #'; }
        }
      }catch(_){}
      try{
        // Rename the 2nd header cell ("Driver") to "Job #", only for Main Dispatch
        var hdrRow = table.tHead && table.tHead.rows && table.tHead.rows[0];
        if(hdrRow && hdrRow.cells && hdrRow.cells.length > 1){
          var cell = hdrRow.cells[1];
          // Only change if it currently says "Driver"
          var txt = (cell.textContent||'').trim().toLowerCase();
          if(txt === 'driver'){ cell.textContent = 'Job #'; }
        }
      }catch(_){}
      pending.forEach(function(a){
        const tr=document.createElement('tr');
        tr.dataset.id = a.id;
        const td0=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
        cb.checked = state.selectedPending.has(a.id);
        if(cb.checked){ cb.classList.add('active'); tr.classList.add('selected'); }
        cb.addEventListener('change', function(){
          if(cb.checked){ state.selectedPending.add(a.id); tr.classList.add('selected'); cb.classList.add('active'); }
          else { state.selectedPending.delete(a.id); tr.classList.remove('selected'); cb.classList.remove('active'); }
        });
        td0.appendChild(cb); tr.appendChild(td0);
        var drec = drivers.find(function(d){ return d.id===a.driverId; });
        var dname = drec ? drec.name : '—';
        const tdDriver=document.createElement('td'); tdDriver.textContent=(a.driverName || dname); tr.appendChild(tdDriver);
        buildRowCells(tr, a, 'Pending');
        tr.addEventListener('click', function(e){ if(e.target.tagName.toLowerCase()==='input') return; cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); });
        body.appendChild(tr);
      });
    }

    // ---------- ALERT MODAL ----------
    function openAlert(msg){ const m=document.getElementById('alert_modal'); const t=document.getElementById('alert_text'); if(t) t.textContent=msg; if(m) m.style.display='flex'; }
    function closeAlert(){ const m=document.getElementById('alert_modal'); if(m) m.style.display='none'; }

    
    
    // ---------- INLINE EDIT (DBLCLICK) ----------
    // Edit in place, and lock the column key on the TD to prevent any misalignment.
    document.addEventListener('dblclick', function(e){
      const td = e.target.closest('td'); if(!td) return;
      const table = td.closest('table'); if(!table || !table.tHead || !table.tHead.rows.length) return;
      const tr = td.parentElement;
      const section = td.closest('section'); if(!section) return;

      // Header + column key
      const theadTr = table.tHead.rows[0];
      const cellIndex = Array.from(tr.children).indexOf(td);
      const th = theadTr.children[cellIndex];
      const headerText = th ? (th.textContent||'').trim() : '';
      const keyAttr = th && th.dataset ? th.dataset.key : null;
      const colKey = (td.dataset.colKey) || keyAttr || (headerText ? headerText.toLowerCase().replace(/[^a-z0-9]+/g,'_') : '');
      td.dataset.colKey = colKey;

      // Skip ONLY the checkbox column
      if(headerText==='' && cellIndex===0) return;

      // Resolve dataset by section
      let arr=null, sectionStatus=null, sid=section.id;
      if(sid==='section_pickups'){ arr=pickups; sectionStatus='Open'; }
      else if(sid==='section_assigned'){ arr=assigned; sectionStatus='Assigned'; }
      else if(sid==='section_completed'){ arr=completed; sectionStatus='Completed'; }
      else if(sid==='section_pending'){ arr=pending; sectionStatus='Pending'; }
      else { return; }

      // Locate record
      const rowId = tr.dataset ? tr.dataset.id : null;
      let rec = null;
      if(rowId){ rec = (arr||[]).find(x => x.id===rowId) || null; }
      if(!rec){
        const idx = Array.from(tr.parentElement.children).indexOf(tr);
        rec = (arr && arr[idx]) ? arr[idx] : null;
      }
      if(!rec) return;

      // Create inline input
      const oldHTML = td.innerHTML;
      const oldText = td.textContent.trim();
      const input = document.createElement('input');
      input.type='text';
      input.value = oldText;
      input.style.width='100%';
      input.style.background='#0f172a';
      input.style.border='1px solid #243045';
      input.style.borderRadius='8px';
      input.style.padding='6px 8px';
      input.style.color='#e2e8f0';
      td.innerHTML='';
      td.appendChild(input);
      input.focus();
      input.selectCustomer();

      let pendingValue = oldText;
      input.addEventListener('input', () => { pendingValue = input.value; });

      function renderCellInPlace(){
        if(colKey==='status'){
          if(typeof statusPill==='function'){
            td.innerHTML = statusPill(rec.status) || (rec.status || '—');
          } else {
            td.textContent = rec.status || '—';
          }
          return;
        }
        if(colKey==='driver'){
          const drec = drivers.find(x=>x.id===rec.driverId);
          const dname = drec ? drec.name : '—';
          td.textContent = (rec.driverName || dname);
          return;
        }
        if(typeof cellFor==='function'){
          td.innerHTML = cellFor(rec, colKey, sectionStatus);
        } else {
          td.textContent = rec[colKey] ?? '';
        }
      }

      function applyChange(){
        const newVal = (pendingValue||'').trim();
        if(colKey==='status'){
          rec.status = newVal;
        } else if(colKey==='driver'){
          const d = drivers.find(drv => (drv.name||'').toLowerCase() === newVal.toLowerCase());
          if(d){ rec.driverId = d.id; delete rec.driverName; }
          else { rec.driverName = newVal; }
        } else {
          rec[colKey] = newVal;
        }
        renderCellInPlace();
        // subtle confirm flash
        td.classList.add('ring-2','ring-blue-500/60');
        setTimeout(()=>td.classList.remove('ring-2','ring-blue-500/60'), 500);
      }

      input.addEventListener('blur', function(){
        if(pendingValue===oldText){ td.innerHTML = oldHTML; return; }
        openConfirm('Save change to '+(COLUMN_LABELS[colKey]||headerText||'field')+'?\n\nOld: '+oldText+'\nNew: '+pendingValue, applyChange);
      });
      input.addEventListener('keydown', function(ev){
        if(ev.key==='Enter'){ input.blur(); }
        if(ev.key==='Escape'){ pendingValue=oldText; input.blur(); }
      });
    });
    
    // ---------- EDIT MODAL (clean) ----------
    const editModal = document.getElementById('edit_modal');
    const eFrom = document.getElementById('e_from');
    const eTo = document.getElementById('e_to');
    const eContainer = document.getElementById('e_container');
    const eLoadEmpty = document.getElementById('e_loadempty');
    const eBkPin = document.getElementById('e_bkpin');
    const eImpExp = document.getElementById('e_impexp');
    const eSeal = document.getElementById('e_seal');
    const eWindow = document.getElementById('e_window');
    const eInstruction = document.getElementById('e_instruction');
    // Local dropdowns (to remove OS checkmark and add border)
    function initDropdown(triggerId, menuId, inputEl){
      const trigger = document.getElementById(triggerId);
      const menu = document.getElementById(menuId);
      if(!trigger || !menu || !inputEl) return;
      function close(){ menu.classList.add('hidden'); document.removeEventListener('click', onDoc); }
      
// ===== Initialize the custom dropdowns (applies to ALL Edit modals) =====
document.addEventListener('DOMContentLoaded', function(){
  try{
    initDropdown('dd_loadempty','menu_loadempty', eLoadEmpty);
    initDropdown('dd_impexp','menu_impexp', eImpExp);
    // Default trigger labels
    var t1=document.getElementById('dd_loadempty'); if(t1 && !t1.textContent.trim()) t1.textContent='Select…';
    var t2=document.getElementById('dd_impexp');   if(t2 && !t2.textContent.trim()) t2.textContent='Select…';
  }catch(_){ /* no-op */ }
});
// ======================================================================
function onDoc(e){ if(!menu.contains(e.target) && e.target!==trigger) close(); }
      trigger.onclick = () => {
        menu.classList.toggle('hidden');
        if(!menu.classList.contains('hidden')) document.addEventListener('click', onDoc);
      };
      menu.querySelectorAll('[data-val]').forEach(item => {
        item.onclick = () => { inputEl.value=item.dataset.val; trigger.textContent=item.textContent; close(); };
      });
    }


    function clearEditFields(){
      eFrom.value=''; eTo.value=''; eContainer.value=''; eLoadEmpty.value=''; eBkPin.value='';
      eImpExp.value=''; eSeal.value=''; eWindow.value=''; eInstruction.value='';
    }
    try{ const a=document.getElementById('dd_loadempty'); if(a) a.textContent='Select…'; }catch(_){}
    try{ const b=document.getElementById('dd_impexp'); if(b) b.textContent='Select…'; }catch(_){}
    
    function closeEdit(){ editModal.style.display='none'; }

    function openEdit(){
      let arr=null, selId=null, title='Edit Job';
      if(state.currentTab==='pending'){
        if(state.selectedPending.size!==1){ toast('Select exactly 1 row in Main Dispatch to edit'); return; }
        arr=pending; selId=[...state.selectedPending][0]; title='Edit Main Dispatch';
      } else if(state.currentTab==='inprogress'){
        if(state.selectedInprogress.size!==1){ toast('Select exactly 1 In‑Progress row'); return; }
        arr=(window.inprogress||[]); selId=[...state.selectedInprogress][0]; title='Edit In‑Progress';
      } else {
        return;
      }
      state.editScope = (state.currentTab==='pending') ? 'pending' : 'inprogress';
      state.editOriginalId = selId;
      const rec = arr.find(r=>r.id===selId) || {};
      document.getElementById('edit_title').textContent = title;
      document.getElementById('e_jobpill').textContent = (rec.id||'Job #') + (rec.window?(' • '+rec.window):'');
      
// Prefill fields from record (and DOM fallback)
try{
  // If selection set is empty, allow checkbox-based selection
  if((!selId || (state && state.selectedPending && state.selectedPending.size!==1)) && document.querySelector('#section_pending tbody input[type="checkbox"]:checked')){
    var rEl = document.querySelector('#section_pending tbody input[type="checkbox"]:checked').closest('tr');
    if(rEl) { selId = rEl.getAttribute('data-id'); state.selectedPending = new Set([selId]); rec = arr.find(r=>r.id===selId) || rec; }
  }
  eFrom.value = (rec.from||''); 
  eTo.value = (rec.to||'');
  eContainer.value = (rec.container||'');
  eLoadEmpty.value = (rec.appt||'');
  var ddLE = document.getElementById('dd_loadempty'); if(ddLE){ ddLE.textContent = eLoadEmpty.value || ddLE.textContent || 'Select…'; }
  eBkPin.value = (rec.bk||'');
  eImpExp.value = (rec.ie||'');
  var ddIE = document.getElementById('dd_impexp'); if(ddIE){ ddIE.textContent = eImpExp.value || ddIE.textContent || 'Select…'; }
  eSeal.value = (rec.seal||'');
  eWindow.value = (rec.window||'');
  eInstruction.value = (rec.remark||'');

  // Fallback: read from row cells if any field is still blank
  (function(){
    var rowEl = document.querySelector('#section_pending tbody tr[data-id="'+selId+'"]');
    if(!rowEl) return;
    var byKey = {}; Array.from(rowEl.children).forEach(function(td){ if(td.dataset && td.dataset.colKey){ byKey[td.dataset.colKey] = (td.textContent||'').trim(); } });
    function fillIfEmpty(inputId, key){
      var el=document.getElementById(inputId); if(!el) return;
      if(!el.value || !el.value.trim()){ var v=(byKey[key]||''); el.value = (v==='—')? '' : v; }
    }
    fillIfEmpty('e_from','from'); fillIfEmpty('e_to','to'); fillIfEmpty('e_container','container');
    fillIfEmpty('e_loadempty','appt'); if(ddLE){ ddLE.textContent = document.getElementById('e_loadempty').value || ddLE.textContent || 'Select…'; }
    fillIfEmpty('e_bkpin','bk'); fillIfEmpty('e_impexp','ie'); if(ddIE){ ddIE.textContent = document.getElementById('e_impexp').value || ddIE.textContent || 'Select…'; }
    fillIfEmpty('e_seal','seal'); fillIfEmpty('e_window','window'); fillIfEmpty('e_instruction','remark');
  })();
}catch(_){}

      editModal.classList.add('no-anim');
      editModal.style.display='flex';
      setTimeout(function(){ try{ editModal.classList.remove('no-anim'); }catch(_){}} , 160);
// Ensure dropdowns are (re)initialized each time the modal opens
try{
  initDropdown('dd_loadempty','menu_loadempty', eLoadEmpty);
  initDropdown('dd_impexp','menu_impexp', eImpExp);
  var t1=document.getElementById('dd_loadempty'); if(t1 && !t1.textContent.trim()) t1.textContent='Select…';
  var t2=document.getElementById('dd_impexp');   if(t2 && !t2.textContent.trim()) t2.textContent='Select…';
}catch(_){}
}

    document.getElementById('btn_edit_pending')?.addEventListener('click', openEdit);
    document.getElementById('btn_ip_edit')?.addEventListener('click', openEdit);

    document.getElementById('btn_modal_cancel').addEventListener('click', function(){
      openConfirm('Cancel changes?', function(){ closeEdit(); });
    });

    document.getElementById('btn_modal_update').addEventListener('click', function(){
      let arr=null, render=null, okMsg='Updated';
      if(state.editScope==='pending'){ arr=pending; render=renderPending; okMsg='Main Dispatch updated'; }
      else if(state.editScope==='inprogress'){ arr=(window.inprogress||[]); render=renderInprogress; okMsg='In‑Progress updated'; }
      else { closeEdit(); return; }
      const rec = arr.find(r=>r.id===state.editOriginalId); if(!rec){ closeEdit(); return; }

      const updates = {
        from: eFrom.value.trim(),
        to: eTo.value.trim(),
        container: eContainer.value.trim(),
        appt: eLoadEmpty.value.trim(), // store LOAD/EMPTY into existing 'appt' field to avoid schema changes
        bk: eBkPin.value.trim(),
        ie: eImpExp.value.trim(),
        seal: eSeal.value.trim(),
        window: eWindow.value.trim(),
        remark: eInstruction.value.trim()
      };
      openConfirm('Save changes to this job?', function(){
        Object.entries(updates).forEach(([k,v])=>{ if(v!=='') rec[k]=v; });
        closeEdit(); render(); renderDrivers(); updateBadges(); syncActionButtons(); toast(okMsg);
        try{
          if(typeof window.driverAppNotify==='function'){
            window.driverAppNotify({type:'job-edit', id:rec.id, fields:updates});
          }
          window.dispatchEvent(new CustomEvent('job-edit',{detail:{id:rec.id,fields:updates}}));
        }catch(_){}
        state.editScope=null;
      });
    });

    // ---------- CONFIRM ----------
    function openConfirm(msg, onYes){
      const m=document.getElementById('confirm_modal');
      const t=document.getElementById('confirm_text');
      const yes=document.getElementById('confirm_yes');
      const no=document.getElementById('confirm_no');
      t.textContent=msg;
      function cleanup(){ yes.replaceWith(yes.cloneNode(true)); no.replaceWith(no.cloneNode(true)); }
      m.style.display='flex';
      m.querySelector('#confirm_yes').addEventListener('click', function(){ m.style.display='none'; cleanup(); if(onYes) onYes(); });
      m.querySelector('#confirm_no').addEventListener('click', function(){ m.style.display='none'; cleanup(); });
    }

    // ---------- ACTIONS ----------
    document.addEventListener('click', function(e){
      // Assign (Pickups -> Assigned)
      if(e.target && e.target.id==='btn_assign'){
        const driver=drivers.find(function(d){ return d.id===state.selectedDriver; });
        if(!driver || state.selectedPickups.size===0) return;
        const ids=[...state.selectedPickups];
        ids.forEach(function(id){
          const idx=pickups.findIndex(function(p){ return p.id===id; });
          if(idx>-1){
            const item=pickups.splice(idx,1)[0];
            assigned.push(Object.assign({}, item, {driverId: driver.id, status:'Assigned'}));
          }
        });
        state.selectedPickups.clear();
        state.selectedDriver=null;
        renderPickups(); renderAssigned(); renderDrivers();
        updateBadges(); syncActionButtons();
        switchTab('assigned');
        toast('Assigned to driver');
      }

      // Remove (Assigned -> Pickups)
      if(e.target && e.target.id==='btn_remove'){
        if(state.selectedAssigned.size===0) return;
        const ids=[...state.selectedAssigned];
        ids.forEach(function(id){
          const idx=assigned.findIndex(function(a){ return a.id===id; });
          if(idx>-1){
            const item=assigned.splice(idx,1)[0];
            const rest={ id:item.id, from:item.from, to:item.to, container:item.container, appt:item.appt, bk:item.bk, window:item.window, status:'Open' };
            pickups.push(rest);
          }
        });
        state.selectedAssigned.clear();
        renderPickups(); renderAssigned(); renderDrivers();
        updateBadges(); syncActionButtons();
        toast('Returned to Pickups');
      }

      // Update Driver (Assigned -> Completed), safeguard mismatch
      if(e.target && e.target.id==='btn_update'){
        const driver=drivers.find(function(d){ return d.id===state.selectedDriver; });
        if(!driver || state.selectedAssigned.size===0) return;
        const ids=[...state.selectedAssigned];
        const mismatches=[];
        ids.forEach(function(id){
          const row=assigned.find(function(x){ return x.id===id; });
          if(row && row.driverId!==driver.id){
            var _dcur = drivers.find(function(d){ return d.id===row.driverId; });
            var currentName = _dcur ? _dcur.name : 'Unknown';
            mismatches.push(row.id+' is assigned to '+currentName);
          }
        });
        if(mismatches.length>0){
          openAlert('You selected '+driver.name+', but:\\n\\n• '+mismatches.join('\\n• ')+'\\n\\nSelect the driver that matches the Assigned rows to proceed.');
          return;
        }
        let moved=0;
        ids.forEach(function(id){
          const idx=assigned.findIndex(function(x){ return x.id===id; });
          if(idx>-1){
            const row=assigned.splice(idx,1)[0];
            row.status='In-Progress';
            if(typeof inprogress==='undefined' || !Array.isArray(inprogress)){ window.inprogress = []; }
            inprogress.push(row);
            moved++;
          }
        });
        state.selectedAssigned.clear();
        state.selectedDriver=null;
        renderAssigned(); renderInprogress(); renderDrivers();
        updateBadges(); syncActionButtons();
        switchTab('inprogress');
        toast('Notified '+driver.name+': '+moved+' pickup(s) moved to In‑Progress');
      }

      
      // In-Progress -> Pickups (dispatcher removes from phone app list)
      if(e.target && e.target.id==='btn_ip_move'){
        if(state.selectedInprogress.size===0){ toast('Select at least 1 In‑Progress row'); return; }
        openConfirm('Move selected pickup(s) back to Pickups?', function(){
          const ids=[...state.selectedInprogress];
          ids.forEach(function(id){
            const idx=(inprogress||[]).findIndex(function(x){ return x.id===id; });
            if(idx>-1){
              const row=inprogress.splice(idx,1)[0];
              const rest={ id:row.id, from:row.from, to:row.to, container:row.container, appt:row.appt, bk:row.bk, window:row.window, status:'Open' };
              pickups.push(rest);
            }
          });
          state.selectedInprogress.clear();
          renderPickups(); renderInprogress(); updateBadges(); syncActionButtons();
          switchTab('pickups');
          toast('Moved back to Pickups');
        });
      }


      // Move (Pickups -> Pending) WITH CONFIRM
      if(e.target && e.target.id==='btn_move'){
        if(state.selectedPickups.size===0){ toast('Select at least 1 pickup to move'); return; }
        openConfirm('Move selected pickup(s) to Main Dispatch?', function(){
          const ids=[...state.selectedPickups];
          ids.forEach(function(id){
            const idx=pickups.findIndex(function(p){ return p.id===id; });
            if(idx>-1){
              const item=pickups.splice(idx,1)[0];
              pending.push(Object.assign({}, item, { status:'Pending' }));
            }
          });
          state.selectedPickups.clear();
          renderPickups(); renderPending();
          updateBadges(); syncActionButtons();
          switchTab('pending');
          toast('Moved to Main Dispatch');
        });
      }
    });

    // Pending -> Pickups (with confirm)
    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='btn_move_from_pending'){
        if(state.selectedPending.size===0){ toast('Select at least 1 pending pickup'); return; }
        openConfirm('Move selected pickup(s) to Pickups?', function(){
          const ids=[...state.selectedPending];
          ids.forEach(function(id){
            const idx=pending.findIndex(function(p){ return p.id===id; });
            if(idx>-1){
              const item=pending.splice(idx,1)[0];
              pickups.push(Object.assign({}, item, { status:'Open' }));
            }
          });
          state.selectedPending.clear();
          renderPickups(); renderPending();
          updateBadges();
          switchTab('pending');
          toast('Moved to Pickups');
        });
      }
    });

    // Create New under Main Dispatch
    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='btn_create_pending'){
        state.createMode = 'pending';
        state.editOriginalId = null;
        document.getElementById('edit_title').textContent = 'Create Pickup';
        document.getElementById('f_jobpill').textContent = 'New Job';
        fFrom.value = ''; fLoadIn.value=''; fContainer.value=''; fAppt.value=''; fBk.value=''; fWindow.value=''; fInstruction.value='';
        editModal.style.display='flex';
      }
    });

    // ---------- Driver App Hook ----------
    // Call window.driverComplete(['CCL-5001','CCL-5002']) from the phone app to auto-complete.
    window.driverComplete = function(ids){
      try{
        if(typeof ids==='string'){ ids=[ids]; }
        if(!Array.isArray(ids) || ids.length===0) return false;
        let moved=0;
        ids.forEach(function(id){
          const idx=(inprogress||[]).findIndex(function(x){ return x.id===id; });
          if(idx>-1){
            const row=inprogress.splice(idx,1)[0];
            row.status='Completed';
            completed.push(row);
            moved++;
          }
        });
        if(moved>0){
          renderInprogress(); renderCompleted(); updateBadges();
          return true;
        }
        return false;
      }catch(_){ return false; }
    };

    // ---------- TABS ----------
    function switchTab(which){
      document.getElementById('section_pickups').classList.toggle('hidden',which!=='pickups');
      document.getElementById('section_assigned').classList.toggle('hidden',which!=='assigned');
      var _sip=document.getElementById('section_inprogress'); if(_sip) _sip.classList.toggle('hidden',which!=='inprogress');
      document.getElementById('section_completed').classList.toggle('hidden',which!=='completed');
      document.getElementById('section_pending').classList.toggle('hidden',which!=='pending');
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      if(which==='pickups') document.getElementById('tab_pickups').classList.add('active');
      if(which==='assigned') document.getElementById('tab_assigned').classList.add('active');
      if(which==='inprogress') document.getElementById('tab_inprogress')?.classList.add('active');
      if(which==='completed') document.getElementById('tab_completed').classList.add('active');
      if(which==='pending') document.getElementById('tab_pending').classList.add('active');
      state.currentTab = which;
      if(which==='inprogress'){ try{ renderInprogress(); }catch(e){} }
      // Hide Drivers panel on Main Dispatch
      var drvSec=document.getElementById('section_drivers_bottom'); if(drvSec){ drvSec.classList.toggle('hidden', which==='pending'); }
      renderDrivers();
    }

    // ---------- INIT ----------
    function init(){
      renderPickups(); renderDrivers(); renderAssigned(); renderCompleted(); renderPending(); renderInprogress();
      updateBadges(); syncActionButtons();
      switchTab('pending'); // start on Main Dispatch per your request
    }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  // HEADER RENAME (dblclick)

// HEADER RENAME (dblclick): confirm and update label text only (no key/logic changes)
document.addEventListener('dblclick', function(e){
  const th = e.target.closest('th.colhdr'); if(!th) return;
  const key = th.dataset && th.dataset.key; if(!key) return;
  const oldName = (th.textContent||'').trim();
  const typed = prompt('Rename header:', oldName);
  if(typed==null) return;
  const next = (typed||'').trim();
  if(!next || next===oldName) return;
  if(typeof openConfirm==='function'){
    openConfirm('Change "'+oldName+'" to "'+next+'"?', function(){ COLUMN_LABELS[key]=next; th.textContent=next; });
  } else { COLUMN_LABELS[key]=next; th.textContent=next; }
});
</script>
<script>
(function(){
  function ready(fn){ 
    if(document.readyState!=='loading') fn(); 
    else document.addEventListener('DOMContentLoaded', fn); 
  }
  ready(function(){
    var btn = document.getElementById('tab_drivergps');
    if(!btn) return;

    // Config you can tweak
    const PREFS = {
      mapQuery: 'Port of Long Beach',
      mapZoom: 13
    };

    function buildGpsHtml(){
      const q = encodeURIComponent(PREFS.mapQuery);
      const z = Math.max(3, Math.min(PREFS.mapZoom, 20));
      const embedSrc = `https://www.google.com/maps?q=${q}&z=${z}&output=embed`;
      return `<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Driver GPS — Coastal City Logistics</title>
<style>
  html,body{height:100%;margin:0;background:#0b1220;color:#e5eefb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .top{padding:10px 14px;background:#0f172a;border-bottom:1px solid #243045;font-weight:600}
  .wrap{position:fixed;inset:46px 8px 8px 8px}
  iframe{width:100%;height:100%;border:1px solid #243045;border-radius:14px}
</style>
<style>
/* --- Stop funnel icon flipping --- */
#section_drivers_bottom thead th.active-sort.asc .sort-btn svg,
#section_drivers_bottom thead th.active-sort.desc .sort-btn svg{
  transform:none !important;
}
</style>

<style>
/* === FORCE-HIDE FILTER ICONS on specific Driver columns ===
   Drivers header order:
   1: Checkbox | 2: ID | 3: Acc Hrs | 4: Driver | 5: MSG | 6: Status | 7: ETA | 8: Elaps Time
   Hide on 1,2,3,5,7,8 (keep Driver + Status).
*/
#section_drivers_bottom thead th:nth-child(1) .sort-btn,
#section_drivers_bottom thead th:nth-child(2) .sort-btn,
#section_drivers_bottom thead th:nth-child(3) .sort-btn,
#section_drivers_bottom thead th:nth-child(5) .sort-btn,
#section_drivers_bottom thead th:nth-child(7) .sort-btn,
#section_drivers_bottom thead th:nth-child(8) .sort-btn { display: none !important; }
#section_drivers_bottom thead th:nth-child(1) svg,
#section_drivers_bottom thead th:nth-child(2) svg,
#section_drivers_bottom thead th:nth-child(3) svg,
#section_drivers_bottom thead th:nth-child(5) svg,
#section_drivers_bottom thead th:nth-child(7) svg,
#section_drivers_bottom thead th:nth-child(8) svg { display: none !important; }
</style>


<!-- Center cells for Main Dispatch rows (applies to new and existing) -->
<style id="ccl-center-cells">
  /* Main Dispatch only */
  #section_pending tbody td,
  #section_pending tbody th {
    text-align: center !important;
    vertical-align: middle !important;
  }
  /* Keep the very first checkbox column centered and compact */
  #section_pending tbody td:first-child {
    width: 40px;
    text-align: center !important;
  }
</style>
<style id="create_modal_compact_v1">
/* === Create Modal: 35% overall size reduction (no font-size changes) === */
#create_modal .box{ width:62vw !important; height:60vh !important; }
#create_modal .hdr{ padding:8px 12px !important; }
#create_modal .content{ padding:10px !important; }
#create_modal .grid3{ gap:8px !important; }
#create_modal .panel{ padding:8px !important; border-radius:14px !important; }
#create_modal label{ margin-bottom:3px !important; }
#create_modal input, #create_modal textarea{ padding:6px 8px !important; min-height:32px !important; }
#create_modal textarea{ min-height:64px !important; }
#create_modal .actions{ padding:8px 12px !important; gap:8px !important; }
#create_modal .btn{ padding:8px 12px !important; border-radius:10px !important; }
</style>
<style id="create_modal_compact_v2">
/* === Create Modal: Extra 10% compression (excluding From/To/Customer) === */
#create_modal .grid3 > div:not(:has(#c_from)):not(:has(#c_to)):not(:has(#c_customer)){
  flex: 1 1 0;
  max-width: 85% !important;
}
#create_modal input, #create_modal textarea{
  padding:5px 7px !important;
}
#create_modal .panel{ padding:6px !important; }
</style>
<style id="create_modal_grow_13">
/* === Create Modal: +13% size tweak (no font change) === */
#create_modal .box{ width:70vw !important; height:68vh !important; }
#create_modal .hdr{ padding:10px 14px !important; }
#create_modal .content{ padding:12px !important; }
#create_modal .panel{ padding:9px !important; }
</style>
<style id="customer_btn_compact_ios">
/* === Customer dropdown buttons: compact + iPhone blue === */
#c_btn_save_customer{ padding:4px 10px !important; border-radius:10px !important; background:var(--ios) !important; border-color:var(--ios) !important; }
#c_btn_save_customer:hover{ background:var(--ios-hover) !important; }
#c_btn_delete_customer{ padding:4px 10px !important; border-radius:10px !important; }
</style>
<style id="customer_btn_shrink30">
/* === Customer dropdown buttons smaller by 30% === */
#c_btn_save_customer, #c_btn_delete_customer{
  font-size: 0.8em !important;
  padding:3px 8px !important;
  border-radius:8px !important;
}
</style>
<style id="customer_dd_menu_style">
/* === Customer dropdown menu styling === */
.ccl-dd{ position:relative; display:inline-block; width:100%; }
.ccl-dd-trigger{ width:100%; background:#111827; border:1px solid #374151; border-radius:8px; padding:6px 10px; text-align:left; color:#fff; }
.ccl-dd-menu{ position:absolute; top:100%; left:0; right:0; background:#1f2937; border:1px solid #374151; border-radius:8px; max-height:220px; overflow-y:auto; z-index:50; }
.ccl-dd-menu div{ padding:6px 10px; cursor:pointer; }
.ccl-dd-menu div:hover{ background:#2563eb; color:#fff; }
.hidden{ display:none; }
</style>
<style id="customer_dd_menu_height">
/* === Customer dropdown: show at least 10 items === */
.ccl-dd-menu{ max-height: 360px !important; }
</style>
<style id="customer_dd_overlay_10rows">
/* === Customer dropdown: overlay (no clipping) + 10-row view === */
.ccl-dd{ position:relative; overflow:visible; }
.ccl-dd-menu{
  position: fixed !important;   /* detach from clipped parents */
  z-index: 10050 !important;    /* above modals */
  max-height: none !important;
  height: 360px !important;     /* ~10 items */
  overflow-y: auto !important;
  width: auto;                   /* set in JS to match trigger */
  box-shadow: 0 14px 32px rgba(0,0,0,.45);
}
</style>
</head><body>
  <div class="top">Driver GPS • Long Beach Port</div>
  <div class="wrap">
    <iframe loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src="${embedSrc}"></iframe>
  </div>

<script>
(function(){
  const ETA_BASELINES={'DSV':40,'APM TERMINALS':40,'SSA MARINE':35,'FENIX':45,'TRAPAC':30,'EVERPORT':35,'YUSEN':30};
  function baselineForCustomer(n){ if(!n) return 40; const u=String(n).toUpperCase(); for(const k in ETA_BASELINES){ if(u.includes(k)) return ETA_BASELINES[k]; } return 40; }
  function parseCustomer(s){ if(!s) return ''; const m=String(s).replace(/^enoute/i,'Enroute').match(/(?:Enroute|Arrived)\s*(?:To|At)?\s*[:\-]?\s*(.*)$/i); return m&&m[1]?m[1].trim():''; }
  function fmtHM(t){ const d=t instanceof Date?t:new Date(t); if(isNaN(d)) return '—'; const h=String(d.getHours()).padStart(2,'0'), m=String(d.getMinutes()).padStart(2,'0'); return h+':'+m; }
  function fmtElapsed(ms){ if(!ms||ms<0) return '—'; const mm=Math.floor(ms/60000); if(mm<60) return mm+' mins'; const h=Math.floor(mm/60), m=mm%60; return h+'h '+m+'m'; }
  function arr(){ return (typeof drivers!=='undefined'?drivers:(window.drivers=window.drivers||[])); }
  function tick(){
    const a=arr(), now=Date.now();
    a.forEach(d=>{
const s=(d.status||'').trim(), cust=parseCustomer(s);
      if(!d.phase){ d.phase=/^enroute\b/i.test(s)?'ENROUTE':(/^arrived\b/i.test(s)?'ARRIVED':'OTHER'); }
      if(!d.phaseStartedAt && (d.phase==='ENROUTE'||d.phase==='ARRIVED')) d.phaseStartedAt=now;
      if(d.phase==='ENROUTE'){
        const exp=d.expectedMins||baselineForCustomer(cust), start=d.phaseStartedAt||now;
        d.etaStr=fmtHM(start+exp*60000); const el=now-start; d._elapsedStr=fmtElapsed(el); d._isLate=(el/60000) > exp+5; if(d._isLate){ d._elapsedStr = d._elapsedStr + ' (Exp. ' + exp + 'm)'; }
      }else if(d.phase==='ARRIVED'){
        d.etaStr='—'; const el=now-(d.phaseStartedAt||now); d._elapsedStr=fmtElapsed(el); d._isLate=false;
      }else{ d.etaStr='—'; d._elapsedStr='—'; d._isLate=false; }
    
      /* ACCUMULATED HOURS */
      if(d.shiftStartedAt){
        const hrs = (now - d.shiftStartedAt)/3600000;
        const rounded = Math.round(hrs*100)/100;
        d._accHrsStr = String(rounded);
        d._accOver = hrs >= 8;
      } else {
        d._accHrsStr = '—';
        d._accOver = false;
      }
});
if(typeof renderDrivers==='function') renderDrivers();
  }
  setInterval(tick,30000); window.addEventListener('load', ()=>setTimeout(tick,300));
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<!-- DEMO INIT FOR DRIVERS -->
<script>
(function(){
  const now = Date.now();
  try{
    if(Array.isArray(drivers)){
      const byEmp = id => drivers.find(d => String(d.empId)===String(id));
      let d;
      d = byEmp('53939'); if(d){ d.status='Arrived : APM Terminals (Pier 400)'; d.phase='ARRIVED'; d.phaseStartedAt=now-12*60000; }
      d = byEmp('54545'); if(d){ d.status='Enroute : SSA Marine (Pier A)'; d.phase='ENROUTE'; d.phaseStartedAt=now-55*60000; d.expectedMins=35; }
      d = byEmp('554421'); if(d){ d.status='Arrived : Fenix Marine Services (Pier 300)'; d.phase='ARRIVED'; d.phaseStartedAt=now-8*60000; }
      d = byEmp('598771'); if(d){ d.status='Enroute : TraPac Terminal (Pier G)'; d.phase='ENROUTE'; d.phaseStartedAt=now-50*60000; d.expectedMins=30; }
    }
  }catch(_){}
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<!-- DRIVER MESSAGE MODAL -->
<style>
#driverMsgOverlay{ position:fixed; inset:0; background:rgba(2,8,23,.55); display:none; z-index:1000; }
#driverMsgModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1001; }
#driverMsgModal .card{ width:480px; max-width:92vw; background:#0b1322; border:1px solid #1f2a44; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.5); color:#e5edf8; }
#driverMsgModal .hd{ padding:16px 18px; border-bottom:1px solid #1e2a43; font-size:18px; font-weight:700; }
#driverMsgModal .bd{ padding:16px 18px; }
#driverMsgModal label{ display:block; font-size:13px; opacity:.85; margin-bottom:6px; }
#driverMsgModal .to{ margin-bottom:12px; font-weight:600; }
#driverMsgModal textarea{ width:100%; min-height:120px; background:#0a1220; color:#dbeafe; border:1px solid #2a3a5d; border-radius:12px; padding:10px 12px; resize:vertical; }
#driverMsgModal .ft{ display:flex; gap:10px; justify-content:flex-end; padding:14px 18px 18px; }
#driverMsgModal .btn{ height:38px; padding:0 16px; border-radius:10px; border:1px solid #2a3a5d; background:#0f172a; color:#e5edf8; cursor:pointer; }
#driverMsgModal .btn.primary{ background:#0a84ff; color:#ffffff; border:0; font-weight:700; }
#driverMsgModal .btn:hover{ filter:brightness(1.05); }
</style>
<div id="driverMsgOverlay"></div>
<div id="driverMsgModal" role="dialog" aria-modal="true" aria-labelledby="driverMsgTitle">
  <div class="card">
    <div class="hd" id="driverMsgTitle">Message Driver</div>
    <div class="bd">
      <div class="to" id="driverMsgTo">To: —</div>
      <label for="driverMsgText">Message</label>
      <textarea id="driverMsgText" placeholder="Type your message…"></textarea>
    </div>
    <div class="ft">
      <button class="btn" id="driverMsgCancel">Cancel</button>
      <button id="driverMsgSend" style="background-color:#2563eb; color:white; padding:0.5rem 1rem; border-radius:0.5rem;" onmouseover="this.style.backgroundColor=\'#1d4ed8\'" onmouseout="this.style.backgroundColor=\'#2563eb\'">Send</button>
    </div>
  </div>
</div>
<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const overlay = $('#driverMsgOverlay');
  const modal = $('#driverMsgModal');
  const elTo  = $('#driverMsgTo');
  const elText= $('#driverMsgText');
  const btnCancel = $('#driverMsgCancel');
  const btnSend   = $('#driverMsgSend');
  let currentEmp = null;

  function openModal(empId, driverName){
    currentEmp = empId || null;
    elTo.textContent = 'To: ' + (driverName||empId||'—');
    elText.value='';
    overlay.style.display='block';
    modal.style.display='flex';
    elText.focus();
  }
  function closeModal(){
    overlay.style.display='none';
    modal.style.display='none';
  }
  overlay.addEventListener('click', closeModal);
  btnCancel.addEventListener('click', closeModal);
  btnSend.addEventListener('click', function(){
    const msg = elText.value.trim();
    if(!msg) { elText.focus(); return; }
    if(typeof onDriverMessage==='function'){
      try{ onDriverMessage(currentEmp, msg); }catch(_){}
    } else {
      console.log('Send to driver', currentEmp, msg);
    }
    closeModal();
  });

  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('.msg-btn');
    if(!btn) return;
    const emp = btn.getAttribute('data-emp') || '';
    let name = emp;
    try{
      if(Array.isArray(drivers)){
        const d = drivers.find(dd => String(dd.empId)===String(emp));
        if(d) name = d.name || name;
      }
    }catch(_){}
    openModal(emp, name);
  });
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<script>
// DEMO INIT EXTRA ETA
window.addEventListener('load', function(){
  try{
    if(typeof updateDriverETA==='function'){
      updateDriverETA({ employeeId:'54545', minutesRemaining: 6, expectedMins: 35 });
      updateDriverETA({ employeeId:'598771', minutesRemaining: 12, expectedMins: 30 });
    }
  }catch(_){}
});
</script>


<script>(function(){
  const sec=document.querySelector('#section_drivers_bottom');
  if(!sec) return;
  const table=sec.querySelector('table'); if(table){ table.style.minWidth='max-content'; }
  const ths=sec.querySelectorAll('thead th');
  ths.forEach(function(th){
    const grip=document.createElement('span'); grip.className='col-grip'; th.appendChild(grip);
    let startX=0, startW=0;
    function onDown(e){ startX=e.clientX; startW=th.offsetWidth;
      document.body.classList.add('dragging-col');
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
      e.preventDefault();
    }
    function onMove(e){
      const dx=e.clientX-startX; const w=Math.max(40, startW+dx);
      th.style.width=w+'px';
    }
    function onUp(){ document.body.classList.remove('dragging-col');
      document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp);
    }
    grip.addEventListener('mousedown', onDown);
  });
})();</script>


<script>
<script>
/* DEMO INIT ACC HRS (robust) */
(function(){
  function apply(){
    try{
      if(!Array.isArray(window.drivers)) return false;
      const now = Date.now();
      const get = id => window.drivers.find(d => String(d.empId)===String(id));
      const setHrs = (d, hrs) => {
        if(!d) return;
        d.shiftStartedAt = now - Math.floor(hrs*3600000);
        const rounded = Math.round(hrs*100)/100;
        d._accHrsStr = String(rounded);
        d._accOver   = hrs >= 8;
      };
      setHrs(get('53939'), 11.5);
      setHrs(get('54545'), 11.57);
      setHrs(get('554421'), 6.2);   // under 8h -> green
      setHrs(get('598771'), 7.4);   // under 8h -> green
      if (typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
      return true;
    }catch(e){ return false; }
  }
  if(!apply()){
    let tries=0;
    const t=setInterval(function(){
      if(apply()||++tries>50) clearInterval(t);
    }, 200);
  }
})();
</script>


<style>
/* Force iPhone messages blue */
#driverMsgModal .ft .btn.primary{ background:#0a84ff !important; color:#ffffff !important; border:0 !important; font-weight:700; }
#driverMsgModal .ft .btn.primary:hover{ filter:brightness(1.05); }
</style>


<script>
// Fallback DOM fill for Acc Hrs demo (no dependency on app state)
(function(){
  const demoHrs = { "53939": 11.5, "54545": 11.57, "554421": 6.2, "598771": 7.4 };
  function fill(){
    const sec = document.querySelector('#section_drivers_bottom');
    if(!sec) return false;
    let changed = false;
    sec.querySelectorAll('tbody tr').forEach(tr => {
      const acc = tr.querySelector('td.acc-hrs');
      if(!acc) return;
      const idCell = acc.previousElementSibling;
      if(!idCell) return;
      const id = (idCell.textContent||'').trim();
      const hrs = demoHrs[id];
      if(hrs == null) return;
      acc.textContent = String(Math.round(hrs*100)/100);
      acc.classList.remove('ok','over');
      if(hrs >= 8){ acc.classList.add('over'); } else { acc.classList.add('ok'); }
      changed = true;
    });
    return changed;
  }
  function tryFill(){
    if(fill()) return;
    let tries = 0;
    const t = setInterval(function(){
      if(fill() || ++tries > 60) clearInterval(t);
    }, 200);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', tryFill);
  }else{
    tryFill();
  }
})();
</script>


<script>
/* Robust Acc Hrs filler (works even if row builder didn't add classes) */
(function(){
  const demoHrs = { "53939": 11.5, "54545": 11.57, "554421": 6.2, "598771": 7.4 };
  function findAccCol(){
    const sec = document.querySelector('#section_drivers_bottom');
    if(!sec) return -1;
    const ths = Array.from(sec.querySelectorAll('thead th'));
    return ths.findIndex(th => (th.textContent||'').trim().toLowerCase() === 'acc hrs');
  }
  function fill(){
    const sec = document.querySelector('#section_drivers_bottom');
    if(!sec) return false;
    const idx = findAccCol();
    if(idx < 0) return false;
    let changed = false;
    sec.querySelectorAll('tbody tr').forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if(!tds.length || idx >= tds.length) return;
      const cell = tds[idx];
      const idCell = tds[Math.max(0, idx-1)];
      const id = (idCell.textContent||'').trim();
      const hrs = demoHrs[id];
      if(hrs == null) return;
      cell.textContent = String(Math.round(hrs*100)/100);
      cell.style.color = (hrs >= 8) ? '#ff3b30' : '#44d07e';
      changed = true;
    });
    return changed;
  }
  function start(){
    fill();
    const tbody = document.querySelector('#section_drivers_bottom tbody');
    if(tbody){
      const obs = new MutationObserver(() => fill());
      obs.observe(tbody, { childList: true });
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', start);
  }else{
    start();
  }
})();
</script>


<style>
/* Elevate modal above any icons/content */
#driverMsgOverlay{ z-index:10000 !important; }
#driverMsgModal{ z-index:10001 !important; }
</style>


<style>
#pp_toast{ position:fixed; left:50%; right:auto; bottom:24px; background:#0b1322; color:#e5edf8; border:1px solid #23304c; border-radius:10px; padding:10px 14px; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transform:translate(-50%, 8px); transition:opacity .2s ease, transform .2s ease; z-index:10002; pointer-events:none; }
#pp_toast.show{ opacity:1; transform:translate(-50%, 0); }
</style>
<div id="pp_toast" role="status" aria-live="polite">Message Sent</div>
<script>
(function(){
  function showToast(msg){
    var el=document.getElementById('pp_toast'); if(!el) return;
    el.textContent = msg||'Message Sent';
    el.classList.add('show');
    clearTimeout(el._t); el._t=setTimeout(function(){ el.classList.remove('show'); }, 1600);
  }
  // Hook into Update Driver button
  document.addEventListener('click', function(e){
    var btn=e.target.closest && e.target.closest('#driverMsgSend');
    if(!btn) return;
    setTimeout(function(){ showToast('Message Sent'); }, 80);
  });
})();
</script>


<script>
// Sorting for Drivers table A-Z / Z-A with funnel icon per header
(function(){
  const SEC_ID = '#section_drivers_bottom';
  let sortState = { col: null, dir: 'asc' };

  function addIcons(){
    const sec = document.querySelector(SEC_ID); if(!sec) return;
    const ths = sec.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      if(th.querySelector('.sort-btn')) return;
      const btn = document.createElement('span');
      btn.className = 'sort-btn';
      btn.title = 'Sort A–Z (click again Z–A)';
      btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
         <path d="M3 4h18M6 9h12M9 14h6M11 19h2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
      th.appendChild(btn);
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        if(sortState.col === idx){
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
        }else{
          sortState.col = idx;
          sortState.dir = 'asc';
        }
        ths.forEach(h => h.classList.remove('active-sort','asc','desc'));
        th.classList.add('active-sort', sortState.dir);
        tryRenderThenSort();
      });
    });
  }

  function getCellText(td){
    if(!td) return '';
    const dv = td.getAttribute('data-value');
    if(dv) return dv;
    let t = td.textContent || '';
    return t.trim().toLowerCase();
  }

  function cmp(a,b){
    const na = parseFloat(a), nb = parseFloat(b);
    const isNumA = !isNaN(na) && /^[-+]?\d+(\.\d+)?$/.test(a);
    const isNumB = !isNaN(nb) && /^[-+]?\d+(\.\d+)?$/.test(b);
    if(isNumA && isNumB){ return na - nb; }
    return a.localeCompare(b, undefined, { sensitivity:'base' });
  }

  function applySortDOM(){
    const sec = document.querySelector(SEC_ID);
    if(!sec) return;
    const tbody = sec.querySelector('tbody'); if(!tbody) return;
    if(sortState.col == null) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((r1, r2) => {
      const t1 = getCellText(r1.children[sortState.col]);
      const t2 = getCellText(r2.children[sortState.col]);
      const c = cmp(t1, t2);
      return sortState.dir === 'asc' ? c : -c;
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  function hookRender(){
    if(window._pp_renderPatched) return;
    if(typeof window.renderDrivers === 'function'){
      const orig = window.renderDrivers;
      window.renderDrivers = function(){
        const res = orig.apply(this, arguments);
        applySortDOM();
        return res;
      };
      window._pp_renderPatched = true;
    }
  }

  function tryRenderThenSort(){
    if(typeof window.renderDrivers === 'function'){
      try{ window.renderDrivers(); }catch(_){}
    }else{
      applySortDOM();
    }
  }

  function init(){
    addIcons();
    hookRender();
    const sec = document.querySelector(SEC_ID);
    if(sec){
      const obs = new MutationObserver(() => { addIcons(); applySortDOM(); });
      obs.observe(sec, { childList:true, subtree:true });
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();
</script>


<script>
(function(){
  const SEC = document.querySelector('#section_drivers_bottom');
  if(!SEC) return;
  if(window.__pp_sortPatched2) return; window.__pp_sortPatched2 = true;
  let sortState = { col: null, dir: 'asc' };

  function addIconsAndBind(){
    const ths = SEC.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      const label = (th.textContent || '').trim();
      if(!label) return;
      if(!th.querySelector('.sort-btn')){
        const btn = document.createElement('span');
        btn.className = 'sort-btn';
        btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
  <path d="M4 5h16l-7 8v6l-2 1v-7L4 5z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round"/>
</svg>`;
        th.appendChild(btn);
      }
      if(!th._ppBound2){
        th._ppBound2 = true;
        th.addEventListener('click', function(){
          if(sortState.col === idx){
            sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
          }else{
            sortState.col = idx;
            sortState.dir = 'asc';
          }
          ths.forEach(h => h.classList.remove('active-sort','asc','desc'));
          th.classList.add('active-sort', sortState.dir);
          applySort();
        });
      }
    });
  }

  function timeToMinutes(t){
    const m = /^(\d{1,2}):(\d{2})$/.exec(t);
    if(!m) return NaN;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function parseElaps(txt){
    const m = txt.match(/(\d+)\s*m/);
    return m ? parseInt(m[1],10) : NaN;
  }
  function keyFor(thText, cell){
    const raw = (cell?.getAttribute('data-value') || cell?.textContent || '').trim();
    const txt = raw.toLowerCase();
    switch(thText){
      case 'ID': return parseInt(txt,10);
      case 'Acc Hrs': return parseFloat(txt);
      case 'ETA': { const v = timeToMinutes(txt); return isNaN(v) ? Number.POSITIVE_INFINITY : v; }
      case 'Elaps Time': { const v = parseElaps(txt); return isNaN(v) ? Number.POSITIVE_INFINITY : v; }
      default: return txt;
    }
  }
  function applySort(){
    const theadThs = SEC.querySelectorAll('thead th');
    if(sortState.col == null || !theadThs.length) return;
    const label = (theadThs[sortState.col].textContent || '').trim();
    const tbody = SEC.querySelector('tbody'); if(!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((r1, r2) => {
      const t1 = keyFor(label, r1.children[sortState.col]);
      const t2 = keyFor(label, r2.children[sortState.col]);
      const n1 = (typeof t1 === 'number'), n2 = (typeof t2 === 'number');
      const c = (n1 && n2) ? (t1 - t2) : String(t1).localeCompare(String(t2), undefined, { sensitivity:'base' });
      return sortState.dir === 'asc' ? c : -c;
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  if(typeof window.renderDrivers === 'function' && !window.__pp_sortHooked2){
    const orig = window.renderDrivers;
    window.renderDrivers = function(){
      const res = orig.apply(this, arguments);
      try{ addIconsAndBind(); applySort(); }catch(e){}
      return res;
    };
    window.__pp_sortHooked2 = true;
  }

  addIconsAndBind();
  const tb = SEC.querySelector('tbody');
  if(tb){
    const obs = new MutationObserver(() => addIconsAndBind());
    obs.observe(tb, { childList:true });
  }
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
  var gpsBtn = document.getElementById("tab_drivergps");
  if (gpsBtn) {
    gpsBtn.addEventListener("click", function () {
      // Long Beach Port coordinates
      const longBeachPort = "33.7676,-118.1981";
      // Open Google Maps centered on Long Beach Port in a new tab
      window.open(`https://www.google.com/maps/@${longBeachPort},14z`, "_blank");
    });
  }
});
</script>


<script>
// ===== SAFETY-NET: Create sheet buttons (capture-phase, globals, and onclick backup) =====
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    const modal = document.getElementById('create_modal');
    function openCreate(){ if(modal){ modal.style.display='flex'; } }
    function closeCreate(){ if(modal){ modal.style.display='none'; } }
    if(typeof window.openConfirm!=='function'){
      window.openConfirm = function(msg, yes){ if(confirm(msg)) { try{ yes&&yes(); }catch(e){} } };
    }
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }
    function resetFields(){
      ['c_id','c_window','c_from','c_to','c_container','c_bkpin','c_seal','c_appt','c_pudate','c_deliveryDate','c_lfd','c_returnDate','c_returnPort','c_customer','c_chassis','c_size','c_pin','c_instruction']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      const leT=document.getElementById('c_dd_loadempty'); if(leT) leT.textContent='Select…';
      const ieT=document.getElementById('c_dd_impexp');   if(ieT) ieT.textContent='Select…';
    }
    function doCancel(){
      openConfirm('Confirm cancel? Your entries will be lost.', function(){ closeCreate(); });
    }
    function doUpdate(){
      const id = gv('c_id');
      if(!id){ if(typeof toast==='function') toast('Enter a Job #'); return; }
      const rec = {
        id, from: gv('c_from'), to: gv('c_to'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        bk: gv('c_bkpin'),
        ie: gv('c_impexp'),
        seal: gv('c_seal'),
        window: gv('c_window'),
        remark: gv('c_instruction'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        customer: gv('c_customer'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        status: 'Pending'
      };
      openConfirm('Create this new pickup in Main Dispatch?', function(){
        if(!Array.isArray(window.pending)) window.pending = [];
        window.pending.unshift(rec);
        try{ typeof renderPending==='function' && renderPending(); }catch(_){}
        try{ typeof updateBadges==='function' && updateBadges(); }catch(_){}
        closeCreate();
        try{ typeof switchTab==='function' && switchTab('pending'); }catch(_){}
        try{ typeof toast==='function' && toast('Pickup created'); }catch(_){}
      });
    }
    // Expose globals as a backstop
    window.CCL_createOpen = openCreate;
    window.CCL_createCancel = doCancel;
    window.CCL_createUpdate = doUpdate;

    // Bind directly (overwriting inline handlers if any)
    const bOpen   = document.getElementById('btn_create_pending');
    const bCancel = document.getElementById('btn_create_cancel');
    const bUpdate = document.getElementById('btn_create_update');
    if(bOpen){   bOpen.onclick   = function(e){ e.preventDefault(); resetFields(); openCreate(); }; }
    if(bCancel){ bCancel.onclick = function(e){ e.preventDefault(); doCancel(); }; }
    if(bUpdate){ bUpdate.onclick = function(e){ e.preventDefault(); doUpdate(); }; }

    // Capture-phase delegate so nothing can swallow the click
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if(!t) return;
      if(t.closest && t.closest('#btn_create_pending')){ ev.preventDefault(); resetFields(); openCreate(); }
      else if(t.closest && t.closest('#btn_create_cancel')){ ev.preventDefault(); doCancel(); }
      else if(t.closest && t.closest('#btn_create_update')){ ev.preventDefault(); doUpdate(); }
    }, true);
  });
})();
</script>


<script>
// ===== V3 RELIABLE CREATE: adds visual debug + direct row insert fallback =====
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    function banner(msg){
      var id='ccl_debug_banner';
      var el=document.getElementById(id);
      if(!el){
        el=document.createElement('div'); el.id=id;
        el.style.cssText='position:fixed;left:12px;bottom:12px;z-index:99999;padding:8px 12px;border-radius:10px;background:#0b3b61;color:#e0f2fe;font:12px/1.3 ui-sans-serif,system-ui,Segoe UI,Roboto;box-shadow:0 6px 16px rgba(0,0,0,.35)';
        document.body.appendChild(el);
      }
      el.textContent = 'Create Debug: ' + msg;
      setTimeout(()=>{ if(el && el.parentNode) el.parentNode.removeChild(el); }, 4500);
      try{ console.log('[CCL]', msg); }catch(_){}
    }

    const modal = document.getElementById('create_modal');
    function closeCreate(){ if(modal) modal.style.display='none'; }

    if(typeof window.openConfirm!=='function'){
      window.openConfirm = function(msg, yes){ if(confirm(msg)){ try{ yes&&yes(); }catch(e){} } };
    }
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }

    function forceInsertRow(rec){
      // Minimal guaranteed DOM insert into Pending
      const body = document.getElementById('pending_body');
      if(!body){ banner('No pending_body found.'); return; }
      const tr = document.createElement('tr'); tr.dataset.id = rec.id || '';
      const td0=document.createElement('td'); td0.innerHTML='<input type="checkbox" class="chk">'; tr.appendChild(td0);
      const tdDrv=document.createElement('td'); tdDrv.textContent = rec.driverName || '—'; tr.appendChild(tdDrv);
      function td(val){ const td=document.createElement('td'); td.innerHTML = (val && String(val).trim()) ? String(val) : '<span class="dash-center">—</span>'; tr.appendChild(td); }
      ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status']
        .forEach(k=>td(rec[k]));
      body.appendChild(tr);
      banner('Direct row inserted.');
    }

    function doUpdate(){
      const id = gv('c_id');
      if(!id){ banner('Missing Job #'); return; }
      const rec = {
        id, from: gv('c_from'), to: gv('c_to'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        bk: gv('c_bkpin'),
        ie: gv('c_impexp'),
        seal: gv('c_seal'),
        window: gv('c_window'),
        remark: gv('c_instruction'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        customer: gv('c_customer'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        status: 'Pending'
      };
      openConfirm('Create this new pickup in Main Dispatch?', function(){
        try{
          if(!Array.isArray(window.pending)) window.pending = [];
          window.pending.unshift(rec);
          banner('Added to array. Count now ' + window.pending.length);
          var rendered = false;
          try{
            if(typeof renderPending==='function'){ renderPending(); rendered=true; banner('renderPending called.'); }
          }catch(e){}
          if(!rendered) forceInsertRow(rec);
          try{ typeof updateBadges==='function' && updateBadges(); }catch(_){}
          closeCreate();
          try{ typeof switchTab==='function' && switchTab('pending'); }catch(_){}
        }catch(e){ banner('ERROR: ' + (e && e.message)); }
      });
    }

    // Bind buttons hard
    ['btn_create_update','btn_create_cancel','btn_create_pending'].forEach(function(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', function(ev){
        ev.preventDefault();
        if(id==='btn_create_update') doUpdate();
        if(id==='btn_create_cancel') { openConfirm('Confirm cancel? Your entries will be lost.', function(){ closeCreate(); }); }
        if(id==='btn_create_pending') { document.getElementById('create_modal').style.display='flex'; }
      }, true);
    });
  });
})();
</script>


<script>
/* =========================
   CCL CREATE NEW — HARD REWRITE (v4)
   - No dependencies on old handlers
   - Works even if other code blocks events
   - Renders via existing renderPending() OR our own DOM builder
   ========================= */
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const IDs = {
      open:   'btn_create_pending',
      cancel: 'btn_create_cancel',
      update: 'btn_create_update',
      modal:  'create_modal'
    };

    const F = {
      gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); },
      // Data extraction from fields
      collect(){
        return {
          id: F.gv('c_id'),
          window: F.gv('c_window'),
          from: F.gv('c_from'),
          to: F.gv('c_to'),
          customer: F.gv('c_customer'),
          container: F.gv('c_container'),
          appt: F.gv('c_loadempty'),         // Load / Empty (hidden)
          ie: F.gv('c_impexp'),              // Import / Export (hidden)
          bk: F.gv('c_bkpin'),               // BK # / PIN
          seal: F.gv('c_seal'),
          pudate: F.gv('c_pudate'),
          deliveryDate: F.gv('c_deliveryDate'),
          lfd: F.gv('c_lfd'),
          returnDate: F.gv('c_returnDate'),
          returnPort: F.gv('c_returnPort'),
          chassis: F.gv('c_chassis'),
          size: F.gv('c_size'),
          pin: F.gv('c_pin'),
          remark: F.gv('c_instruction'),
          status: 'Pending'
        };
      },
      open(){ const m=document.getElementById(IDs.modal); if(m){ m.style.display='flex'; }},
      close(){ const m=document.getElementById(IDs.modal); if(m){ m.style.display='none'; }},
      confirm(msg, yes){ 
        if(typeof window.openConfirm==='function'){ window.openConfirm(msg, yes); }
        else if(window.confirm(msg)){ try{ yes&&yes(); }catch(e){} }
      },
      ensureModel(){
        if(!window.state) window.state = { selectedPending:new Set(), selectedInprogress:new Set(), currentTab:'pickups' };
        if(!Array.isArray(window.pending)) window.pending = [];
      },
      // Safe render: use app's renderPending if present, otherwise do a minimal render
      render(){
        // Preferred: app renderer
        if(typeof window.renderPending === 'function'){ try{ window.renderPending(); return; }catch(e){} }
        // Fallback: append a simple row to pending_body
        const body = document.getElementById('pending_body')
                  || (document.querySelector('#section_pending tbody') || document.querySelector('#section_pending table tbody'));
        if(!body) return;
        const last = window.pending[window.pending.length-1] || {};
        const tr = document.createElement('tr'); tr.dataset.id = last.id || '';
        // Checkbox
        const td0=document.createElement('td'); td0.innerHTML='<input type="checkbox" class="chk">'; tr.appendChild(td0);
        // Driver placeholder
        const tdD=document.createElement('td'); tdD.textContent = last.driverName || '—'; tr.appendChild(tdD);
        // Cells (match your DEFAULT_ORDER)
        const keys = ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status'];
        keys.forEach(k=>{
          const td=document.createElement('td'); const v=(last[k]==null?'':String(last[k])).trim();
          td.innerHTML = v ? v : '<span class="dash-center">—</span>'; tr.appendChild(td);
        });
        body.appendChild(tr);
        // Try to update badges if available
        if(typeof window.updateBadges==='function'){ try{ window.updateBadges(); }catch(e){} }
      },
      // Bind by cloning nodes (removes previous listeners)
      bind(id, handler){
        const el = document.getElementById(id); if(!el || !el.parentNode) return;
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
        clone.addEventListener('click', function(ev){ ev.preventDefault(); handler(); }, {capture:true});
      }
    };

    // Wire up buttons
    F.bind(IDs.open,   function(){ F.open(); });
    F.bind(IDs.cancel, function(){ F.confirm('Confirm cancel? Your entries will be lost.', F.close); });
    F.bind(IDs.update, function(){
      const rec = F.collect();
      if(!rec.id){ if(typeof toast==='function') toast('Enter a Job #'); return; }
      F.confirm('Create this new pickup in Main Dispatch?', function(){
        F.ensureModel();
        window.pending.unshift(rec);
        F.render();
        F.close();
        if(typeof window.switchTab==='function'){ try{ window.switchTab('pending'); }catch(e){} }
        if(typeof toast==='function'){ try{ toast('Pickup created'); }catch(e){} }
      });
    });

    // As an absolute last resort: delegate at document level
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if(!t) return;
      const hit = (id)=> t.id===id || (t.closest && t.closest('#'+id));
      if(hit(IDs.open)){ ev.preventDefault(); F.open(); }
      if(hit(IDs.cancel)){ ev.preventDefault(); F.confirm('Confirm cancel? Your entries will be lost.', F.close); }
      if(hit(IDs.update)){ ev.preventDefault(); const rec=F.collect(); if(!rec.id){ return; } F.ensureModel(); window.pending.unshift(rec); F.render(); F.close(); }
    }, true);
  });
})();
</script>


<script>
// ===== v5: Force-render to Main Dispatch + manual tab activation & badge bump =====
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function showPendingSection(){
      try{
        if(window.state) state.currentTab='pending';
      }catch(_){}
      var tabs = ['pickups','assigned','inprogress','completed','pending'];
      tabs.forEach(function(k){
        var sec = document.getElementById('section_'+k);
        var tab = document.getElementById('tab_'+k);
        if(sec){ sec.style.display = (k==='pending') ? '' : 'none'; }
        if(tab){ if(k==='pending') tab.classList.add('active'); else tab.classList.remove('active'); }
      });
    }
    function bumpBadge(){
      var el = document.getElementById('badge_pending');
      if(!el) return;
      var n = parseInt((el.textContent||'0').replace(/\D+/g,''),10);
      if(!isFinite(n)) n = 0;
      el.textContent = (n+1);
    }

    // Hook the already-added v4 handler if present
    var oldUpdate = window.CCL_createUpdate;
    window.CCL_createUpdate = function(){
      if(typeof oldUpdate === 'function'){
        oldUpdate();
        // After old flow runs, ensure visibility and counts
        showPendingSection();
        try{ if(typeof updateBadges!=='function') bumpBadge(); }catch(_){}
      }
    };

    // Also bind directly in case global not used
    var btn = document.getElementById('btn_create_update');
    if(btn){
      btn.addEventListener('click', function(_, called){
        // Delay to run after any existing listeners push to array
        setTimeout(function(){
          showPendingSection();
          try{ if(typeof updateBadges!=='function') bumpBadge(); }catch(_){}
        }, 50);
      }, true);
    }
  });
})();
</script>


<script>
// ===== v6: Force show + render + focus new row in Main Dispatch =====
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function showPendingSection(){
      try{ if(window.state) state.currentTab='pending'; }catch(_){}
      ['pickups','assigned','inprogress','completed','pending'].forEach(function(k){
        var sec = document.getElementById('section_'+k);
        var tab = document.getElementById('tab_'+k);
        if(sec){ sec.style.display = (k==='pending') ? '' : 'none'; }
        if(tab){ if(k==='pending') tab.classList.add('active'); else tab.classList.remove('active'); }
      });
    }
    function renderAndFocus(id){
      var ok=false;
      try{ if(typeof renderPending==='function'){ renderPending(); ok=true; } }catch(_){}
      if(!ok){
        // If renderPending missing, try minimal reinsert from existing pending array
        try{
          var body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
          if(body && Array.isArray(window.pending)){
            body.innerHTML='';
            window.pending.forEach(function(a){
              var tr=document.createElement('tr'); tr.dataset.id=a.id||'';
              var td0=document.createElement('td'); td0.innerHTML='<input type="checkbox" class="chk">'; tr.appendChild(td0);
              var tdD=document.createElement('td'); tdD.textContent = a.driverName || '—'; tr.appendChild(tdD);
              function td(val){ var td=document.createElement('td'); td.innerHTML = (val && String(val).trim()) ? String(val) : '<span class="dash-center">—</span>'; tr.appendChild(td); }
              ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status']
                .forEach(function(k){ td(a[k]); });
              body.appendChild(tr);
            });
          }
        }catch(_){}
      }
      // Focus/flash
      try{
        var row = document.querySelector('#section_pending tr[data-id="'+CSS.escape(id)+'"]');
        if(row){
          row.scrollIntoView({block:'center'});
          row.style.transition='background 300ms ease';
          var old = row.style.backgroundColor;
          row.style.backgroundColor='rgba(59,130,246,.25)';
          setTimeout(function(){ row.style.backgroundColor=old||''; }, 800);
        }
      }catch(_){}
    }
    function bumpBadge(){
      var el = document.getElementById('badge_pending');
      if(!el) return;
      var n = parseInt((el.textContent||'0').replace(/\D+/g,''),10); if(!isFinite(n)) n=0;
      el.textContent = (n+1);
    }
    // Wrap existing CCL_createUpdate if present
    var prev = window.CCL_createUpdate;
    window.CCL_createUpdate = function(){
      var idBefore = null;
      try{ idBefore = document.getElementById('c_id').value.trim(); }catch(_){}
      if(typeof prev==='function'){ prev(); }
      setTimeout(function(){
        showPendingSection();
        renderAndFocus(idBefore);
        try{ if(typeof updateBadges!=='function') bumpBadge(); }catch(_){}
      }, 60);
    };
    // Ensure direct button also triggers the above
    var btn = document.getElementById('btn_create_update');
    if(btn){
      btn.addEventListener('click', function(){
        setTimeout(function(){
          try{
            var idNow = document.getElementById('c_id').value.trim();
            showPendingSection();
            renderAndFocus(idNow);
            if(typeof updateBadges!=='function') bumpBadge();
          }catch(_){}
        }, 80);
      }, true);
    }
  });
})();
</script>


<script>
/* ===== v7: DIRECT-TO-MAIN-DISPATCH (no internal pending array required) ===== */
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }
    function dash(v){ return (v && String(v).trim()) ? String(v) : '<span class="dash-center">—</span>'; }
    function showMainDispatch(){
      // Your "Main Dispatch" section is the Pending board in this file
      ['pickups','assigned','inprogress','completed','pending'].forEach(function(k){
        const sec=document.getElementById('section_'+k);
        const tab=document.getElementById('tab_'+k);
        if(sec) sec.style.display = (k==='pending') ? '' : 'none';
        if(tab){ if(k==='pending') tab.classList.add('active'); else tab.classList.remove('active'); }
      });
      try{ if(window.state) state.currentTab='pending'; }catch(_){}
    }
    function bumpBadge(){
      const el = document.getElementById('badge_pending'); if(!el) return;
      const n = parseInt((el.textContent||'0').replace(/\D+/g,''),10); el.textContent = isFinite(n) ? (n+1) : 1;
    }
    function insertDirectRow(rec){
      const body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
      if(!body) return false;
      const tr = document.createElement('tr');
      tr.dataset.id = rec.id || '';
      // Checkbox
      const td0 = document.createElement('td'); td0.innerHTML = '<input type="checkbox" class="chk">'; tr.appendChild(td0);
      // Driver placeholder (Main Dispatch has no driver yet)
      const tdD = document.createElement('td'); tdD.innerHTML = dash(rec.driverName || ''); tr.appendChild(tdD);
      // Column cells in your default order
      const order = ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status'];
      order.forEach(function(k){
        const td = document.createElement('td'); td.innerHTML = dash(rec[k]); tr.appendChild(td);
      });
      // Put new rows at the top
      if(body.firstChild) body.insertBefore(tr, body.firstChild); else body.appendChild(tr);
      // Flash highlight
      try{
        tr.style.transition='background 300ms ease';
        tr.style.backgroundColor='rgba(59,130,246,.25)';
        setTimeout(function(){ tr.style.backgroundColor=''; }, 900);
      }catch(_){}
      return true;
    }

    // Replace the existing Update handler with a direct DOM insert
    function directUpdateFlow(){
      const rec = {
        id: gv('c_id'),
        from: gv('c_from'),
        to: gv('c_to'),
        customer: gv('c_customer'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        ie: gv('c_impexp'),
        bk: gv('c_bkpin'),
        seal: gv('c_seal'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        remark: gv('c_instruction'),
        status: 'Pending'
      };
      if(!rec.id){ try{ toast && toast('Enter a Job #'); }catch(_){ alert('Enter a Job #'); } return; }
      // Confirm using your modal if present, else window.confirm
      function go(){
        showMainDispatch();
        const ok = insertDirectRow(rec);
        if(ok){
          try{ document.getElementById('create_modal').style.display='none'; }catch(_){}
          try{ if(typeof updateBadges==='function') updateBadges(); else bumpBadge(); }catch(_){ bumpBadge(); }
          try{ toast && toast('Pickup created'); }catch(_){}
        } else {
          alert('Could not find Main Dispatch table body.');
        }
      }
      if(typeof window.openConfirm==='function') window.openConfirm('Create this new pickup in Main Dispatch?', go);
      else if(confirm('Create this new pickup in Main Dispatch?')) go();
    }

    // Hard-bind the Update button to the direct flow
    var btn = document.getElementById('btn_create_update');
    if(btn){
      // Remove previous listeners by cloning
      const clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(ev){ ev.preventDefault(); directUpdateFlow(); }, {capture:true});
    }
  });
})();
</script>


<script>
/* ===== v8: Insert into ALL Main-Dispatch candidates (handles any table) ===== */
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }
    function dash(v){ return (v && String(v).trim()) ? String(v) : '<span class="dash-center">—</span>'; }

    function candidateBodies(){
      // Try the most likely Main Dispatch bodies first
      const sels = [
        '#pending_body',
        '#section_pending tbody',
        '#p1_body',
        '#section_pickups tbody'
      ];
      const arr = [];
      sels.forEach(sel => { document.querySelectorAll(sel).forEach(el => { if(el && !arr.includes(el)) arr.push(el); }); });
      return arr;
    }
    function ensureMainDispatchVisible(){
      // Prefer showing pending; if not present, show pickups
      const order = ['pending','pickups'];
      order.forEach(function(k, idx){
        const sec = document.getElementById('section_'+k);
        const tab = document.getElementById('tab_'+k);
        if(sec){ sec.style.display = (idx===0) ? '' : 'none'; }
        if(tab){ if(idx===0) tab.classList.add('active'); else tab.classList.remove('active'); }
      });
      try{ if(window.state) state.currentTab='pending'; }catch(_){}
    }
    function bumpBadges(){
      ['badge_pending','badge_pickups'].forEach(function(id){
        const el = document.getElementById(id); if(!el) return;
        const n = parseInt((el.textContent||'0').replace(/\D+/g,''),10);
        el.textContent = isFinite(n) ? (n+1) : 1;
      });
    }
    function buildRow(rec){
      const tr = document.createElement('tr');
      tr.dataset.id = rec.id || '';
      const td0 = document.createElement('td'); td0.innerHTML = '<input type="checkbox" class="chk">'; tr.appendChild(td0);
      const tdD = document.createElement('td'); tdD.innerHTML = dash(rec.driverName || ''); tr.appendChild(tdD);
      const order = ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status'];
      order.forEach(function(k){
        const td = document.createElement('td'); td.innerHTML = dash(rec[k]); tr.appendChild(td);
      });
      tr.style.transition='background 300ms ease'; tr.style.backgroundColor='rgba(59,130,246,.22)';
      setTimeout(function(){ tr.style.backgroundColor=''; }, 900);
      return tr;
    }
    function insertIntoAllTargets(rec){
      const bodies = candidateBodies();
      let inserted = 0;
      bodies.forEach(function(tb){
        // prevent duplicate rows for the same ID
        if(rec.id && tb.querySelector('tr[data-id="'+CSS.escape(rec.id)+'"]')) return;
        const tr = buildRow(rec);
        if(tb.firstChild) tb.insertBefore(tr, tb.firstChild); else tb.appendChild(tr);
        inserted++;
      });
      return inserted > 0;
    }

    function collect(){
      return {
        id: gv('c_id'),
        from: gv('c_from'),
        to: gv('c_to'),
        customer: gv('c_customer'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        ie: gv('c_impexp'),
        bk: gv('c_bkpin'),
        seal: gv('c_seal'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        remark: gv('c_instruction'),
        status: 'Pending'
      };
    }

    function directUpdate(){
      const rec = collect();
      if(!rec.id){ try{ toast && toast('Enter a Job #'); }catch(_){ alert('Enter a Job #'); } return; }
      function go(){
        ensureMainDispatchVisible();
        const ok = insertIntoAllTargets(rec);
        if(ok){
          try{ document.getElementById('create_modal').style.display='none'; }catch(_){}
          try{ if(typeof updateBadges==='function') updateBadges(); else bumpBadges(); }catch(_){ bumpBadges(); }
          try{ toast && toast('Pickup created'); }catch(_){}
        } else {
          alert('Could not find a Main Dispatch table body to insert into.');
        }
      }
      if(typeof window.openConfirm==='function') window.openConfirm('Create this new pickup in Main Dispatch?', go);
      else if(confirm('Create this new pickup in Main Dispatch?')) go();
    }

    // Force-bind Update button to the direct update (no arrays)
    const btn = document.getElementById('btn_create_update');
    if(btn){
      const clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(ev){ ev.preventDefault(); directUpdate(); }, {capture:true});
    }
  });
})();
</script>


<script>
/* ===== v9: Heuristic direct insert into VISIBLE Main Dispatch + diagnostics ===== */
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }
    function dash(v){ return (v && String(v).trim()) ? String(v) : '<span class="dash-center">—</span>'; }
    function isVisible(el){ if(!el) return false; const s=getComputedStyle(el); return s.display!=='none' && s.visibility!=='hidden' && el.offsetParent!==null; }

    function banner(lines){
      try{
        var b=document.getElementById('ccl_diag'); if(!b){
          b=document.createElement('div'); b.id='ccl_diag';
          b.style.cssText='position:fixed;right:12px;bottom:12px;z-index:99999;min-width:260px;max-width:420px;padding:10px 12px;border-radius:12px;background:#0a1220;color:#e2e8f0;font:12px/1.35 ui-sans-serif,system-ui,Segoe UI,Roboto;box-shadow:0 10px 24px rgba(0,0,0,.5)';
          document.body.appendChild(b);
        }
        b.innerHTML = Array.isArray(lines) ? lines.map(x=>'<div>'+x+'</div>').join('') : String(lines||'');
        setTimeout(()=>{ try{ b.remove(); }catch(_){ } }, 3500);
      }catch(_){}
    }

    function ensureMainDispatchVisible(){
      // prefer pending; fallback to pickups
      const prefs = ['pending','pickups'];
      let chosen = null;
      for(const key of prefs){
        const sec = document.getElementById('section_'+key);
        if(sec){ chosen = key; break; }
      }
      if(!chosen) return null;
      ['pickups','assigned','inprogress','completed','pending'].forEach(function(k){
        const sec=document.getElementById('section_'+k);
        const tab=document.getElementById('tab_'+k);
        if(sec){ sec.style.display = (k===chosen) ? '' : 'none'; }
        if(tab){ if(k===chosen) tab.classList.add('active'); else tab.classList.remove('active'); }
      });
      try{ if(window.state) state.currentTab=chosen; }catch(_){}
      return chosen;
    }

    function visibleMainBodies(){
      // Focus on visible section first
      const sections = Array.from(document.querySelectorAll('[id^="section_"]')).filter(isVisible);
      let bodies = [];
      sections.forEach(sec => {
        const tbs = sec.querySelectorAll('tbody');
        tbs.forEach(tb => { if(isVisible(tb) && !bodies.includes(tb)) bodies.push(tb); });
      });
      // fallback: known IDs
      ['#pending_body','#p1_body','#section_pending tbody','#section_pickups tbody'].forEach(sel=>{
        document.querySelectorAll(sel).forEach(tb => { if(!bodies.includes(tb)) bodies.push(tb); });
      });
      return bodies;
    }

    function buildRow(rec){
      const tr = document.createElement('tr');
      tr.dataset.id = rec.id || '';
      const td0 = document.createElement('td'); td0.innerHTML = '<input type="checkbox" class="chk">'; tr.appendChild(td0);
      const tdD = document.createElement('td'); tdD.innerHTML = dash(rec.driverName || ''); tr.appendChild(tdD);
      const order = ['arrival','container','chassis','size','pin','ie','bk','pudate','appt','from','to','deliveryDate','lfd','returnDate','returnPort','customer','remark','carrier','mbl','status'];
      order.forEach(function(k){
        const td = document.createElement('td'); td.innerHTML = dash(rec[k]); tr.appendChild(td);
      });
      tr.style.transition='background 300ms ease'; tr.style.backgroundColor='rgba(59,130,246,.22)';
      setTimeout(function(){ tr.style.backgroundColor=''; }, 900);
      return tr;
    }

    function insertDirect(rec){
      const targets = visibleMainBodies();
      let hits = 0, targetIds = [];
      targets.forEach(tb => {
        // avoid duplicate by data-id
        if(rec.id && tb.querySelector('tr[data-id="'+CSS.escape(rec.id)+'"]')) return;
        const tr = buildRow(rec);
        if(tb.firstChild) tb.insertBefore(tr, tb.firstChild); else tb.appendChild(tr);
        hits++; targetIds.push('#'+(tb.id||'tbody')+' ('+(tb.closest('[id^=\"section_\"]')?.id||'no-section')+')');
      });
      return {hits, targetIds};
    }

    function collect(){
      return {
        id: gv('c_id'),
        from: gv('c_from'),
        to: gv('c_to'),
        customer: gv('c_customer'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        ie: gv('c_impexp'),
        bk: gv('c_bkpin'),
        seal: gv('c_seal'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        remark: gv('c_instruction'),
        status: 'Pending'
      };
    }

    function directUpdate(){
      const rec = collect();
      if(!rec.id){ try{ toast && toast('Enter a Job #'); }catch(_){ alert('Enter a Job #'); } return; }
      function go(){
        const chosen = ensureMainDispatchVisible();
        const res = insertDirect(rec);
        if(res.hits>0){
          try{ document.getElementById('create_modal').style.display='none'; }catch(_){}
          try{ if(typeof updateBadges==='function') updateBadges(); }catch(_){}
          banner(['Inserted into '+res.hits+' table Bod'+'ies', 'Targets:'].concat(res.targetIds));
        } else {
          banner('No visible Main Dispatch tbody found. I can hard-target a specific ID if you tell me.');
          alert('Could not find a visible Main Dispatch table body.');
        }
      }
      if(typeof window.openConfirm==='function') window.openConfirm('Create this new pickup in Main Dispatch?', go);
      else if(confirm('Create this new pickup in Main Dispatch?')) go();
    }

    // Force-bind Update to directUpdate
    const btn = document.getElementById('btn_create_update');
    if(btn){
      const clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(ev){ ev.preventDefault(); directUpdate(); }, {capture:true});
    }
  });
})();
</script>


<script>
/* ===== v10: Canonical insert into Main Dispatch model (window.pending) + forced render ===== */
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function gv(id){ const el=document.getElementById(id); return (el && (el.value||'')).trim(); }
    function ensureModel(){
      if(!window.state) window.state = { selectedPending:new Set(), selectedInprogress:new Set(), currentTab:'pickups' };
      if(!Array.isArray(window.pending)) window.pending = [];
    }
    function dedupeById(arr, id){
      if(!id) return arr;
      const seen = new Set(); const out = [];
      for(const r of arr){
        const key = (r && r.id) ? String(r.id) : '';
        if(!key) { out.push(r); continue; }
        if(key === String(id)){
          if(seen.has(key)) continue;
          seen.add(key);
          out.push(r);
        } else {
          out.push(r);
        }
      }
      return out;
    }
    function saveLocal(){
      try{ localStorage.setItem('ccl_pending', JSON.stringify(window.pending)); }catch(_){}
    }
    function showMain(){
      try{ state.currentTab='pending'; }catch(_){}
      ['pickups','assigned','inprogress','completed','pending'].forEach(function(k){
        const sec=document.getElementById('section_'+k);
        const tab=document.getElementById('tab_'+k);
        if(sec) sec.style.display = (k==='pending') ? '' : 'none';
        if(tab){ if(k==='pending') tab.classList.add('active'); else tab.classList.remove('active'); }
      });
    }
    function renderAndFocus(id){
      // Render via app; then focus when tbody updates
      let focused = false;
      try{
        if(typeof renderPending==='function'){ renderPending(); }
      }catch(_){}
      try{
        const body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
        if(!body) return;
        const target = ()=> body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
        let row = target();
        if(row){
          row.scrollIntoView({block:'center'});
          row.style.transition='background 300ms ease'; row.style.backgroundColor='rgba(59,130,246,.22)'; setTimeout(()=>{ row.style.backgroundColor=''; }, 900);
          focused = true;
        } else {
          // Wait for a render pass to complete then focus
          const mo = new MutationObserver(function(){
            const r = target();
            if(r){
              try{ r.scrollIntoView({block:'center'}); r.style.transition='background 300ms ease'; r.style.backgroundColor='rgba(59,130,246,.22)'; setTimeout(()=>{ r.style.backgroundColor=''; }, 900); }catch(_){}
              mo.disconnect();
            }
          });
          mo.observe(body, {childList:true, subtree:false});
          setTimeout(()=>{ try{ mo.disconnect(); }catch(_){} }, 1500);
        }
      }catch(_){}
    }
    function bumpBadge(){
      try{
        if(typeof updateBadges==='function'){ updateBadges(); return; }
      }catch(_){}
      const el = document.getElementById('badge_pending'); if(!el) return;
      const n = parseInt((el.textContent||'0').replace(/\D+/g,''),10); el.textContent = isFinite(n) ? (n+1) : 1;
    }

    function onUpdate(){
      const rec = {
        id: gv('c_id'),
        from: gv('c_from'),
        to: gv('c_to'),
        customer: gv('c_customer'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),
        ie: gv('c_impexp'),
        bk: gv('c_bkpin'),
        seal: gv('c_seal'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        remark: gv('c_instruction'),
        status: 'Pending'
      };
      if(!rec.id){ try{ toast && toast('Enter a Job #'); }catch(_){ alert('Enter a Job #'); } return; }
      function go(){
        ensureModel();
        // Unshift to the top; remove older duplicate if exists
        window.pending = (window.pending || []).filter(x => !x || String(x.id) !== String(rec.id));
        window.pending.unshift(rec);
        window.pending = dedupeById(window.pending, rec.id);
        saveLocal();
        showMain();
        renderAndFocus(rec.id);
        try{ document.getElementById('create_modal').style.display='none'; }catch(_){}
        bumpBadge();
        try{ toast && toast('Pickup created'); }catch(_){}
      }
      if(typeof window.openConfirm==='function') window.openConfirm('Create this new pickup in Main Dispatch?', go);
      else if(confirm('Create this new pickup in Main Dispatch?')) go();
    }

    // Bind Update hard
    (function(){
      const btn = document.getElementById('btn_create_update');
      if(!btn || !btn.parentNode) return;
      const clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(ev){ ev.preventDefault(); onUpdate(); }, {capture:true});
    })();
  });
})();
</script>


<script>
(function(){
  const SEARCH_ID = 'pending_search';
  const TBODY_ID  = 'pending_body';
  const SECTION_ID = 'section_pending';

  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function escRx(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

  function clearAll(tbody){
    // show all rows and remove prior highlights
    Array.from(tbody.rows).forEach(tr=>{ tr.style.display=''; });
    tbody.querySelectorAll('span.ccl-hl').forEach(span=> span.replaceWith(document.createTextNode(span.textContent)));
  }

  function highlightMatchesInCell(td, rx){
    if(td.querySelector('input,button,svg')) return false;
    const text = td.textContent || '';
    if(!rx.test(text)) return false;
    rx.lastIndex = 0;
    const frag = document.createDocumentFragment();
    let last = 0;
    text.replace(rx, function(m, offset){
      if(offset>last) frag.appendChild(document.createTextNode(text.slice(last, offset)));
      const mark = document.createElement('span'); mark.className = 'ccl-hl'; mark.textContent = m;
      frag.appendChild(mark); last = offset + m.length; return m;
    });
    if(last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
    td.textContent = ''; td.appendChild(frag);
    return true;
  }

  function doSearch(){
    const input = document.getElementById(SEARCH_ID);
    const tbody = document.getElementById(TBODY_ID);
    const section = document.getElementById(SECTION_ID);
    const scroller = section ? section.querySelector('.relative.overflow-auto') : null;
    if(!input || !tbody) return;

    clearAll(tbody);
    const q = (input.value || '').trim();
    if(!q){ if(scroller) scroller.scrollTo({top:0}); return; }

    const rx = new RegExp(escRx(q), 'gi');
    let firstVisible = null;

    Array.from(tbody.rows).forEach(tr=>{
      let hit = false;
      Array.from(tr.cells).forEach(td=>{ if(highlightMatchesInCell(td, rx)) hit = true; });
      if(!hit){ tr.style.display = 'none'; }
      else if(!firstVisible){ firstVisible = tr; }
    });

    if(firstVisible && scroller){
      scroller.scrollTo({ top:firstVisible.offsetTop - 6, behavior:'smooth' });
    }
  }

  function bind(){
    const input = document.getElementById(SEARCH_ID);
    if(!input) return;
    ['input','keyup','change'].forEach(evt=> input.addEventListener(evt, doSearch));
  }
  ready(bind);
})();
</script>


<!-- CCL: minimal, additive wiring for Create -> Main Dispatch (idempotent, v2) -->
<script>
(function(){
  if (window.__ccl_create_pending_wired__) return;
  window.__ccl_create_pending_wired__ = true;

  function byId(id){ return document.getElementById(id); }

  // Safe helper: use existing function if present, else a fallback.
  function ensureRenderPending(){
    if (typeof window.renderPending === 'function') return;
    // Build a fallback that uses existing helpers if they exist.
    window.renderPending = function(){
      try{
        var section = document.querySelector('#section_pending table');
        var body = byId('pending_body');
        if(!section || !body) return;

        // If buildHeader/buildRowCells exist, use them so it matches other tabs.
        if (typeof window.buildHeader === 'function' && typeof window.buildRowCells === 'function'){
          var thead = section.tHead || section.createTHead();
          window.buildHeader(thead, true, true); // with master checkbox + Driver column
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.dataset.id = a.id;

            // checkbox cell
            var td0 = document.createElement('td');
            var cb = document.createElement('input');
            cb.type = 'checkbox'; cb.className = 'chk';
            td0.appendChild(cb); tr.appendChild(td0);

            // driver cell (pending has no driver yet)
            var tdDriver = document.createElement('td');
            tdDriver.textContent = (a.driverName || '—');
            tr.appendChild(tdDriver);

            window.buildRowCells(tr, a, 'Open');
            body.appendChild(tr);
          });
        } else {
          // Very simple fallback table render
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>'+(a.id||'')+'</td>' +
                           '<td>'+(a.from||'')+'</td>' +
                           '<td>'+(a.to||'')+'</td>' +
                           '<td>'+(a.container||'')+'</td>' +
                           '<td>'+(a.appt||'')+'</td>' +
                           '<td>'+(a.bk||'')+'</td>' +
                           '<td>'+(a.window||'')+'</td>' +
                           '<td>'+(a.status||'')+'</td>';
            body.appendChild(tr);
          });
        }
      }catch(e){ console.error('renderPending fallback error', e); }
    };
  }

  function updateBadgesSafe(){
    try{
      if (typeof window.updateBadges === 'function') window.updateBadges();
      else {
        var bp = byId('badge_pending'); if(bp) bp.textContent = (window.pending && window.pending.length) || 0;
      }
    }catch(e){}
  }

  function closeCreateModal(){
    var m = byId('create_modal');
    if (m) m.style.display = 'none';
  }

  function openCreateModal(){
    var m = byId('create_modal');
    if (m) m.style.display = 'flex';
  }

  function wireDropdown(triggerId, menuId, hiddenId){
    var trigger = byId(triggerId), menu = byId(menuId), hidden = byId(hiddenId);
    if (!trigger || !menu || !hidden) return;
    trigger.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      menu.classList.toggle('hidden');
    });
    menu.querySelectorAll('div[data-val]').forEach(function(item){
      item.addEventListener('click', function(){
        var val = item.getAttribute('data-val');
        hidden.value = val;
        trigger.textContent = val;
        menu.classList.add('hidden');
      });
    });
    document.addEventListener('click', function(e){
      if (!menu.classList.contains('hidden') && !menu.contains(e.target) && e.target!==trigger){
        menu.classList.add('hidden');
      }
    });
  }

  function wireCreateFlow(){
    // Open button
    var btnOpen = byId('btn_create_pending');
    if (btnOpen && !btnOpen.__wired){
      btnOpen.__wired = true;
      btnOpen.addEventListener('click', function(){
        openCreateModal();
      });
    }

    // Cancel button
    var btnCancel = byId('btn_create_cancel');
    if (btnCancel && !btnCancel.__wired){
      btnCancel.__wired = true;
      btnCancel.addEventListener('click', function(){
        // Simple confirm per your spec
        var cm = byId('confirm_modal'), ct = byId('confirm_text'),
            yes = byId('confirm_yes'), no = byId('confirm_no');
        if (cm && ct && yes && no){
          ct.textContent = 'Confirm cancel? Your entries will be lost.';
          cm.style.display = 'flex';
          var onNo = function(){ cm.style.display = 'none'; no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          var onYes = function(){
            cm.style.display = 'none';
            closeCreateModal();
            no.removeEventListener('click', onNo);
            yes.removeEventListener('click', onYes);
          };
          no.addEventListener('click', onNo);
          yes.addEventListener('click', onYes);
        } else {
          closeCreateModal();
        }
      });
    }

    // Update button -> push to pending + render
    var btnUpdate = byId('btn_create_update');
    if (btnUpdate && !btnUpdate.__wired){
      btnUpdate.__wired = true;
      btnUpdate.addEventListener('click', function(){
        try{
          // Build the new pickup object from form fields
          var rec = {
            id: (byId('c_id')||{}).value || '',
            from: (byId('c_from')||{}).value || '',
            to: (byId('c_to')||{}).value || '',
            container: (byId('c_container')||{}).value || '',
            appt: (byId('c_appt')||{}).value || '',
            bk: (byId('c_bkpin')||{}).value || '',
            window: (byId('c_window')||{}).value || '',
            pudate: (byId('c_pudate')||{}).value || '',
            deliveryDate: (byId('c_deliveryDate')||{}).value || '',
            lfd: (byId('c_lfd')||{}).value || '',
            returnDate: (byId('c_returnDate')||{}).value || '',
            returnPort: (byId('c_returnPort')||{}).value || '',
            customer: (byId('c_customer')||{}).value || '',
            chassis: (byId('c_chassis')||{}).value || '',
            size: (byId('c_size')||{}).value || '',
            pin: (byId('c_pin')||{}).value || '',
            ie: (byId('c_impexp')||{}).value || '',
            remark: (byId('c_instruction')||{}).value || '',
            status: 'Open'
          };
          // Load/Empty chosen via custom dropdown
          var le = (byId('c_loadempty')||{}).value || '';
          if (le) rec.loadempty = le;

          if (!window.pending) window.pending = [];
          window.pending.unshift(rec);

          ensureRenderPending();
          window.renderPending();
      if (typeof window.switchTab==='function'){ try{ window.switchTab('pending'); }catch(_){}} 
      updateBadgesSafe();
          // Close modal
          closeCreateModal();

          // Optional: soft toast if available
          try{ if (typeof window.toast === 'function') window.toast('New pickup added to Main Dispatch.'); }catch(_){}

        }catch(e){
          console.error('Create->Pending failed:', e);
        }
      });
    }

    // Wire the two dropdowns inside Create modal (if present)
    wireDropdown('c_dd_loadempty','c_menu_loadempty','c_loadempty');
    wireDropdown('c_dd_impexp','c_menu_impexp','c_impexp');
  }

  // Initialize after DOM ready
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    ensureRenderPending();
    wireCreateFlow();
    // First draw (in case tab starts active and table is empty)
    try{ window.renderPending(); }catch(_){}
  });
})();
</script>


<!-- CCL: robust Main Dispatch activation + Create wiring (idempotent, v2) -->
<script>
(function(){
  if (window.__ccl_force_main_dispatch__) return;
  window.__ccl_force_main_dispatch__ = true;

  function byId(id){ return document.getElementById(id); }

  // Fallback switchTab implementation if missing
  function ensureSwitchTab(){
    if (typeof window.switchTab === 'function') return;
    window.switchTab = function(name){
      var sections = ['pickups','assigned','inprogress','completed','pending'];
      sections.forEach(function(s){
        var sec = byId('section_'+s);
        var tab = byId('tab_'+s);
        if (!sec || !tab) return;
        if (s === name){
          sec.classList.remove('hidden');
          tab.classList.add('active');
        } else {
          sec.classList.add('hidden');
          tab.classList.remove('active');
        }
      });
    };
  }

  // Ensure Main Dispatch is visible by default on load
  function activateMainDispatch(){
    try{
      ensureSwitchTab();
      window.switchTab('pending');
    }catch(e){ console.error('activateMainDispatch error', e); }
  }

  // Ensure renderPending exists (reuse existing helpers if available)
  function ensureRenderPending(){
    if (typeof window.renderPending === 'function') return;
    window.renderPending = function(){
      try{
        var table = (byId('section_pending')||{}).querySelector && byId('section_pending').querySelector('table');
        var body = byId('pending_body');
        if(!table || !body) return;
        // Use helpers if present
        if (typeof window.buildHeader === 'function' && typeof window.buildRowCells === 'function'){
          var thead = table.tHead || table.createTHead();
          window.buildHeader(thead, true, true);
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.dataset.id = a.id;
            // checkbox
            var td0=document.createElement('td');
            var cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
            td0.appendChild(cb); tr.appendChild(td0);
            // driver placeholder
            var tdDriver=document.createElement('td'); tdDriver.textContent = a.driverName || '—'; tr.appendChild(tdDriver);
            window.buildRowCells(tr, a, 'Open');
            body.appendChild(tr);
          });
        }else{
          // Simple fallback
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.innerHTML = '<td></td><td>'+(a.driverName||'—')+'</td>' +
                           '<td>'+(a.id||'')+'</td>' +
                           '<td>'+(a.from||'')+'</td>' +
                           '<td>'+(a.to||'')+'</td>' +
                           '<td>'+(a.container||'')+'</td>' +
                           '<td>'+(a.appt||'')+'</td>' +
                           '<td>'+(a.bk||'')+'</td>' +
                           '<td>'+(a.window||'')+'</td>' +
                           '<td>'+(a.status||'')+'</td>';
            body.appendChild(tr);
          });
        }
      }catch(e){ console.error('renderPending error', e); }
    };
  }

  function updateBadgesSafe(){
    try{
      if (typeof window.updateBadges === 'function') window.updateBadges();
      else {
        var bp = byId('badge_pending'); if(bp) bp.textContent = (window.pending && window.pending.length) || 0;
      }
    }catch(e){}
  }

  function openCreateModal(){ var m = byId('create_modal'); if(m){ m.style.display='flex'; } }
  function closeCreateModal(){ var m = byId('create_modal'); if(m){ m.style.display='none'; } }

  function genId(){
    // Generate a unique Job # if user left it blank
    var t = Date.now();
    return 'CCL-' + (t % 1000000).toString().padStart(6,'0');
  }

  function wireCreateFlow(){
    // Open
    var btnOpen = byId('btn_create_pending');
    if (btnOpen && !btnOpen.__wired){
      btnOpen.__wired = true;
      btnOpen.addEventListener('click', openCreateModal);
    }
    // Cancel
    var btnCancel = byId('btn_create_cancel');
    if (btnCancel && !btnCancel.__wired){
      btnCancel.__wired = true;
      btnCancel.addEventListener('click', function(){
        var cm = byId('confirm_modal'), ct = byId('confirm_text'),
            yes = byId('confirm_yes'), no = byId('confirm_no');
        if (cm && ct && yes && no){
          ct.textContent = 'Confirm cancel? Your entries will be lost.';
          cm.style.display = 'flex';
          var onNo = function(){ cm.style.display = 'none'; no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          var onYes = function(){ cm.style.display = 'none'; closeCreateModal(); no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          no.addEventListener('click', onNo);
          yes.addEventListener('click', onYes);
        } else {
          closeCreateModal();
        }
      });
    }
    // Update
    var btnUpdate = byId('btn_create_update');
    if (btnUpdate && !btnUpdate.__wired){
      btnUpdate.__wired = true;
      btnUpdate.addEventListener('click', function(){
        try{
          var id = (byId('c_id')||{}).value || genId();
          var rec = {
            id: id.trim(),
            from: (byId('c_from')||{}).value || '',
            to: (byId('c_to')||{}).value || '',
            container: (byId('c_container')||{}).value || '',
            appt: (byId('c_appt')||{}).value || '',
            bk: (byId('c_bkpin')||{}).value || '',
            window: (byId('c_window')||{}).value || '',
            pudate: (byId('c_pudate')||{}).value || '',
            deliveryDate: (byId('c_deliveryDate')||{}).value || '',
            lfd: (byId('c_lfd')||{}).value || '',
            returnDate: (byId('c_returnDate')||{}).value || '',
            returnPort: (byId('c_returnPort')||{}).value || '',
            customer: (byId('c_customer')||{}).value || '',
            chassis: (byId('c_chassis')||{}).value || '',
            size: (byId('c_size')||{}).value || '',
            pin: (byId('c_pin')||{}).value || '',
            ie: (byId('c_impexp')||{}).value || '',
            remark: (byId('c_instruction')||{}).value || '',
            status: 'Open'
          };
          var le = (byId('c_loadempty')||{}).value || '';
          if (le) rec.loadempty = le;

          if (!window.pending) window.pending = [];
          window.pending.unshift(rec);

          ensureRenderPending();
          window.renderPending();
          updateBadgesSafe();

          ensureSwitchTab();
          window.switchTab('pending'); // force-show Main Dispatch
          closeCreateModal();

          try{ if (typeof window.toast === 'function') window.toast('New pickup added to Main Dispatch.'); }catch(_){}
        }catch(e){ console.error('Create->Pending failed:', e); }
      });
    }
  }

  // Init
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    ensureRenderPending();
    wireCreateFlow();
    activateMainDispatch(); // make Main Dispatch visible on load
    try{ window.renderPending(); }catch(_){}
  });
})();
</script>


<!-- SAFEGUARD: Edit prefill (do not modify) -->
<script>
(function(){
  if(window.__CCL_EDIT_PREFILL__) return; window.__CCL_EDIT_PREFILL__=true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function text(v){ return (v==null?'':String(v)).trim(); }
    function getSelected(scope){
      try{
        if(scope==='pending'){
          if(window.state && state.selectedPending && state.selectedPending.size===1){
            var id = String(Array.from(state.selectedPending)[0]);
            var rec = Array.isArray(window.pending)? pending.find(function(r){ return r && String(r.id)===id; }) : null;
            return {id:id, rec:rec||{}};
          }
        }else if(scope==='inprogress'){
          if(window.state && state.selectedInprogress && state.selectedInprogress.size===1){
            var id2 = String(Array.from(state.selectedInprogress)[0]);
            var rec2 = Array.isArray(window.inprogress)? inprogress.find(function(r){ return r && String(r.id)===id2; }) : null;
            return {id:id2, rec:rec2||{}};
          }
        }
      }catch(_){}
      return {id:'', rec:{}};
    }
    function prefill(){
      // Determine scope from state; fallback to pending
      var scope = (window.state && state.currentTab==='inprogress') ? 'inprogress' : 'pending';
      var sel = getSelected(scope); var rec = sel.rec||{};
      // Fill inputs if they exist
      var map = {
        e_from: 'from',
        e_to: 'to',
        e_container: 'container',
        e_loadempty: 'loadempty',   // fallback to 'appt' below
        e_bkpin: 'bk',
        e_impexp: 'ie',
        e_seal: 'seal',
        e_window: 'window',
        e_instruction: 'remark'
      };
      Object.keys(map).forEach(function(k){
        var el = document.getElementById(k); if(!el) return;
        var key = map[k];
        var val = rec[key]; if((val==null || val==='') && key==='loadempty') val = rec.appt; // compatibility
        el.value = text(val);
      });
      // Dropdown labels (if present)
      try{ var dd1=document.getElementById('dd_loadempty'); if(dd1){ if(!dd1.textContent || !dd1.textContent.trim()) dd1.textContent = text(rec.loadempty || rec.appt || ''); } }catch(_){}
      try{ var dd2=document.getElementById('dd_impexp'); if(dd2){ if(!dd2.textContent || !dd2.textContent.trim()) dd2.textContent = text(rec.ie || ''); } }catch(_){}
      // Header pill
      try{
        var pill=document.getElementById('e_jobpill');
        if(pill){ pill.textContent = text(rec.id||'Job #') + (rec.window?(' • '+text(rec.window)):''); }
      }catch(_){}
    }
    // Wrap openEdit to prefill after it opens
    try{
      if(typeof window.openEdit === 'function' && !window.openEdit.__wrapped){
        var _orig = window.openEdit;
        window.openEdit = function(){ _orig.apply(this, arguments); setTimeout(prefill, 50); };
        window.openEdit.__wrapped = true;
      }
    }catch(_){}
    // Bind Edit buttons if not already bound
    function bindBtn(id){
      var btn = document.getElementById(id); if(!btn) return;
      if(btn.__cclBound) return; btn.__cclBound = true;
      btn.addEventListener('click', function(e){ 
        e.preventDefault(); 
        try{ if(typeof window.openEdit==='function'){ window.openEdit(); } }catch(_){}
      }, true);
    }
    bindBtn('btn_edit_pending');
    bindBtn('btn_ip_edit');
  });
})();
</script>
<!-- /SAFEGUARD -->
\n
<!-- SAFEGUARD: Persist Main Dispatch deletes across refresh (IDs only) -->
<script>
(function(){
  if(window.__CCL_DELETE_IDS_PERSIST__) return; window.__CCL_DELETE_IDS_PERSIST__=true;
  var KEY = 'ccl_pending_deleted_ids';
  
  // Also prune from persisted extras so deletes survive refresh even for newly created items
  function pruneExtrasByIds(ids){
    try{
      var k='ccl_pending_extras_v1';
      var raw=localStorage.getItem(k);
      if(!raw) return;
      var arr=JSON.parse(raw);
      if(!Array.isArray(arr)) return;
      var set=new Set(ids.map(String));
      var pruned=arr.filter(function(rec){ return !rec || !set.has(String(rec.id||'')); });
      if(pruned.length!==arr.length){ localStorage.setItem(k, JSON.stringify(pruned)); }
    }catch(_){ /*noop*/ }
  }

function loadSet(){ try{ return new Set(JSON.parse(localStorage.getItem(KEY)||'[]')); }catch(_){ return new Set(); } }
  function saveSet(S){ try{ localStorage.setItem(KEY, JSON.stringify(Array.from(S))); }catch(_){} }
  function selectedPendingIds(){
    try{ if(window.state && state.selectedPending && state.selectedPending.size){ return Array.from(state.selectedPending).map(String); } }catch(_){}
    var ids=[], body=document.getElementById('pending_body')||document.querySelector('#section_pending tbody');
    if(body){ Array.from(body.querySelectorAll('tr')).forEach(function(tr){ var cb=tr.querySelector('input[type="checkbox"]'); if(cb&&cb.checked){ ids.push(String(tr.dataset.id||'')); }}); }
    return ids.filter(Boolean);
  }
  function pruneFromMemory(S){
    try{ if(Array.isArray(window.pending) && S.size){ window.pending = pending.filter(function(r){ return !r || !S.has(String(r.id)); }); } }catch(_){}
  }
  function pruneFromDOM(S){
    try{
      var body=document.getElementById('pending_body')||document.querySelector('#section_pending tbody'); if(!body||!S.size) return;
      S.forEach(function(id){ var tr=body.querySelector('tr[data-id="'+CSS.escape(id)+'"]'); if(tr&&tr.parentNode){ tr.parentNode.removeChild(tr); } });
    }catch(_){}
    try{ if(typeof updateBadges==='function'){ updateBadges(); } }catch(_){}
  }
  function afterTick(fn){ setTimeout(fn,60); }
  function onLoad(){ var S=loadSet(); pruneFromMemory(S); afterTick(function(){ pruneFromDOM(S); }); }
  if(document.readyState!=='loading') onLoad(); else document.addEventListener('DOMContentLoaded', onLoad, {once:true});
  // Hook DELETE
  document.addEventListener('click', function(e){
    var btn=e.target.closest && e.target.closest('#btn_delete_pending'); if(!btn) return;
    var ids=selectedPendingIds(); if(!ids.length) return;
    afterTick(function(){ var S=loadSet(); ids.forEach(function(id){ S.add(String(id)); }); saveSet(S); pruneExtrasByIds(ids); try{ if(typeof window.cclResetPendingFilterIfMismatch==='function') window.cclResetPendingFilterIfMismatch(); }catch(_){ } }); }, true);
  // Hook CREATE/UPDATE -> remove from deleted set so item can return
  document.addEventListener('click', function(e){
    var btn=e.target.closest && e.target.closest('#btn_create_update'); if(!btn) return;
    afterTick(function(){ try{ var id=(document.getElementById('c_id')||{}).value||''; id=id&&String(id).trim(); if(!id) return; var S=loadSet(); if(S.delete(id)) saveSet(S); }catch(_){} });
  }, true);
})();
</script>
<!-- /SAFEGUARD -->


<!-- SAFEGUARD: Remove rogue '\n' or '/n' text nodes & enforce delete persistence/dedup -->
<script>
(function(){
  if(window.__CCL_FIX_N_AND_PERSIST__) return; window.__CCL_FIX_N_AND_PERSIST__=true;

  function cleanseTextNodes(){
    try{
      var w = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
      var rm = [];
      while(w.nextNode()){
        var n = w.currentNode, v = (n.nodeValue||'').trim();
        if(v === "\\n" || v === "/n"){ rm.push(n); }
      }
      rm.forEach(function(n){ if(n.parentNode) n.parentNode.removeChild(n); });
    }catch(e){}
  }

  var KEY='ccl_pending_deleted_ids';
  function loadDel(){ try{ return new Set(JSON.parse(localStorage.getItem(KEY)||'[]')); }catch(_){ return new Set(); } }
  function saveDel(S){ try{ localStorage.setItem(KEY, JSON.stringify(Array.from(S))); }catch(_){ } }

  function dedupPending(){
    try{
      if(!Array.isArray(window.pending)) return;
      var seen = new Set();
      window.pending = window.pending.filter(function(r){
        var id = r && String(r.id||'').trim();
        if(!id || seen.has(id)) return false;
        seen.add(id); return true;
      });
    }catch(_){}
  }

  function applyDeleted(){
    try{
      var S = loadDel();
      if(S.size && Array.isArray(window.pending)){
        window.pending = window.pending.filter(function(r){ return !r || !S.has(String(r.id)); });
      }
      var body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
      if(body && S.size){
        S.forEach(function(id){
          try{
            var tr = body.querySelector('tr[data-id="'+CSS.escape(String(id))+'"]');
            if(tr && tr.parentNode) tr.parentNode.removeChild(tr);
          }catch(_){}
        });
      }
    }catch(_){}
  }

  function afterTick(fn){ setTimeout(fn, 50); }

  function onLoad(){
    cleanseTextNodes();
    dedupPending();
    applyDeleted();
    try{ if(typeof renderPending==='function'){ renderPending(); } }catch(_){}
    try{ if(typeof updateBadges==='function'){ updateBadges(); } }catch(_){}
  }

  if(document.readyState !== 'loading') onLoad();
  else document.addEventListener('DOMContentLoaded', onLoad, {once:true});

  // Persist deletions
  document.addEventListener('click', function(e){
    var btn = e.target.closest && e.target.closest('#btn_delete_pending');
    if(!btn) return;
    // collect IDs using existing state/checkboxes
    function selectedIds(){
      try{
        if(window.state && state.selectedPending && state.selectedPending.size){
          return Array.from(state.selectedPending).map(String);
        }
      }catch(_){}
      var ids=[], body=document.getElementById('pending_body')||document.querySelector('#section_pending tbody');
      if(body){
        Array.from(body.querySelectorAll('tr')).forEach(function(tr){
          var cb = tr.querySelector('input[type="checkbox"]');
          if(cb && cb.checked) ids.push(String(tr.dataset.id||''));
        });
      }
      return ids.filter(Boolean);
    }
    var ids = selectedIds();
    if(!ids.length) return;
    afterTick(function(){
      var S = loadDel();
      ids.forEach(function(id){ S.add(String(id)); });
      saveDel(S);
    });
  }, true);

  // When creating/updating a Job #, allow it to appear again by removing from the deleted set
  document.addEventListener('click', function(e){
    var btn = e.target.closest && e.target.closest('#btn_create_update');
    if(!btn) return;
    afterTick(function(){
      try{
        var id = (document.getElementById('c_id')||{}).value||''; id = String(id).trim();
        if(!id) return;
        var S = loadDel();
        if(S.delete(id)) saveDel(S);
      }catch(_){}
    });
  }, true);
})();
</script>
<!-- /SAFEGUARD -->


<script>
// After render, remove any column whose header text is exactly "Job #"
(function(){
  function removeJobHashCols(context){
    var tables = (context || document).querySelectorAll('table');
    tables.forEach(function(table){
      try{
        var thead = table.tHead; if(!thead || !thead.rows || !thead.rows[0]) return;
        var hdr = thead.rows[0];
        var idx = -1;
        for(var i=0;i<hdr.cells.length;i++){
          var t = (hdr.cells[i].textContent||'').trim();
          if(t === 'Job #'){ idx = i; break; }
        }
        if(idx <= 0) return; // not found or it's the checkbox column (we keep that)
        // Remove header cell
        hdr.deleteCell(idx);
        // Remove cells at same index in body rows
        Array.from(table.tBodies||[]).forEach(function(tb){
          Array.from(tb.rows||[]).forEach(function(row){
            if(row.cells && row.cells.length > idx){
              row.deleteCell(idx);
            }
          });
        });
      }catch(e){ console.warn('remove Job # col err', e); }
    });
  }
  // Run on DOMContentLoaded and after small timeout to catch dynamic headers
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){ removeJobHashCols(); }, 100);
  }, {once:true});
  // Also observe DOM changes (in case tables render later)
  try{
    var mo = new MutationObserver(function(muts){ removeJobHashCols(); });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(_){}
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  function rebuildAll(){
    const sections = ['pending','pickups','assigned','inprogress','completed'];
    sections.forEach(function(sec){
      try{
        var thead = document.querySelector('#section_'+sec+' thead');
        if(thead){
          buildHeader(thead, true, false); // include checkbox, no driver
        }
      }catch(e){ console.warn('rebuildAll error', sec, e); }
    });
  }
  setTimeout(rebuildAll, 200);
});
</script>


<script>
/* === STICKY PREFILL (prevents 1s reset) === */
(function(){
  function $(sel, root){ return (root||document).querySelector(sel); }
  function qa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function text(el){ return (el && (el.textContent||'').trim()) || ''; }
  function setVal(id, v){ var e=document.getElementById(id); if(e){ e.value = v||''; } }
  function setDD(hiddenId, btnId, v){
    var hid=document.getElementById(hiddenId), btn=document.getElementById(btnId);
    if(hid) hid.value = v||'';
    if(btn) btn.textContent = v ? String(v) : 'Select…';
  }
  function headerKeys(table){
    var ths = qa('thead tr:first-child th', table);
    var offset = 0;
    if(ths.length && text(ths[0]) === '') offset += 1;      // checkbox
    if(ths.length > offset && /driver/i.test(text(ths[offset]))) offset += 1; // optional Driver col
    var keys = ths.slice(offset).map(function(th){
      return th.dataset.key ? th.dataset.key : text(th);
    });
    return {keys: keys, offset: offset};
  }
  function extractFromRow(tr){
    var table = tr.closest('table');
    var hk = headerKeys(table);
    var tds = qa('td', tr).slice(hk.offset);
    var map = {};
    tds.forEach(function(td, i){ map[hk.keys[i] || ('COL_'+i)] = text(td); });
    map.id = map['Job #'] || tr.getAttribute('data-id') || '';
    return map;
  }
  function applyToModal(map){
    setVal('e_from',        map['From'] || map['from'] || '');
    setVal('e_to',          map['To'] || map['to'] || '');
    setVal('e_container',   map['Container #'] || map['CONTAINER'] || map['container'] || '');
    setVal('e_bkpin',       map['BK # / PIN'] || map['bk'] || map['pin'] || '');
    setVal('e_seal',        map['Seal #'] || map['seal'] || '');
    setVal('e_window',      map['Window'] || map['window'] || '');
    setVal('e_instruction', map['Instruction'] || map['remark'] || '');
    setDD('e_loadempty', 'dd_loadempty', map['LOAD / EMPTY'] || map['APPT TIME'] || map['appt'] || '');
    setDD('e_impexp',    'dd_impexp',    map['Import / Export'] || map['ie'] || '');
    var pill = document.getElementById('e_jobpill');
    if(pill){ pill.textContent = map.id || 'Job #'; }
  }
  function isVisible(el){
    if(!el) return false;
    var s = window.getComputedStyle(el);
    return s.display !== 'none' && s.visibility !== 'hidden' && s.opacity !== '0';
  }
  function stickyFill(map){
    var modal = document.getElementById('edit_modal');
    var until = Date.now() + 1500; // keep enforcing for 1.5s
    // Guard: cancel any previous timer
    if(window.__prefillTimer){ clearInterval(window.__prefillTimer); window.__prefillTimer=null; }
    // Block form.reset during sticky window
    var form = modal ? modal.querySelector('form') : null;
    var origReset = form && form.reset;
    if(form){
      form.reset = function(){ /* swallow resets while sticky */ };
      form.addEventListener('reset', function(e){ e.preventDefault(); }, {once:true});
    }
    // First pass immediately
    applyToModal(map);
    window.__prefillTimer = setInterval(function(){
      if(Date.now() > until || !isVisible(modal)){
        clearInterval(window.__prefillTimer); window.__prefillTimer=null;
        if(form && origReset) form.reset = origReset;
        return;
      }
      // Re-apply if any field got cleared
      var needs = false;
      ['e_container','e_bkpin','e_seal','e_window','e_from','e_to','e_instruction'].forEach(function(id){
        var el=document.getElementById(id);
        if(el && el.value === '') needs = true;
      });
      var dd1=document.getElementById('e_impexp'); var dd2=document.getElementById('e_loadempty');
      if((dd1 && dd1.value==='') || (dd2 && dd2.value==='')) needs=true;
      if(needs) applyToModal(map);
    }, 40);
    // Also stop on Save/Cancel
    ['btn_modal_cancel','btn_modal_save','btn_modal_close'].forEach(function(id){
      var b=document.getElementById(id);
      if(b){ b.addEventListener('click', function(){ if(window.__prefillTimer){ clearInterval(window.__prefillTimer); window.__prefillTimer=null; if(form && origReset) form.reset = origReset; }}, {once:true}); }
    });
  }
  function selectedRow(){
    return document.querySelector('#section_pending tbody input[type="checkbox"]:checked')?.closest('tr')
        || document.querySelector('#section_pending tbody tr.selected')
        || null;
  }
  function openModal(){ var m=document.getElementById('edit_modal'); if(m){ m.style.display='flex'; } }
  function bind(){
    var btn=document.getElementById('btn_edit_pending'); if(!btn) return;
    btn.addEventListener('click', function(){
      var tr = selectedRow();
      if(!tr){ if(window.toast){ toast('Select a row first'); } return; }
      var map = extractFromRow(tr);
      openModal();
      // Apply, then keep sticky for short time to defeat clearing code
      setTimeout(function(){ stickyFill(map); }, 10);
    }, true);
  }
  if(document.readyState !== 'loading'){ bind(); } else { document.addEventListener('DOMContentLoaded', bind, {once:true}); }
})();
</script>


<!-- === CCL MONOTONIC JOB ID PATCH v1 (non-invasive) === -->
<script>
(function(){
  const LS_KEY_LAST = "ccl_last_job_num_v1";   // numeric part, e.g., 5007
  const PREFIX = "CCL-";
  const START_AT = 5001;

  function readLast(){
    const v = parseInt(localStorage.getItem(LS_KEY_LAST), 10);
    return Number.isFinite(v) ? v : null;
  }
  function writeLast(n){
    try{ localStorage.setItem(LS_KEY_LAST, String(n)); }catch(_){}
  }
  function scanHighestFromList(list){
    let maxN = 0;
    (list||[]).forEach(r => {
      const m = String(r && r.id || "").match(/^CCL-(\d{4,})$/);
      if(m){
        const n = parseInt(m[1], 10);
        if(Number.isFinite(n)) maxN = Math.max(maxN, n);
      }
    });
    return maxN || null;
  }

  // Public API: next id and commit id
  window.getNextJobNumber = function(){
    let last = readLast();
    if(last == null){
      // Seed from whatever arrays exist globally
      const all = []
        .concat(Array.isArray(window.pending)?window.pending:[])
        .concat(Array.isArray(window.pickups)?window.pickups:[])
        .concat(Array.isArray(window.assigned)?window.assigned:[])
        .concat(Array.isArray(window.inprogress)?window.inprogress:[])
        .concat(Array.isArray(window.completed)?window.completed:[]);
      const inferred = scanHighestFromList(all);
      last = (inferred != null ? inferred : (START_AT-1));
    }
    return PREFIX + String(last + 1);
  };
  window.commitJobId = function(id){
    const m = String(id||"").match(/^CCL-(\d{4,})$/);
    if(!m) return;
    const n = parseInt(m[1], 10);
    const last = readLast();
    if(last == null || n > last) writeLast(n);
  };

  // Prefill #c_id whenever Create modal opens
  function tryPrefill(){
    const idEl = document.getElementById('c_id');
    if(idEl){ idEl.value = window.getNextJobNumber(); idEl.readOnly = true; }
  }

  // Hook: Create New button
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    if(t.id === 'btn_create_pending' || (t.closest && t.closest('#btn_create_pending'))){
      // Give any existing open/create logic a frame to run first
      setTimeout(tryPrefill, 50);
    }
  }, true);

  // Hook: when Update is clicked, commit the ID so it never reuses
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    if(t.id === 'btn_create_update' || (t.closest && t.closest('#btn_create_update'))){
      setTimeout(function(){
        const idEl = document.getElementById('c_id');
        if(idEl && idEl.value){ window.commitJobId(idEl.value.trim()); }
      }, 10);
    }
  }, true);

  // Safety: observe the create modal becoming visible and prefill
  const cm = document.getElementById('create_modal');
  if(cm && 'IntersectionObserver' in window){
    const obs = new MutationObserver(() => {
      const style = getComputedStyle(cm);
      if(style.display !== 'none' && style.visibility !== 'hidden'){ tryPrefill(); }
    });
    obs.observe(cm, { attributes:true, attributeFilter:['style','class'] });
  }

  // One-time seed LAST from DOM, if empty
  (function bootstrap(){
    if(readLast() != null) return;
    let maxSeen = 0;
    try{
      const cells = document.querySelectorAll('tbody td:first-child, tbody td[data-col="id"]');
      cells.forEach(td => {
        const txt = (td.textContent || '').trim();
        const m = txt.match(/^CCL-(\d{4,})/);
        if(m){ const n = parseInt(m[1], 10); if(Number.isFinite(n)) maxSeen = Math.max(maxSeen, n); }
      });
    }catch(_){}
    if(maxSeen > 0){ writeLast(maxSeen); }
  })();
})();
</script>
<!-- === /CCL MONOTONIC JOB ID PATCH v1 === -->


<script>
// === CCL Inline Cell Editing (no modal) — v1 ===
// Works on all tables. Double‑click any data cell to edit directly.
// Saves back into the correct in‑memory array (pending/assigned/inprogress/pickups/completed).
// Also persists pending edits to localStorage (ccl_pending_extras_v1) so they stick on refresh
// with your existing seed mechanism.

(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function tableMeta(td){
    const tr = td.closest('tr'); if(!tr) return null;
    const tbody = tr.parentElement; if(!tbody) return null;
    const table = tbody.closest('table'); if(!table) return null;
    const thead = table.querySelector('thead'); if(!thead || !thead.rows.length) return null;
    const hdr = thead.rows[0];
    const colIdx = Array.prototype.indexOf.call(tr.children, td);
    if(colIdx < 0) return null;
    const th = hdr.children[colIdx];
    // Determine key for this column
    let key = th && th.dataset ? th.dataset.key : null;
    // Skip non-data columns (checkbox / Driver) and unknowns
    const label = th ? (th.textContent||'').trim().toUpperCase() : '';
    if(!key){
      if(label === '' /* checkbox col */ || label === 'DRIVER'){ return null; }
      // fallback: map by label when dataset.key missing
      const L = {
        'JOB':'id','CONTAINER':'container','CHASSIS':'chassis','SIZE TYPE':'size','PIN':'pin',
        'IMPORT / EXPORT':'ie','BK/EDO':'bk','PICK PORT':'from','P/U DATE':'pudate','APPT TIME':'appt',
        'DEL DATE':'deliveryDate','DELIVERY':'to','LFD DATE':'lfd','RETURN DATE':'returnDate',
        'RETURN PORT':'returnPort','CUSTOMER':'customer','REMARK':'remark','CARRIER NAME':'carrier',
        'MB/L NO.':'mbl','DROP / LIVE':'status','DATE OF ARRIVAL':'arrival'
      };
      key = L[label] || null;
    }
    if(!key) return null;

    // Determine which dataset this tbody represents
    const tbid = (tbody.id||'').toLowerCase();
    let arrName = null;
    if(tbid.includes('pending')) arrName = 'pending';
    else if(tbid.includes('assigned')) arrName = 'assigned';
    else if(tbid.includes('inprogress')) arrName = 'inprogress';
    else if(tbid==='p1_body' || tbid.includes('pickup')) arrName = 'pickups';
    else if(tbid.includes('completed')) arrName = 'completed';
    if(!arrName) return null;

    // Row identity
    let rowId = tr.getAttribute('data-id');
    if(!rowId){
      // Fallback: try to find the 'JOB' cell in this row by looking up header for 'id'
      // Find the header index for key 'id'
      let idCol = -1;
      for(let i=0;i<hdr.children.length;i++){
        if(hdr.children[i].dataset && hdr.children[i].dataset.key==='id'){ idCol = i; break; }
        const txt = (hdr.children[i].textContent||'').trim().toUpperCase();
        if(idCol<0 && txt==='JOB') idCol = i;
      }
      if(idCol>=0 && tr.children[idCol]){
        rowId = tr.children[idCol].textContent.trim();
      }
    }
    return {tr, tbody, table, thead, colIdx, th, key, arrName, rowId};
  }

  function getArrayByName(name){
    // Guard for missing globals
    try{
      if(name==='pending') return window.pending || [];
      if(name==='assigned') return window.assigned || [];
      if(name==='inprogress') return window.inprogress || [];
      if(name==='pickups') return window.pickups || [];
      if(name==='completed') return window.completed || [];
    }catch(_){}
    return [];
  }

  function persistIfNeeded(name){
    // Persist pending into your existing localStorage key so refresh keeps edits
    if(name==='pending'){
      try{ localStorage.setItem('ccl_pending_extras_v1', JSON.stringify(window.pending||[])); }catch(_){}
    }
  }

  function renderCell(td, value){
    // Minimal normalization: empty -> em dash, else plain text
    const v = (value==null || String(value).trim()==='') ? '—' : String(value);
    td.innerHTML = '';
    const span = document.createElement('span');
    // Keep centered dash look
    if(v==='—'){ span.className = 'dash-center'; }
    span.textContent = v;
    td.appendChild(span);
  }

  function makeEditor(td, currentText){
    // Use <input> for single-line; if original cell had a newline, use <textarea>
    const multiline = /\n/.test(currentText);
    const ed = multiline ? document.createElement('textarea') : document.createElement('input');
    if(!multiline) ed.type = 'text';
    ed.value = (currentText==='—' ? '' : currentText);
    ed.style.width = '100%';
    ed.style.background = '#0f172a';
    ed.style.color = '#e6edf7';
    ed.style.border = '1px solid #334155';
    ed.style.borderRadius = '8px';
    ed.style.padding = '6px 8px';
    ed.style.minHeight = multiline ? '64px' : 'auto';
    return ed;
  }

  function beginEdit(td){
    const meta = tableMeta(td);
    if(!meta || meta.arrName!=='pending'){ return; }
    if(!meta) return;
    const { key, arrName, rowId, tr, colIdx } = meta;

    // Do not allow editing checkbox/status if you want; here we allow everything except checkbox col
    // You can special-case 'status' to keep dash behavior—already handled in renderCell.

    // Current cell text
    const currentText = td.textContent.trim();
    // If an editor already exists, skip
    if(td.querySelector('input,textarea')) return;

    const editor = makeEditor(td, currentText);
    td.innerHTML = '';
    td.appendChild(editor);
    editor.focus();
    // place caret at end
    try{ const len = editor.value.length; editor.setSelectionRange && editor.setSelectionRange(len, len); }catch(_){}

    function commit(){
      const newValRaw = editor.value;
      const newVal = newValRaw.trim();
      const oldDisplay = (currentText === '—' ? '' : currentText);
      if(newVal === oldDisplay){ renderCell(td, currentText); return; }
      const colLabel = (meta.th && (meta.th.textContent||'').trim()) || key;
      const jobLabel = meta.rowId ? meta.rowId : '(no job id)';
      if (commit._called) { return; }
      commit._called = true;

      // Always open our modal; add a safety fallback to alert if missing
      const ask = (window.__ccl_inline_confirm ? window.__ccl_inline_confirm : (data)=>{
        const ok = window.confirm(`Save change?\n\nJob: ${data.job}\nField: ${data.field}\n\nFrom: "${data.old}"\nTo:   "${data.new}"`);
        return Promise.resolve(ok);
      });
      ask({job: jobLabel, field: colLabel, old: oldDisplay, new: newVal}).then(function(proceed){
        if(!proceed){
          renderCell(td, currentText);
          commit._called = false;
          return;
        }
        const arr = getArrayByName(arrName);
        if(rowId && Array.isArray(arr)){
          const idx = arr.findIndex(x => (x && (x.id===rowId || String(x.id).trim()===String(rowId).trim())));
          if(idx >= 0){
            arr[idx][key] = newVal;
            renderCell(td, newVal);
            if(key==='id'){ tr.setAttribute('data-id', newVal); }
            persistIfNeeded(arrName);
          }else{
            renderCell(td, newVal);
          }
        }else{
          renderCell(td, newVal);
        }
        commit._called = false;
      });
    }}

    function cancel(){
      // Restore original without changing array
      renderCell(td, currentText);
    }

    editor.addEventListener('keydown', function(ev){
      if(ev.key==='Enter' && !(ev.shiftKey || ev.ctrlKey || ev.metaKey)){ commit._called = false;
        ev.preventDefault();
        editor.blur();
      }else if(ev.key==='Escape'){
        ev.preventDefault();
        cancel();
      }
    });
    editor.addEventListener('blur', commit, {once:true});
  }

  ready(function(){
    // Delegate dblclick on every table body cell
    document.getElementById('section_pending').addEventListener('dblclick', function(ev){
      // Prevent legacy modal from triggering on dblclick
      try{ ev.stopPropagation(); ev.preventDefault(); }catch(_){}
      const td = ev.target && ev.target.closest ? ev.target.closest('td') : null;
      if(!td) return;
      // Avoid editing the selection checkbox column (usually first col)
      const tr = td.closest('tr');
      const isCheckboxCol = td.cellIndex === 0;
      if(isCheckboxCol) return;
      beginEdit(td);
    }, true);
  });
})();
</script>


<!-- Inline Edit Confirmation Modal -->
<style>
#inline_confirm_modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(2,6,23,.75);}
#inline_confirm_modal .card{background:#0b1220;border:1px solid #334155;border-radius:14px;padding:14px;max-width:440px;width:92%;box-shadow:0 18px 40px rgba(0,0,0,.6);}
#inline_confirm_modal h4{margin:0 0 8px 0;color:#e6edf7;font-size:16px;font-weight:700;}
#inline_confirm_modal .kv{font-size:12px;color:#a9bdd7;margin:6px 0;}
#inline_confirm_modal .kv b{color:#dbe7ff;}
#inline_confirm_modal .diff{background:#0f172a;border:1px solid #2b3a55;border-radius:10px;padding:8px;margin-top:8px;color:#e6edf7;font-size:13px;white-space:pre-wrap;}
#inline_confirm_modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
#inline_confirm_modal .btn{padding:8px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e6edf7;cursor:pointer;}
#inline_confirm_modal .btn.primary{background:#2563eb;border-color:#1d4ed8;color:#fff;}
#inline_confirm_modal .btn:hover{filter:brightness(1.05);}
</style>
<div id="inline_confirm_modal" aria-modal="true" role="dialog">
  <div class="card">
    <h4>Confirm change?</h4>
    <div class="kv"><b>Job:</b> <span id="icm_job">—</span></div>
    <div class="kv"><b>Field:</b> <span id="icm_field">—</span></div>
    <div class="diff"><b>From:</b> <span id="icm_old">—</span>\n<b>To:</b> <span id="icm_new">—</span></div>
    <div class="actions">
      <button class="btn" id="icm_cancel">Cancel</button>
      <button class="btn primary" id="icm_save">Save</button>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('inline_confirm_modal');
  const fJob = document.getElementById('icm_job');
  const fField = document.getElementById('icm_field');
  const fOld = document.getElementById('icm_old');
  const fNew = document.getElementById('icm_new');
  const btnCancel = document.getElementById('icm_cancel');
  const btnSave = document.getElementById('icm_save');
  let _resolver = null;

  function openModal(data){
    fJob.textContent = data.job || '—';
    fField.textContent = data.field || '—';
    fOld.textContent = data.old || '';
    fNew.textContent = data.new || '';
    modal.style.display = 'flex';
    return new Promise(res => { _resolver = res; });
  }
  function closeModal(){ modal.style.display = 'none'; }

  btnCancel.addEventListener('click', function(){ if(_resolver){ _resolver(false); } closeModal(); });
  btnSave.addEventListener('click', function(){ if(_resolver){ _resolver(true); } closeModal(); });

  // Expose to inline editor
  window.__ccl_inline_confirm = openModal;
})();
</script>


<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const LS_KEY = 'ccl_customers_v1';
    const SEED_LIST = ["MEARSK","WAN- HAI","YANG MING","EVER GREEN","MSC","ZIM LINE","OCCL","SEA LAND","SIM LINE","CMA","TS LINES","ANL","HAG PAG","COSCO","HMM","APL"];
    const ddBtn = document.getElementById('c_dd_customer');
    const ddMenu = document.getElementById('c_menu_customer');
    const inName = document.getElementById('c_customer');
    const inTo = document.getElementById('c_to');
    const inEmail = document.getElementById('c_email');
    const inPhone = document.getElementById('c_phone');
    const btnSave = document.getElementById('c_btn_save_customer');
    const btnDel  = document.getElementById('c_btn_delete_customer');

    if(!ddBtn || !ddMenu) return;
    ensureSeed();

    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function ensureSeed(){ const map = load(); if(Object.keys(map).length===0){ SEED_LIST.forEach(n=>map[n]={}); try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch(_){} } }
    function save(map){ try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch(_){ } }
    function renderMenu(active){
      const map = load();
      ddMenu.innerHTML = '';
      const keys = Object.keys(map).sort((a,b)=>a.localeCompare(b));
      if(!keys.length){
        const empty = document.createElement('div');
        empty.textContent = 'No customers yet';
        empty.style.opacity = .7;
        ddMenu.appendChild(empty);
      } else {
        keys.forEach(name=>{
          const div = document.createElement('div');
          div.textContent = name;
          div.dataset.name = name;
          if(name===active){ div.style.background = '#111827'; }
          div.addEventListener('click', ()=>selectCustomer(name));
          ddMenu.appendChild(div);
        });
      }
    }
    
    function placeMenu(){
      const r = ddBtn.getBoundingClientRect();
      ddMenu.style.left = (Math.round(r.left)+window.scrollX) + 'px';
      ddMenu.style.top  = (Math.round(r.bottom)+window.scrollY) + 'px';
      ddMenu.style.width = Math.round(r.width) + 'px';
    }

    function openMenu(){
      ddMenu.classList.remove('hidden');
      renderMenu(inName.value||'');
      placeMenu();
      const close = (ev)=>{
        if(!ddMenu.contains(ev.target) && ev.target!==ddBtn){
          ddMenu.classList.add('hidden');
          document.removeEventListener('click', close, true);
        }
      };
      setTimeout(()=>document.addEventListener('click', close, true), 0);
      window.addEventListener('resize', placeMenu);
      window.addEventListener('scroll', placeMenu, true);
    }
    function selectCustomer(name){
  const map = load();
  const rec = map[name] || null;
  inName.value = name;
  ddBtn.textContent = name;
  // Always clear first, then prefill
  try{ inTo.value = ''; inEmail.value = ''; inPhone.value = ''; }catch(_){}
  if(rec){
    try{ if(rec.to!==undefined) inTo.value = rec.to; }catch(_){}
    try{ if(rec.email!==undefined) inEmail.value = rec.email; }catch(_){}
    try{ if(rec.phone!==undefined) inPhone.value = rec.phone; }catch(_){}
  }
  ddMenu.classList.add('hidden');
}
; map[name] = rec; }
      inName.value = name;
      ddBtn.textContent = name;
      try{ inTo.value = rec.to||''; }catch(_){}
      try{ inEmail.value = rec.email||''; }catch(_){}
      try{ inPhone.value = rec.phone||''; }catch(_){}
      ddMenu.classList.add('hidden');
    }
    function addOrUpdate(){
  let name = (ddBtn.textContent||'').trim();
  if(!name || name==='Select…'){ name = prompt('Customer name:'); }
  if(!name) return;
  const map = load();
  map[name] = { to: (inTo.value||'').trim(), email: (inEmail.value||'').trim(), phone: (inPhone.value||'').trim() };
  save(map);
  inName.value = name; ddBtn.textContent = name;
  renderMenu(name);
  selectCustomer(name);
  if(window.toast) toast('Customer saved');
};
      save(map);
      inName.value = name;
      ddBtn.textContent = name;
      renderMenu(name);
      if(window.toast) toast('Customer saved');
    }
    function del(){
      const name = inName.value || ddBtn.textContent;
      if(!name || name==='Select…') return;
      if(!confirm('Delete \"'+name+'\"?')) return;
      const map = load(); delete map[name]; save(map);
      inName.value=''; ddBtn.textContent='Select…';
      if(window.toast) toast('Customer deleted');
      renderMenu('');
    }
    function attachConfirm(el, field){
      if(!el) return;
      el.addEventListener('change', function(){
        const name = inName.value;
        if(!name) return;
        const map = load(); let rec = map[name]; if(!rec){ rec = {}; map[name] = rec; }
        const newVal = (el.value||'').trim();
        const oldVal = (rec[field]||'').trim();
        if(newVal !== oldVal){
          const cm = document.getElementById('confirm_modal');
          const setYes = ()=>{ rec[field] = newVal; save(map); if(window.toast) toast('Updated '+field+' for '+name); };
          if(cm){
            const txt = document.getElementById('confirm_text');
            const yes = document.getElementById('confirm_yes');
            const no  = document.getElementById('confirm_no');
            txt.textContent = 'Update saved '+field+' for \"'+name+'\"?';
            cm.style.display='flex';
            const clean = ()=>{ yes.removeEventListener('click', onYes); no.removeEventListener('click', onNo); };
            function onYes(){ setYes(); cm.style.display='none'; clean(); }
            function onNo(){ cm.style.display='none'; clean(); }
            yes.addEventListener('click', onYes, {once:true});
            no.addEventListener('click', onNo, {once:true});
          } else {
            if(window.confirm('Update saved '+field+' for \"'+name+'\"?')) setYes();
          }
        }
      });
    }

    ddBtn.addEventListener('click', openMenu);

    function autoOpen(){
      ddMenu.classList.remove('hidden');
      renderMenu(inName.value||'');
      placeMenu();
    }
    ddBtn.addEventListener('focus', autoOpen);

    btnSave && btnSave.addEventListener('click', addOrUpdate);
    btnDel && btnDel.addEventListener('click', del);
    attachConfirm(inTo, 'to');
    attachConfirm(inEmail, 'email');
    attachConfirm(inPhone, 'phone');
    renderMenu(inName.value||'');
  });
})();
</script>

</body></html><script>
    function openGpsTab(){
      // Build HTML and open as a Blob URL in a NEW TAB
      const html = buildGpsHtml();
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      // _blank + no features => browser opens a new tab
      const w = window.open(url, '_blank'); 
      if(!w){ alert('Pop-up blocked. Allow pop-ups for this site and try again.'); return; }
      // Optional: keep dispatch in focus (some browsers respect this)
      try{ window.focus(); }catch(_){}
      // Revoke the blob URL later (when the tab loads) to avoid leaks
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    btn.onclick = openGpsTab;
    btn.onkeydown = function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openGpsTab(); } };
  });
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>
<script>
// ===== CREATE NEW (Full-screen modal) =====
const createModal = document.getElementById('create_modal');
function openCreate(){
  if(!createModal) return;
  // Reset fields
  ['c_id','c_window','c_from','c_to','c_container','c_bkpin','c_seal','c_appt','c_pudate','c_deliveryDate','c_lfd','c_returnDate','c_returnPort','c_customer','c_chassis','c_size','c_pin','c_instruction']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  const leTrig = document.getElementById('c_dd_loadempty'); if(leTrig) leTrig.textContent='Select…';
  const ieTrig = document.getElementById('c_dd_impexp'); if(ieTrig) ieTrig.textContent='Select…';
  const leHid = document.getElementById('c_loadempty'); if(leHid) leHid.value='';
  const ieHid = document.getElementById('c_impexp'); if(ieHid) ieHid.value='';
  createModal.style.display='flex';
  try{
    initDropdown('c_dd_loadempty','c_menu_loadempty', document.getElementById('c_loadempty'));
    initDropdown('c_dd_impexp','c_menu_impexp', document.getElementById('c_impexp'));
  }catch(_){}
}
function closeCreate(){ if(createModal) createModal.style.display='none'; }
document.getElementById('btn_create_pending')?.addEventListener('click', openCreate);
document.getElementById('btn_create_cancel')?.addEventListener('click', function(){ openConfirm('Confirm cancel? Your entries will be lost.', closeCreate); });
document.getElementById('btn_create_update')?.addEventListener('click', function(){
  const id = (document.getElementById('c_id')?.value||'').trim();
  if(!id){ toast('Enter a Job #'); return; }
  const rec = {
    id,
    from: (document.getElementById('c_from')?.value||'').trim(),
    to: (document.getElementById('c_to')?.value||'').trim(),
    container: (document.getElementById('c_container')?.value||'').trim(),
    appt: (document.getElementById('c_loadempty')?.value||'').trim(), // Load/Empty mapping (keeps schema)
    bk: (document.getElementById('c_bkpin')?.value||'').trim(),
    ie: (document.getElementById('c_impexp')?.value||'').trim(),
    seal: (document.getElementById('c_seal')?.value||'').trim(),
    window: (document.getElementById('c_window')?.value||'').trim(),
    remark: (document.getElementById('c_instruction')?.value||'').trim(),
    pudate: (document.getElementById('c_pudate')?.value||'').trim(),
    deliveryDate: (document.getElementById('c_deliveryDate')?.value||'').trim(),
    lfd: (document.getElementById('c_lfd')?.value||'').trim(),
    returnDate: (document.getElementById('c_returnDate')?.value||'').trim(),
    returnPort: (document.getElementById('c_returnPort')?.value||'').trim(),
    customer: (document.getElementById('c_customer')?.value||'').trim(),
    chassis: (document.getElementById('c_chassis')?.value||'').trim(),
    size: (document.getElementById('c_size')?.value||'').trim(),
    pin: (document.getElementById('c_pin')?.value||'').trim(),
    status: 'Pending'
  };
  openConfirm('Create this new pickup in Main Dispatch?', function(){
    pending.unshift(rec);
    renderPending(); updateBadges(); closeCreate(); switchTab('pending'); toast('Pickup created');
  });
});
</script>
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var cancelBtn = document.getElementById('btn_create_cancel');
    var updateBtn = document.getElementById('btn_create_update');
    // Rebind by cloning to remove old listeners
    function rebind(el, handler){
      if(!el) return null;
      var clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      clone.addEventListener('click', function(e){
        e.preventDefault();
        handler();
      });
      return clone;
    }
    function doCancel(){
      if(typeof openConfirm==='function'){
        openConfirm('Confirm cancel? Your entries will be lost.', function(){
          var modal = document.getElementById('create_modal');
          if(modal) modal.style.display='none';
        });
      }
    }
    function doUpdate(){
      if(typeof openConfirm!=='function'){ return; }
      openConfirm('Create this new pickup in Main Dispatch?', function(){
        // Collect and push (same as previous logic)
        function gv(id){ var el=document.getElementById(id); return (el && el.value||'').trim(); }
        var rec = {
          id: gv('c_id'),
          from: gv('c_from'),
          to: gv('c_to'),
          container: gv('c_container'),
          appt: gv('c_loadempty'),
          bk: gv('c_bkpin'),
          ie: gv('c_impexp'),
          seal: gv('c_seal'),
          window: gv('c_window'),
          remark: gv('c_instruction'),
          pudate: gv('c_pudate'),
          deliveryDate: gv('c_deliveryDate'),
          lfd: gv('c_lfd'),
          returnDate: gv('c_returnDate'),
          returnPort: gv('c_returnPort'),
          customer: gv('c_customer'),
          chassis: gv('c_chassis'),
          size: gv('c_size'),
          pin: gv('c_pin'),
          status: 'Pending'
        };
        if(!rec.id){ toast && toast('Enter a Job #'); return; }
        try{
          pending.unshift(rec);
          if(typeof renderPending==='function') renderPending();
          if(typeof updateBadges==='function') updateBadges();
          var modal = document.getElementById('create_modal'); if(modal) modal.style.display='none';
          if(typeof switchTab==='function') switchTab('pending');
          toast && toast('Pickup created');
        }catch(e){ console.error(e); }
      });
    }
    cancelBtn = rebind(cancelBtn, doCancel);
    updateBtn = rebind(updateBtn, doUpdate);
  });
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>

<script>
(function(){
  const ETA_BASELINES={'DSV':40,'APM TERMINALS':40,'SSA MARINE':35,'FENIX':45,'TRAPAC':30,'EVERPORT':35,'YUSEN':30};
  function baselineForCustomer(n){ if(!n) return 40; const u=String(n).toUpperCase(); for(const k in ETA_BASELINES){ if(u.includes(k)) return ETA_BASELINES[k]; } return 40; }
  function parseCustomer(s){ if(!s) return ''; const m=String(s).replace(/^enoute/i,'Enroute').match(/(?:Enroute|Arrived)\s*(?:To|At)?\s*[:\-]?\s*(.*)$/i); return m&&m[1]?m[1].trim():''; }
  function fmtHM(t){ const d=t instanceof Date?t:new Date(t); if(isNaN(d)) return '—'; const h=String(d.getHours()).padStart(2,'0'), m=String(d.getMinutes()).padStart(2,'0'); return h+':'+m; }
  function fmtElapsed(ms){ if(!ms||ms<0) return '—'; const mm=Math.floor(ms/60000); if(mm<60) return mm+' mins'; const h=Math.floor(mm/60), m=mm%60; return h+'h '+m+'m'; }
  function arr(){ return (typeof drivers!=='undefined'?drivers:(window.drivers=window.drivers||[])); }
  function tick(){
    const a=arr(), now=Date.now();
    a.forEach(d=>{
      const s=(d.status||'').trim(), cust=parseCustomer(s);
      if(!d.phase){ d.phase=/^enroute\b/i.test(s)?'ENROUTE':(/^arrived\b/i.test(s)?'ARRIVED':'OTHER'); }
      if(!d.phaseStartedAt && (d.phase==='ENROUTE'||d.phase==='ARRIVED')) d.phaseStartedAt=now;
      if(d.phase==='ENROUTE'){
        const exp=d.expectedMins||baselineForCustomer(cust), start=d.phaseStartedAt||now;
        d.etaStr=fmtHM(start+exp*60000); const el=now-start; d._elapsedStr=fmtElapsed(el); d._isLate=(el/60000) > exp+5; if(d._isLate){ d._elapsedStr = d._elapsedStr + ' (Exp. ' + exp + 'm)'; }
      }else if(d.phase==='ARRIVED'){
        d.etaStr='—'; const el=now-(d.phaseStartedAt||now); d._elapsedStr=fmtElapsed(el); d._isLate=false;
      }else{ d.etaStr='—'; d._elapsedStr='—'; d._isLate=false; }
    });
    if(typeof renderDrivers==='function') renderDrivers();
  }
  setInterval(tick,30000); window.addEventListener('load', ()=>setTimeout(tick,300));
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<!-- DEMO INIT FOR DRIVERS -->
<script>
(function(){
  const now = Date.now();
  try{
    if(Array.isArray(drivers)){
      const byEmp = id => drivers.find(d => String(d.empId)===String(id));
      let d;
      d = byEmp('53939'); if(d){ d.status='Arrived : APM Terminals (Pier 400)'; d.phase='ARRIVED'; d.phaseStartedAt=now-12*60000; }
      d = byEmp('54545'); if(d){ d.status='Enroute : SSA Marine (Pier A)'; d.phase='ENROUTE'; d.phaseStartedAt=now-55*60000; d.expectedMins=35; }
      d = byEmp('554421'); if(d){ d.status='Arrived : Fenix Marine Services (Pier 300)'; d.phase='ARRIVED'; d.phaseStartedAt=now-8*60000; }
      d = byEmp('598771'); if(d){ d.status='Enroute : TraPac Terminal (Pier G)'; d.phase='ENROUTE'; d.phaseStartedAt=now-50*60000; d.expectedMins=30; }
    }
  }catch(_){}
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<!-- DRIVER MESSAGE MODAL -->
<style>
#driverMsgOverlay{ position:fixed; inset:0; background:rgba(2,8,23,.55); display:none; z-index:1000; }
#driverMsgModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1001; }
#driverMsgModal .card{ width:480px; max-width:92vw; background:#0b1322; border:1px solid #1f2a44; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.5); color:#e5edf8; }
#driverMsgModal .hd{ padding:16px 18px; border-bottom:1px solid #1e2a43; font-size:18px; font-weight:700; }
#driverMsgModal .bd{ padding:16px 18px; }
#driverMsgModal label{ display:block; font-size:13px; opacity:.85; margin-bottom:6px; }
#driverMsgModal .to{ margin-bottom:12px; font-weight:600; }
#driverMsgModal textarea{ width:100%; min-height:120px; background:#0a1220; color:#dbeafe; border:1px solid #2a3a5d; border-radius:12px; padding:10px 12px; resize:vertical; }
#driverMsgModal .ft{ display:flex; gap:10px; justify-content:flex-end; padding:14px 18px 18px; }
#driverMsgModal .btn{ height:38px; padding:0 16px; border-radius:10px; border:1px solid #2a3a5d; background:#0f172a; color:#e5edf8; cursor:pointer; }
#driverMsgModal .btn.primary{ background:linear-gradient(90deg,#1ea0ff,#47e9ff); color:#0b1322; border:0; font-weight:700; }
#driverMsgModal .btn:hover{ filter:brightness(1.05); }
</style>
<div id="driverMsgOverlay"></div>
<div id="driverMsgModal" role="dialog" aria-modal="true" aria-labelledby="driverMsgTitle">
  <div class="card">
    <div class="hd" id="driverMsgTitle">Message Driver</div>
    <div class="bd">
      <div class="to" id="driverMsgTo">To: —</div>
      <label for="driverMsgText">Message</label>
      <textarea id="driverMsgText" placeholder="Type your message…"></textarea>
    </div>
    <div class="ft">
      <button class="btn" id="driverMsgCancel">Cancel</button>
      <button style="background-color:#2563eb; color:white; padding:0.5rem 1rem; border-radius:0.5rem;" onmouseover="this.style.backgroundColor=\'#1d4ed8\'" onmouseout="this.style.backgroundColor=\'#2563eb\'">Update Driver</button>
    </div>
  </div>
</div>
<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const overlay = $('#driverMsgOverlay');
  const modal = $('#driverMsgModal');
  const elTo  = $('#driverMsgTo');
  const elText= $('#driverMsgText');
  const btnCancel = $('#driverMsgCancel');
  const btnSend   = $('#driverMsgSend');
  let currentEmp = null;

  function openModal(empId, driverName){
    currentEmp = empId || null;
    elTo.textContent = 'To: ' + (driverName||empId||'—');
    elText.value='';
    overlay.style.display='block';
    modal.style.display='flex';
    elText.focus();
  }
  function closeModal(){
    overlay.style.display='none';
    modal.style.display='none';
  }
  overlay.addEventListener('click', closeModal);
  btnCancel.addEventListener('click', closeModal);
  btnSend.addEventListener('click', function(){
    const msg = elText.value.trim();
    if(!msg) { elText.focus(); return; }
    if(typeof onDriverMessage==='function'){
      try{ onDriverMessage(currentEmp, msg); }catch(_){}
    } else {
      console.log('Send to driver', currentEmp, msg);
    }
    closeModal();
  });

  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('.msg-btn');
    if(!btn) return;
    const emp = btn.getAttribute('data-emp') || '';
    let name = emp;
    try{
      if(Array.isArray(drivers)){
        const d = drivers.find(dd => String(dd.empId)===String(emp));
        if(d) name = d.name || name;
      }
    }catch(_){}
    openModal(emp, name);
  });
  if(typeof renderDrivers==='function'){ try{ renderDrivers(); }catch(_){} }
})();
</script>


<script>
// DEMO INIT EXTRA ETA
window.addEventListener('load', function(){
  try{
    if(typeof updateDriverETA==='function'){
      updateDriverETA({ employeeId:'54545', minutesRemaining: 6, expectedMins: 35 });
      updateDriverETA({ employeeId:'598771', minutesRemaining: 12, expectedMins: 30 });
    }
  }catch(_){}
});
</script>


<script>(function(){
  const sec=document.querySelector('#section_drivers_bottom');
  if(!sec) return;
  const table=sec.querySelector('table'); if(table){ table.style.minWidth='max-content'; }
  const ths=sec.querySelectorAll('thead th');
  ths.forEach(function(th){
    const grip=document.createElement('span'); grip.className='col-grip'; th.appendChild(grip);
    let startX=0, startW=0;
    function onDown(e){ startX=e.clientX; startW=th.offsetWidth;
      document.body.classList.add('dragging-col');
      document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp);
      e.preventDefault();
    }
    function onMove(e){
      const dx=e.clientX-startX; const w=Math.max(40, startW+dx);
      th.style.width=w+'px';
    }
    function onUp(){ document.body.classList.remove('dragging-col');
      document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp);
    }
    grip.addEventListener('mousedown', onDown);
  });
})();</script>


<script>
// Fallback DOM fill for Acc Hrs demo (no dependency on app state)
(function(){
  const demoHrs = { "53939": 11.5, "54545": 11.57, "554421": 6.2, "598771": 7.4 };
  function fill(){
    const sec = document.querySelector('#section_drivers_bottom');
    if(!sec) return false;
    let changed = false;
    sec.querySelectorAll('tbody tr').forEach(tr => {
      const acc = tr.querySelector('td.acc-hrs');
      if(!acc) return;
      const idCell = acc.previousElementSibling;
      if(!idCell) return;
      const id = (idCell.textContent||'').trim();
      const hrs = demoHrs[id];
      if(hrs == null) return;
      acc.textContent = String(Math.round(hrs*100)/100);
      acc.classList.remove('ok','over');
      if(hrs >= 8){ acc.classList.add('over'); } else { acc.classList.add('ok'); }
      changed = true;
    });
    return changed;
  }
  function tryFill(){
    if(fill()) return;
    let tries = 0;
    const t = setInterval(function(){
      if(fill() || ++tries > 60) clearInterval(t);
    }, 200);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', tryFill);
  }else{
    tryFill();
  }
})();
</script>


<script>
// Sorting for Drivers table A-Z / Z-A with funnel icon per header
(function(){
  const SEC_ID = '#section_drivers_bottom';
  let sortState = { col: null, dir: 'asc' };

  function addIcons(){
    const sec = document.querySelector(SEC_ID); if(!sec) return;
    const ths = sec.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      if(th.querySelector('.sort-btn')) return;
      const btn = document.createElement('span');
      btn.className = 'sort-btn';
      btn.title = 'Sort A–Z (click again Z–A)';
      btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
         <path d="M3 4h18M6 9h12M9 14h6M11 19h2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
      th.appendChild(btn);
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        if(sortState.col === idx){
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
        }else{
          sortState.col = idx;
          sortState.dir = 'asc';
        }
        ths.forEach(h => h.classList.remove('active-sort','asc','desc'));
        th.classList.add('active-sort', sortState.dir);
        tryRenderThenSort();
      });
    });
  }

  function getCellText(td){
    if(!td) return '';
    const dv = td.getAttribute('data-value');
    if(dv) return dv;
    let t = td.textContent || '';
    return t.trim().toLowerCase();
  }

  function cmp(a,b){
    const na = parseFloat(a), nb = parseFloat(b);
    const isNumA = !isNaN(na) && /^[-+]?\d+(\.\d+)?$/.test(a);
    const isNumB = !isNaN(nb) && /^[-+]?\d+(\.\d+)?$/.test(b);
    if(isNumA && isNumB){ return na - nb; }
    return a.localeCompare(b, undefined, { sensitivity:'base' });
  }

  function applySortDOM(){
    const sec = document.querySelector(SEC_ID);
    if(!sec) return;
    const tbody = sec.querySelector('tbody'); if(!tbody) return;
    if(sortState.col == null) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((r1, r2) => {
      const t1 = getCellText(r1.children[sortState.col]);
      const t2 = getCellText(r2.children[sortState.col]);
      const c = cmp(t1, t2);
      return sortState.dir === 'asc' ? c : -c;
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  function hookRender(){
    if(window._pp_renderPatched) return;
    if(typeof window.renderDrivers === 'function'){
      const orig = window.renderDrivers;
      window.renderDrivers = function(){
        const res = orig.apply(this, arguments);
        applySortDOM();
        return res;
      };
      window._pp_renderPatched = true;
    }
  }

  function tryRenderThenSort(){
    if(typeof window.renderDrivers === 'function'){
      try{ window.renderDrivers(); }catch(_){}
    }else{
      applySortDOM();
    }
  }

  function init(){
    addIcons();
    hookRender();
    const sec = document.querySelector(SEC_ID);
    if(sec){
      const obs = new MutationObserver(() => { addIcons(); applySortDOM(); });
      obs.observe(sec, { childList:true, subtree:true });
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();
</script>


<script>
(function(){
  const SEC = document.querySelector('#section_drivers_bottom');
  if(!SEC) return;
  if(window.__pp_sortPatched2) return; window.__pp_sortPatched2 = true;
  let sortState = { col: null, dir: 'asc' };

  function addIconsAndBind(){
    const ths = SEC.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      const label = (th.textContent || '').trim();
      if(!label) return;
      if(!th.querySelector('.sort-btn')){
        const btn = document.createElement('span');
        btn.className = 'sort-btn';
        btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">
  <path d="M4 5h16l-7 8v6l-2 1v-7L4 5z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round"/>
</svg>`;
        th.appendChild(btn);
      }
      if(!th._ppBound2){
        th._ppBound2 = true;
        th.addEventListener('click', function(){
          if(sortState.col === idx){
            sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
          }else{
            sortState.col = idx;
            sortState.dir = 'asc';
          }
          ths.forEach(h => h.classList.remove('active-sort','asc','desc'));
          th.classList.add('active-sort', sortState.dir);
          applySort();
        });
      }
    });
  }

  function timeToMinutes(t){
    const m = /^(\d{1,2}):(\d{2})$/.exec(t);
    if(!m) return NaN;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function parseElaps(txt){
    const m = txt.match(/(\d+)\s*m/);
    return m ? parseInt(m[1],10) : NaN;
  }
  function keyFor(thText, cell){
    const raw = (cell?.getAttribute('data-value') || cell?.textContent || '').trim();
    const txt = raw.toLowerCase();
    switch(thText){
      case 'ID': return parseInt(txt,10);
      case 'Acc Hrs': return parseFloat(txt);
      case 'ETA': { const v = timeToMinutes(txt); return isNaN(v) ? Number.POSITIVE_INFINITY : v; }
      case 'Elaps Time': { const v = parseElaps(txt); return isNaN(v) ? Number.POSITIVE_INFINITY : v; }
      default: return txt;
    }
  }
  function applySort(){
    const theadThs = SEC.querySelectorAll('thead th');
    if(sortState.col == null || !theadThs.length) return;
    const label = (theadThs[sortState.col].textContent || '').trim();
    const tbody = SEC.querySelector('tbody'); if(!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((r1, r2) => {
      const t1 = keyFor(label, r1.children[sortState.col]);
      const t2 = keyFor(label, r2.children[sortState.col]);
      const n1 = (typeof t1 === 'number'), n2 = (typeof t2 === 'number');
      const c = (n1 && n2) ? (t1 - t2) : String(t1).localeCompare(String(t2), undefined, { sensitivity:'base' });
      return sortState.dir === 'asc' ? c : -c;
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  if(typeof window.renderDrivers === 'function' && !window.__pp_sortHooked2){
    const orig = window.renderDrivers;
    window.renderDrivers = function(){
      const res = orig.apply(this, arguments);
      try{ addIconsAndBind(); applySort(); }catch(e){}
      return res;
    };
    window.__pp_sortHooked2 = true;
  }

  addIconsAndBind();
  const tb = SEC.querySelector('tbody');
  if(tb){
    const obs = new MutationObserver(() => addIconsAndBind());
    obs.observe(tb, { childList:true });
  }
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
  var gpsBtn = document.getElementById("tab_drivergps");
  if (gpsBtn) {
    gpsBtn.addEventListener("click", function () {
      // Long Beach Port coordinates
      const longBeachPort = "33.7676,-118.1981";
      // Open Google Maps centered on Long Beach Port in a new tab
      window.open(`https://www.google.com/maps/@${longBeachPort},14z`, "_blank");
    });
  }
});
</script>


<script>
(function(){
  const SEARCH_ID = 'pending_search';
  const TBODY_ID  = 'pending_body';
  const SECTION_ID = 'section_pending';

  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function escRx(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

  function clearAll(tbody){
    // show all rows and remove prior highlights
    Array.from(tbody.rows).forEach(tr=>{ tr.style.display=''; });
    tbody.querySelectorAll('span.ccl-hl').forEach(span=> span.replaceWith(document.createTextNode(span.textContent)));
  }

  function highlightMatchesInCell(td, rx){
    if(td.querySelector('input,button,svg')) return false;
    const text = td.textContent || '';
    if(!rx.test(text)) return false;
    rx.lastIndex = 0;
    const frag = document.createDocumentFragment();
    let last = 0;
    text.replace(rx, function(m, offset){
      if(offset>last) frag.appendChild(document.createTextNode(text.slice(last, offset)));
      const mark = document.createElement('span'); mark.className = 'ccl-hl'; mark.textContent = m;
      frag.appendChild(mark); last = offset + m.length; return m;
    });
    if(last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
    td.textContent = ''; td.appendChild(frag);
    return true;
  }

  function doSearch(){
    const input = document.getElementById(SEARCH_ID);
    const tbody = document.getElementById(TBODY_ID);
    const section = document.getElementById(SECTION_ID);
    const scroller = section ? section.querySelector('.relative.overflow-auto') : null;
    if(!input || !tbody) return;

    clearAll(tbody);
    const q = (input.value || '').trim();
    if(!q){ if(scroller) scroller.scrollTo({top:0}); return; }

    const rx = new RegExp(escRx(q), 'gi');
    let firstVisible = null;

    Array.from(tbody.rows).forEach(tr=>{
      let hit = false;
      Array.from(tr.cells).forEach(td=>{ if(highlightMatchesInCell(td, rx)) hit = true; });
      if(!hit){ tr.style.display = 'none'; }
      else if(!firstVisible){ firstVisible = tr; }
    });

    if(firstVisible && scroller){
      scroller.scrollTo({ top:firstVisible.offsetTop - 6, behavior:'smooth' });
    }
  }

  function bind(){
    const input = document.getElementById(SEARCH_ID);
    if(!input) return;
    ['input','keyup','change'].forEach(evt=> input.addEventListener(evt, doSearch));
  }
  ready(bind);
})();
</script>


<!-- CCL: minimal, additive wiring for Create -> Main Dispatch (idempotent, v2) -->
<script>
(function(){
  if (window.__ccl_create_pending_wired__) return;
  window.__ccl_create_pending_wired__ = true;

  function byId(id){ return document.getElementById(id); }

  // Safe helper: use existing function if present, else a fallback.
  function ensureRenderPending(){
    if (typeof window.renderPending === 'function') return;
    // Build a fallback that uses existing helpers if they exist.
    window.renderPending = function(){
      try{
        var section = document.querySelector('#section_pending table');
        var body = byId('pending_body');
        if(!section || !body) return;

        // If buildHeader/buildRowCells exist, use them so it matches other tabs.
        if (typeof window.buildHeader === 'function' && typeof window.buildRowCells === 'function'){
          var thead = section.tHead || section.createTHead();
          window.buildHeader(thead, true, true); // with master checkbox + Driver column
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.dataset.id = a.id;

            // checkbox cell
            var td0 = document.createElement('td');
            var cb = document.createElement('input');
            cb.type = 'checkbox'; cb.className = 'chk';
            td0.appendChild(cb); tr.appendChild(td0);

            // driver cell (pending has no driver yet)
            var tdDriver = document.createElement('td');
            tdDriver.textContent = (a.driverName || '—');
            tr.appendChild(tdDriver);

            window.buildRowCells(tr, a, 'Open');
            body.appendChild(tr);
          });
        } else {
          // Very simple fallback table render
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>'+(a.id||'')+'</td>' +
                           '<td>'+(a.from||'')+'</td>' +
                           '<td>'+(a.to||'')+'</td>' +
                           '<td>'+(a.container||'')+'</td>' +
                           '<td>'+(a.appt||'')+'</td>' +
                           '<td>'+(a.bk||'')+'</td>' +
                           '<td>'+(a.window||'')+'</td>' +
                           '<td>'+(a.status||'')+'</td>';
            body.appendChild(tr);
          });
        }
      }catch(e){ console.error('renderPending fallback error', e); }
    };
  }

  function updateBadgesSafe(){
    try{
      if (typeof window.updateBadges === 'function') window.updateBadges();
      else {
        var bp = byId('badge_pending'); if(bp) bp.textContent = (window.pending && window.pending.length) || 0;
      }
    }catch(e){}
  }

  function closeCreateModal(){
    var m = byId('create_modal');
    if (m) m.style.display = 'none';
  }

  function openCreateModal(){
    var m = byId('create_modal');
    if (m) m.style.display = 'flex';
  }

  function wireDropdown(triggerId, menuId, hiddenId){
    var trigger = byId(triggerId), menu = byId(menuId), hidden = byId(hiddenId);
    if (!trigger || !menu || !hidden) return;
    trigger.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      menu.classList.toggle('hidden');
    });
    menu.querySelectorAll('div[data-val]').forEach(function(item){
      item.addEventListener('click', function(){
        var val = item.getAttribute('data-val');
        hidden.value = val;
        trigger.textContent = val;
        menu.classList.add('hidden');
      });
    });
    document.addEventListener('click', function(e){
      if (!menu.classList.contains('hidden') && !menu.contains(e.target) && e.target!==trigger){
        menu.classList.add('hidden');
      }
    });
  }

  function wireCreateFlow(){
    // Open button
    var btnOpen = byId('btn_create_pending');
    if (btnOpen && !btnOpen.__wired){
      btnOpen.__wired = true;
      btnOpen.addEventListener('click', function(){
        openCreateModal();
      });
    }

    // Cancel button
    var btnCancel = byId('btn_create_cancel');
    if (btnCancel && !btnCancel.__wired){
      btnCancel.__wired = true;
      btnCancel.addEventListener('click', function(){
        // Simple confirm per your spec
        var cm = byId('confirm_modal'), ct = byId('confirm_text'),
            yes = byId('confirm_yes'), no = byId('confirm_no');
        if (cm && ct && yes && no){
          ct.textContent = 'Confirm cancel? Your entries will be lost.';
          cm.style.display = 'flex';
          var onNo = function(){ cm.style.display = 'none'; no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          var onYes = function(){
            cm.style.display = 'none';
            closeCreateModal();
            no.removeEventListener('click', onNo);
            yes.removeEventListener('click', onYes);
          };
          no.addEventListener('click', onNo);
          yes.addEventListener('click', onYes);
        } else {
          closeCreateModal();
        }
      });
    }

    // Update button -> push to pending + render
    var btnUpdate = byId('btn_create_update');
    if (btnUpdate && !btnUpdate.__wired){
      btnUpdate.__wired = true;
      btnUpdate.addEventListener('click', function(){
        try{
          // Build the new pickup object from form fields
          var rec = {
            id: (byId('c_id')||{}).value || '',
            from: (byId('c_from')||{}).value || '',
            to: (byId('c_to')||{}).value || '',
            container: (byId('c_container')||{}).value || '',
            appt: (byId('c_appt')||{}).value || '',
            bk: (byId('c_bkpin')||{}).value || '',
            window: (byId('c_window')||{}).value || '',
            pudate: (byId('c_pudate')||{}).value || '',
            deliveryDate: (byId('c_deliveryDate')||{}).value || '',
            lfd: (byId('c_lfd')||{}).value || '',
            returnDate: (byId('c_returnDate')||{}).value || '',
            returnPort: (byId('c_returnPort')||{}).value || '',
            customer: (byId('c_customer')||{}).value || '',
            chassis: (byId('c_chassis')||{}).value || '',
            size: (byId('c_size')||{}).value || '',
            pin: (byId('c_pin')||{}).value || '',
            ie: (byId('c_impexp')||{}).value || '',
            remark: (byId('c_instruction')||{}).value || '',
            status: 'Open'
          };
          // Load/Empty chosen via custom dropdown
          var le = (byId('c_loadempty')||{}).value || '';
          if (le) rec.loadempty = le;

          if (!window.pending) window.pending = [];
          window.pending.unshift(rec);

          ensureRenderPending();
          window.renderPending();
      if (typeof window.switchTab==='function'){ try{ window.switchTab('pending'); }catch(_){}} 
      updateBadgesSafe();
          // Close modal
          closeCreateModal();

          // Optional: soft toast if available
          try{ if (typeof window.toast === 'function') window.toast('New pickup added to Main Dispatch.'); }catch(_){}

        }catch(e){
          console.error('Create->Pending failed:', e);
        }
      });
    }

    // Wire the two dropdowns inside Create modal (if present)
    wireDropdown('c_dd_loadempty','c_menu_loadempty','c_loadempty');
    wireDropdown('c_dd_impexp','c_menu_impexp','c_impexp');
  }

  // Initialize after DOM ready
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    ensureRenderPending();
    wireCreateFlow();
    // First draw (in case tab starts active and table is empty)
    try{ window.renderPending(); }catch(_){}
  });
})();
</script>


<!-- CCL: robust Main Dispatch activation + Create wiring (idempotent, v2) -->
<script>
(function(){
  if (window.__ccl_force_main_dispatch__) return;
  window.__ccl_force_main_dispatch__ = true;

  function byId(id){ return document.getElementById(id); }

  // Fallback switchTab implementation if missing
  function ensureSwitchTab(){
    if (typeof window.switchTab === 'function') return;
    window.switchTab = function(name){
      var sections = ['pickups','assigned','inprogress','completed','pending'];
      sections.forEach(function(s){
        var sec = byId('section_'+s);
        var tab = byId('tab_'+s);
        if (!sec || !tab) return;
        if (s === name){
          sec.classList.remove('hidden');
          tab.classList.add('active');
        } else {
          sec.classList.add('hidden');
          tab.classList.remove('active');
        }
      });
    };
  }

  // Ensure Main Dispatch is visible by default on load
  function activateMainDispatch(){
    try{
      ensureSwitchTab();
      window.switchTab('pending');
    }catch(e){ console.error('activateMainDispatch error', e); }
  }

  // Ensure renderPending exists (reuse existing helpers if available)
  function ensureRenderPending(){
    if (typeof window.renderPending === 'function') return;
    window.renderPending = function(){
      try{
        var table = (byId('section_pending')||{}).querySelector && byId('section_pending').querySelector('table');
        var body = byId('pending_body');
        if(!table || !body) return;
        // Use helpers if present
        if (typeof window.buildHeader === 'function' && typeof window.buildRowCells === 'function'){
          var thead = table.tHead || table.createTHead();
          window.buildHeader(thead, true, true);
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.dataset.id = a.id;
            // checkbox
            var td0=document.createElement('td');
            var cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk';
            td0.appendChild(cb); tr.appendChild(td0);
            // driver placeholder
            var tdDriver=document.createElement('td'); tdDriver.textContent = a.driverName || '—'; tr.appendChild(tdDriver);
            window.buildRowCells(tr, a, 'Open');
            body.appendChild(tr);
          });
        }else{
          // Simple fallback
          body.innerHTML = '';
          (window.pending || []).forEach(function(a){
            var tr = document.createElement('tr');
            tr.innerHTML = '<td></td><td>'+(a.driverName||'—')+'</td>' +
                           '<td>'+(a.id||'')+'</td>' +
                           '<td>'+(a.from||'')+'</td>' +
                           '<td>'+(a.to||'')+'</td>' +
                           '<td>'+(a.container||'')+'</td>' +
                           '<td>'+(a.appt||'')+'</td>' +
                           '<td>'+(a.bk||'')+'</td>' +
                           '<td>'+(a.window||'')+'</td>' +
                           '<td>'+(a.status||'')+'</td>';
            body.appendChild(tr);
          });
        }
      }catch(e){ console.error('renderPending error', e); }
    };
  }

  function updateBadgesSafe(){
    try{
      if (typeof window.updateBadges === 'function') window.updateBadges();
      else {
        var bp = byId('badge_pending'); if(bp) bp.textContent = (window.pending && window.pending.length) || 0;
      }
    }catch(e){}
  }

  function openCreateModal(){ var m = byId('create_modal'); if(m){ m.style.display='flex'; } }
  function closeCreateModal(){ var m = byId('create_modal'); if(m){ m.style.display='none'; } }

  function genId(){
    // Generate a unique Job # if user left it blank
    var t = Date.now();
    return 'CCL-' + (t % 1000000).toString().padStart(6,'0');
  }

  function wireCreateFlow(){
    // Open
    var btnOpen = byId('btn_create_pending');
    if (btnOpen && !btnOpen.__wired){
      btnOpen.__wired = true;
      btnOpen.addEventListener('click', openCreateModal);
    }
    // Cancel
    var btnCancel = byId('btn_create_cancel');
    if (btnCancel && !btnCancel.__wired){
      btnCancel.__wired = true;
      btnCancel.addEventListener('click', function(){
        var cm = byId('confirm_modal'), ct = byId('confirm_text'),
            yes = byId('confirm_yes'), no = byId('confirm_no');
        if (cm && ct && yes && no){
          ct.textContent = 'Confirm cancel? Your entries will be lost.';
          cm.style.display = 'flex';
          var onNo = function(){ cm.style.display = 'none'; no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          var onYes = function(){ cm.style.display = 'none'; closeCreateModal(); no.removeEventListener('click', onNo); yes.removeEventListener('click', onYes); };
          no.addEventListener('click', onNo);
          yes.addEventListener('click', onYes);
        } else {
          closeCreateModal();
        }
      });
    }
    // Update
    var btnUpdate = byId('btn_create_update');
    if (btnUpdate && !btnUpdate.__wired){
      btnUpdate.__wired = true;
      btnUpdate.addEventListener('click', function(){
        try{
          var id = (byId('c_id')||{}).value || genId();
          var rec = {
            id: id.trim(),
            from: (byId('c_from')||{}).value || '',
            to: (byId('c_to')||{}).value || '',
            container: (byId('c_container')||{}).value || '',
            appt: (byId('c_appt')||{}).value || '',
            bk: (byId('c_bkpin')||{}).value || '',
            window: (byId('c_window')||{}).value || '',
            pudate: (byId('c_pudate')||{}).value || '',
            deliveryDate: (byId('c_deliveryDate')||{}).value || '',
            lfd: (byId('c_lfd')||{}).value || '',
            returnDate: (byId('c_returnDate')||{}).value || '',
            returnPort: (byId('c_returnPort')||{}).value || '',
            customer: (byId('c_customer')||{}).value || '',
            chassis: (byId('c_chassis')||{}).value || '',
            size: (byId('c_size')||{}).value || '',
            pin: (byId('c_pin')||{}).value || '',
            ie: (byId('c_impexp')||{}).value || '',
            remark: (byId('c_instruction')||{}).value || '',
            status: 'Open'
          };
          var le = (byId('c_loadempty')||{}).value || '';
          if (le) rec.loadempty = le;

          if (!window.pending) window.pending = [];
          window.pending.unshift(rec);

          ensureRenderPending();
          window.renderPending();
          updateBadgesSafe();

          ensureSwitchTab();
          window.switchTab('pending'); // force-show Main Dispatch
          closeCreateModal();

          try{ if (typeof window.toast === 'function') window.toast('New pickup added to Main Dispatch.'); }catch(_){}
        }catch(e){ console.error('Create->Pending failed:', e); }
      });
    }
  }

  // Init
  function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    ensureRenderPending();
    wireCreateFlow();
    activateMainDispatch(); // make Main Dispatch visible on load
    try{ window.renderPending(); }catch(_){}
  });
})();
</script>


<script>
// After render, remove any column whose header text is exactly "Job #"
(function(){
  function removeJobHashCols(context){
    var tables = (context || document).querySelectorAll('table');
    tables.forEach(function(table){
      try{
        var thead = table.tHead; if(!thead || !thead.rows || !thead.rows[0]) return;
        var hdr = thead.rows[0];
        var idx = -1;
        for(var i=0;i<hdr.cells.length;i++){
          var t = (hdr.cells[i].textContent||'').trim();
          if(t === 'Job #'){ idx = i; break; }
        }
        if(idx <= 0) return; // not found or it's the checkbox column (we keep that)
        // Remove header cell
        hdr.deleteCell(idx);
        // Remove cells at same index in body rows
        Array.from(table.tBodies||[]).forEach(function(tb){
          Array.from(tb.rows||[]).forEach(function(row){
            if(row.cells && row.cells.length > idx){
              row.deleteCell(idx);
            }
          });
        });
      }catch(e){ console.warn('remove Job # col err', e); }
    });
  }
  // Run on DOMContentLoaded and after small timeout to catch dynamic headers
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){ removeJobHashCols(); }, 100);
  }, {once:true});
  // Also observe DOM changes (in case tables render later)
  try{
    var mo = new MutationObserver(function(muts){ removeJobHashCols(); });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(_){}
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  function rebuildAll(){
    const sections = ['pending','pickups','assigned','inprogress','completed'];
    sections.forEach(function(sec){
      try{
        var thead = document.querySelector('#section_'+sec+' thead');
        if(thead){
          buildHeader(thead, true, false); // include checkbox, no driver
        }
      }catch(e){ console.warn('rebuildAll error', sec, e); }
    });
  }
  setTimeout(rebuildAll, 200);
});
</script>



<!-- === CCL JOB # MANAGER v2 (preserve '66', enforce (CCL-####) for CCL IDs) === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const LS_COUNTER = 'ccl_job_counter_v2';
    const LS_ISSUED  = 'ccl_job_issued_v2'; // only for CCL-#### ids

    // Helpers
    const makeCCL = n => 'CCL-' + String(n);
    const parseCCLNum = id => {
      const s = String(id||'').trim();
      const m = /^CCL-(\d+)(?:[- ].*)?$/i.exec(s);
      return m ? parseInt(m[1],10) : null;
    };
    const isPureNumber = id => /^\d+$/.test(String(id||'').trim());

    const loadSet = () => {
      try{ const s = localStorage.getItem(LS_ISSUED); if(s) return new Set(JSON.parse(s)); }catch(_){}
      return new Set();
    };
    const saveSet = S => { try{ localStorage.setItem(LS_ISSUED, JSON.stringify([...S])); }catch(_){} };
    const getCounter = () => {
      const v = parseInt(localStorage.getItem(LS_COUNTER)||'',10);
      return Number.isFinite(v) ? v : 5000;
    };
    const setCounter = v => { try{ localStorage.setItem(LS_COUNTER, String(v)); }catch(_){} };

    // Seed from current data
    (function normalizeAndIndex(){
      if(!Array.isArray(window.pending)) window.pending = [];
      const issued = loadSet();
      let maxSeen = getCounter();

      for(const rec of window.pending){
        if(!rec) continue;
        const n = parseCCLNum(rec.id);
        if(n){
          rec.id = makeCCL(n);
          issued.add(rec.id);
          if(n > maxSeen) maxSeen = n;
        } else if(isPureNumber(rec.id)){
          // keep literal numbers like "66"
        } else {
          // Unknown => convert to next CCL
          let next = Math.max(5000, maxSeen) + 1;
          while(issued.has(makeCCL(next))) next++;
          rec.id = makeCCL(next);
          issued.add(rec.id);
          maxSeen = next;
        }
      }
      saveSet(issued);
      setCounter(maxSeen < 5000 ? 5000 : maxSeen);
    })();

    // Next CCL id (displayed with parentheses)
    function nextCCLId(){
      const issued = loadSet();
      let counter = getCounter();
      let next = Math.max(5000, counter) + 1;
      while(issued.has(makeCCL(next))) next++;
      const core = makeCCL(next);
      issued.add(core);
      saveSet(issued);
      setCounter(next);
      return '(' + core + ')';
    }

    // Order & display
    (function forceRenderOrder(){
      const orig = window.renderPending;
      window.renderPending = function(){
        const r = (typeof orig === 'function') ? orig.apply(this, arguments) : undefined;
        try{
          if(Array.isArray(window.pending)){
            const ccl=[], other=[];
            window.pending.forEach(rec=>{
              const n = parseCCLNum(rec.id);
              if(n){
                rec.id = makeCCL(n);
                rec.__display = '(' + rec.id + ')';
                ccl.push({rec,n});
              } else {
                rec.__display = String(rec.id==null?'':rec.id);
                other.push(rec);
              }
            });
            ccl.sort((a,b)=>b.n-a.n);
            window.pending = ccl.map(x=>x.rec).concat(other);
          }
          const body = document.getElementById('pending_body') || document.querySelector('#section_pending tbody');
          if(body && body.children.length){
            const rows = Array.from(body.children);
            const byId = new Map(rows.map(tr => [tr.getAttribute('data-id')||'', tr]));
            window.pending.forEach(rec=>{
              const id = rec && rec.id ? rec.id : '';
              const tr = byId.get(id);
              if(tr) body.appendChild(tr);
              try{
                const jobCell = tr ? (tr.querySelector('[data-col="job"]') || tr.children[2]) : null;
                if(jobCell && typeof rec.__display === 'string'){
                  jobCell.textContent = rec.__display;
                  tr && tr.setAttribute('data-id', rec.id);
                }
              }catch(_){}
            });
          }
        }catch(_){}
        return r;
      };
      try{ if(typeof window.renderPending === 'function') window.renderPending(); }catch(_){}
    })();

    // Prefill Create modal
    (function prefillCreateJob(){
      function setId(){
        const inp = document.getElementById('c_id');
        if(!inp) return;
        const id = nextCCLId();
        inp.value = id;          // show "(CCL-####)"
        inp.readOnly = true;
        inp.style.opacity = '0.9';
        inp.style.background = '#0f172a';
      }
      const btn = document.getElementById('btn_create_pending');
      if(btn && !btn.__ccl_job_prefill_v2__){
        btn.__ccl_job_prefill_v2__ = true;
        btn.addEventListener('click', function(){ setTimeout(setId, 0); }, true);
      }
      setTimeout(function(){
        const modal = document.getElementById('create_modal');
        if(modal && modal.style.display !== 'none'){
          setId();
        }
      }, 200);
    })();
  });
})();
</script>



<!-- === CCL DATE SEEDER + ASC SORT v2 (robust) === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const LS_DATE_MAP = 'ccl_date_map_v2';
    const rngDays = 60; // pick within last N days

    const loadMap = () => {
      try{ const s = localStorage.getItem(LS_DATE_MAP); if(s) return JSON.parse(s)||{}; }catch(_){}
      return {};
    };
    const saveMap = m => { try{ localStorage.setItem(LS_DATE_MAP, JSON.stringify(m)); }catch(_){} };

    const toMDY = (d) => {
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yy = d.getFullYear();
      return mm + '/' + dd + '/' + yy;
    };
    const parseCellDate = (txt) => {
      const s = String(txt||'').trim();
      if(!s || s==='—' || s==='-') return null;
      // try MM/DD/YYYY
      const m = /^([01]?\d)[\/\-]([0-3]?\d)[\/\-](\d{2,4})$/.exec(s);
      if(m){
        const M = Math.max(0, Math.min(11, parseInt(m[1],10)-1));
        const D = Math.max(1, Math.min(31, parseInt(m[2],10)));
        const Y = parseInt(m[3],10); const Y4 = (String(Y).length===2)? 2000+Y : Y;
        const dt = new Date(Y4, M, D);
        if(!isNaN(+dt)) { dt.setHours(0,0,0,0); return dt; }
      }
      const dt2 = new Date(s);
      if(!isNaN(+dt2)){ dt2.setHours(0,0,0,0); return dt2; }
      return null;
    };
    const randPastDate = () => {
      const now = new Date();
      const dt = new Date(now);
      dt.setDate(now.getDate() - Math.floor(Math.random() * rngDays));
      dt.setHours(0,0,0,0);
      return dt;
    };

    function findArrivalIndex(){
      // Look for header text "DATE OF ARRIVAL" in Main Dispatch table
      const hdrRow = document.querySelector('#section_pending thead tr');
      if(hdrRow){
        const ths = Array.from(hdrRow.children);
        for(let i=0;i<ths.length;i++){
          const t = (ths[i].textContent||'').replace(/\s+/g,' ').trim().toLowerCase();
          if(t.includes('date of arrival')) return i;
        }
      }
      // fallback: assume second column (after checkbox)
      return 1;
    }

    function seedAndSort(){
      const tbody = document.querySelector('#section_pending tbody');
      if(!tbody) return;
      const dateIdx = findArrivalIndex();
      const dateMap = loadMap();
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.forEach((tr, i)=>{
        const id = tr.getAttribute('data-id') || ('row#'+i);
        const cell = tr.children[dateIdx];
        let dt = null;

        if(cell) dt = parseCellDate(cell.textContent);
        if((!dt || isNaN(+dt)) && dateMap[id]) dt = new Date(dateMap[id]);
        if(!dt || isNaN(+dt)) dt = randPastDate();

        // persist + set visuals
        dateMap[id] = dt.toISOString();
        if(cell) cell.textContent = toMDY(dt);
        tr.dataset.arrivalTs = String(+dt);
      });

      saveMap(dateMap);

      // sort earliest on top
      rows.sort((a,b)=> (parseInt(a.dataset.arrivalTs || '0') - parseInt(b.dataset.arrivalTs || '0')) );
      rows.forEach(tr=> tbody.appendChild(tr));
    }

    // run now
    seedAndSort();

    // also hook any render function that may rebuild the table
    const prev = window.renderPending;
    window.renderPending = function(){
      const r = (typeof prev==='function') ? prev.apply(this, arguments) : undefined;
      try{ seedAndSort(); }catch(_){}
      return r;
    };
  });
})();
</script>

<!-- === CCL: Delivery Date Stable Auto-Sort (earliest on top) === -->
<script>
(function(){
  if (window.__CCL_DELIVERY_SORT__) return; window.__CCL_DELIVERY_SORT__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const TABLE = document.querySelector('#section_pending');
    if(!TABLE) return;
    const TBODY = TABLE.querySelector('tbody');
    const HEADER = TABLE.querySelector('thead tr');
    function parseTs(txt){
      const s = String(txt||'').trim();
      if(!s || s==='—' || s==='-') return Number.POSITIVE_INFINITY;
      const m = /^([01]?\d)[\/\-]([0-3]?\d)[\/\-](\d{2,4})$/.exec(s);
      if(m){
        const M=Math.max(0,Math.min(11,parseInt(m[1],10)-1));
        const D=Math.max(1,Math.min(31,parseInt(m[2],10)));
        const Y=m[3].length===2?2000+parseInt(m[3],10):parseInt(m[3],10);
        const dt=new Date(Y,M,D); if(!isNaN(+dt)){dt.setHours(0,0,0,0); return +dt;}
      }
      const dt2=new Date(s); if(!isNaN(+dt2)){dt2.setHours(0,0,0,0); return +dt2;}
      return Number.POSITIVE_INFINITY;
    }
    function findCol(){
      if(!HEADER) return -1;
      const ths=Array.from(HEADER.children);
      for(let i=0;i<ths.length;i++){
        const t=(ths[i].textContent||'').replace(/\s+/g,' ').trim().toLowerCase();
        if(t.includes('del date')||t.includes('delivery date')||t.includes('date of delivery')) return i;
      }
      return -1;
    }
    let col = -1; function ensureCol(){ if(col<0) col = findCol(); return col; }
    let isSorting=false, again=false;
    function sortIfNeeded(){
      if(isSorting){ again=true; return; }
      isSorting=true; requestAnimationFrame(()=>{
        try{
          if(!TBODY || ensureCol()<0) return;
          const rows=Array.from(TBODY.querySelectorAll('tr'));
          if(rows.length<=1) return;
          const cur=rows.map(tr=>tr.getAttribute('data-id')||tr.innerText.slice(0,50));
          const keyed=rows.map((tr,i)=>({tr, key: parseTs((tr.children[col]||{}).textContent), i}));
          keyed.sort((a,b)=>(a.key-b.key)||(a.i-b.i));
          const desired=keyed.map(x=>x.tr.getAttribute('data-id')||x.tr.innerText.slice(0,50));
          let changed=false;
          if(cur.length===desired.length){
            for(let i=0;i<cur.length;i++){ if(cur[i]!==desired[i]){changed=true; break;} }
          } else changed=true;
          if(changed){ const frag=document.createDocumentFragment(); keyed.forEach(x=>frag.appendChild(x.tr)); TBODY.appendChild(frag); }
        }finally{ isSorting=false; if(again){ again=false; sortIfNeeded(); } }
      });
    }
    try{
      const orig = window.renderPending;
      window.renderPending = function(){ const r=(typeof orig==='function')?orig.apply(this, arguments):undefined; try{sortIfNeeded();}catch(_){ } return r; };
    }catch(_){}
    const mo = new MutationObserver(()=>sortIfNeeded());
    if(TBODY) mo.observe(TBODY,{childList:true, subtree:true, characterData:true});
    window.cclSortPendingByDeliveryDate = sortIfNeeded;
    sortIfNeeded();
  });
})();
</script>

<!-- === CCL: Row Single-Select + Double-Click to Edit === -->
<script>
(function(){
  if (window.__CCL_ROW_SELECT__) return; window.__CCL_ROW_SELECT__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const TBL = document.querySelector('#section_pending'); if(!TBL) return;
    const TBODY = TBL.querySelector('tbody'); if(!TBODY) return;
    function syncButtons(){ try{ if(typeof window.syncActionButtons==='function') window.syncActionButtons(); }catch(_){ } }
    function clearSel(){
      try{ if(window.state && state.selectedPending){ state.selectedPending.clear(); } }catch(_){}
      TBODY.querySelectorAll('tr').forEach(tr=>{
        tr.classList.remove('selected');
        const cb = tr.querySelector('input[type="checkbox"]'); if(cb){ cb.checked=false; cb.classList.remove('active'); }
      });
    }
    function selectRow(tr){
      if(!tr) return;
      const id = tr.getAttribute('data-id')||''; if(!id) return;
      clearSel();
      try{ state.selectedPending = state.selectedPending || new Set(); state.selectedPending.add(id); state.currentTab='pending'; }catch(_){}
      tr.classList.add('selected'); const cb = tr.querySelector('input[type="checkbox"]'); if(cb){ cb.checked=true; cb.classList.add('active'); }
      syncButtons();
    }
    TBODY.addEventListener('click', function(e){
      const tag=(e.target.tagName||'').toLowerCase();
      if(tag==='input'||tag==='button'||tag==='a'||e.target.closest('button,a')) return;
      const tr = e.target.closest('tr'); if(tr) selectRow(tr);
    }, true);
    TBODY.addEventListener('dblclick', function(e){
      const tr = e.target.closest('tr'); if(!tr) return; selectRow(tr);
      try{ if(typeof window.openEdit==='function') window.openEdit(); }catch(_){}
    }, true);
    try{
      const orig = window.renderPending;
      window.renderPending = function(){ const r=(typeof orig==='function')?orig.apply(this, arguments):undefined; try{
        if(state && state.selectedPending && state.selectedPending.size){ const id=[...state.selectedPending][0]; const row=TBODY.querySelector('tr[data-id="'+id+'"]'); if(row){ row.classList.add('selected'); } }
      }catch(_){ } return r; };
    }catch(_){}
  });
})();
</script>

<!-- === CCL: Edit Autofill DOM Fallback === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    if(typeof window.openEdit !== 'function') return;
    if(window.__CCL_EDIT_PATCH__) return; window.__CCL_EDIT_PATCH__ = true;
    const orig = window.openEdit;
    window.openEdit = function(){
      const r = orig.apply(this, arguments);
      try{
        const selId = (function(){ try{ return [...(state.selectedPending||[])][0]||''; }catch(_){ return ''; } })();
        const rowEl = document.querySelector('#section_pending tbody tr[data-id="'+selId+'"]');
        if(rowEl){
          const map = {}; Array.from(rowEl.children).forEach(td => { if(td.dataset && td.dataset.colKey){ map[td.dataset.colKey]=(td.textContent||'').trim(); } });
          function apply(id, key){ const el=document.getElementById(id); if(!el) return; if(!el.value || !el.value.trim()){ const v=(map[key]||''); el.value = (v==='—')? '' : v; } }
          apply('e_from','from'); apply('e_to','to'); apply('e_container','container');
          apply('e_loadempty','appt'); var ddLE=document.getElementById('dd_loadempty'); if(ddLE){ ddLE.textContent=document.getElementById('e_loadempty').value||ddLE.textContent||'Select…'; }
          apply('e_bkpin','bk'); apply('e_impexp','ie'); var ddIE=document.getElementById('dd_impexp'); if(ddIE){ ddIE.textContent=document.getElementById('e_impexp').value||ddIE.textContent||'Select…'; }
          apply('e_seal','seal'); apply('e_window','window'); apply('e_instruction','remark');
        }
      }catch(_){}
      return r;
    };
  });
})();
</script>

<!-- === CCL: Force-Center Cells + Auto-Center On Edit (Main Dispatch) === -->
<style id="ccl-center-on-edit">
  /* Center everything inside Main Dispatch rows, including nested spans/divs */
  #section_pending tbody td,
  #section_pending tbody th { 
    text-align: center !important; 
    vertical-align: middle !important; 
  }
  #section_pending tbody td * { 
    text-align: center !important; 
  }
</style>
<script>
(function(){
  if (window.__CCL_CENTER_EDIT__) return; window.__CCL_CENTER_EDIT__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const TBODY = document.querySelector('#section_pending tbody');
    if(!TBODY) return;

    // Ensure any edited/changed cell keeps centered alignment.
    function centerCellFrom(node){
      try{
        const el = (node && node.nodeType===3) ? node.parentElement : node;
        const td = el && el.closest ? el.closest('td') : null;
        if(td){
          td.style.textAlign = 'center';
          td.style.verticalAlign = 'middle';
          td.classList.add('ccl-centered');
          // Also center direct children that might carry left-align classes
          Array.from(td.children || []).forEach(ch => { 
            if (ch && ch.style) ch.style.textAlign = 'center'; 
          });
        }
      }catch(_){}
    }

    // Input/Change listeners for inline edits
    TBODY.addEventListener('input', e => centerCellFrom(e.target), true);
    TBODY.addEventListener('change', e => centerCellFrom(e.target), true);

    // Mutation observer catches programmatic updates after Edit modal save
    const mo = new MutationObserver(list => {
      list.forEach(m => {
        if(m.type === 'characterData') centerCellFrom(m.target);
        if(m.type === 'childList'){
          m.addedNodes && m.addedNodes.forEach(n => centerCellFrom(n));
          // If a whole row replaced, re-center all its cells
          const tr = (m.target && m.target.closest) ? m.target.closest('tr') : null;
          if(tr && TBODY.contains(tr)){
            Array.from(tr.cells || []).forEach(td => centerCellFrom(td));
          }
        }
      });
    });
    mo.observe(TBODY, {subtree:true, characterData:true, childList:true});

    // Also run after table re-renders
    try{
      const orig = window.renderPending;
      window.renderPending = function(){
        const r = (typeof orig==='function') ? orig.apply(this, arguments) : undefined;
        try{
          TBODY.querySelectorAll('td').forEach(td => {
            td.style.textAlign='center';
            td.style.verticalAlign='middle';
            Array.from(td.children || []).forEach(ch => { if(ch && ch.style) ch.style.textAlign='center'; });
          });
        }catch(_){}
        return r;
      };
    }catch(_){}
  });
})();
</script>

<!-- === CCL: Inline Cell Editing + Persist === -->
<script>
(function(){
  if (window.__CCL_INLINE_EDIT__) return; window.__CCL_INLINE_EDIT__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const TBL = document.querySelector('#section_pending'); if(!TBL) return;
    const TBODY = TBL.querySelector('tbody'); if(!TBODY) return;

    function makeEditable(){
      TBODY.querySelectorAll('tr').forEach(function(tr){
        Array.from(tr.cells).forEach(function(td, idx){
          if(idx===0) return; // skip checkbox
          td.setAttribute('contenteditable', 'true');
          td.dataset.cclEditable = '1';
          td.style.caretColor = 'auto';
          td.style.outline = 'none';
        });
      });
    }
    makeEditable();

    function saveCell(td){
      try{
        const tr = td.closest('tr');
        const id = tr && tr.getAttribute('data-id');
        const key = td && td.dataset && td.dataset.colKey;
        if(!id || !key) return;
        const rec = (window.pending||[]).find(r => r && String(r.id)===String(id));
        const val = (td.textContent||'').trim();
        if(rec){ rec[key] = val; }
        try{ if(typeof saveLocal==='function') saveLocal(); }catch(_){}
        try{ if(key==='deliveryDate' && typeof window.cclSortPendingByDeliveryDate==='function'){ window.cclSortPendingByDeliveryDate(); } }catch(_){}
      }catch(_){}
    }

    TBODY.addEventListener('blur', function(e){
      const td = e.target && e.target.closest ? e.target.closest('td[contenteditable="true"]') : null;
      if(td) saveCell(td);
    }, true);

    TBODY.addEventListener('keydown', function(e){
      if(e.key==='Enter'){
        const td = e.target && e.target.closest ? e.target.closest('td[contenteditable="true"]') : null;
        if(td){ e.preventDefault(); td.blur(); }
      }
    }, true);

    try{
      const orig = window.renderPending;
      window.renderPending = function(){
        const r=(typeof orig==='function')?orig.apply(this, arguments):undefined;
        try{ makeEditable(); }catch(_){}
        return r;
      };
    }catch(_){}
  });
})();
</script>

<!-- === CCL: Edit Prefill — DOM-Driven (Hard Bind) v3 === -->
<script>
(function(){
  if (window.__CCL_EDIT_PREFILL_DOM_V3__) return; window.__CCL_EDIT_PREFILL_DOM_V3__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    function getSelectedRow(){
      const tb = document.querySelector('#section_pending tbody');
      if(!tb) return null;
      const chk = tb.querySelector('input[type="checkbox"]:checked');
      if(chk) return chk.closest('tr');
      const sel = tb.querySelector('tr.selected');
      if(sel) return sel;
      try{
        if(window.state && state.selectedPending && state.selectedPending.size===1){
          const id = [...state.selectedPending][0];
          const byId = tb.querySelector('tr[data-id="'+id+'"]');
          if(byId) return byId;
        }
      }catch(_){}
      return null;
    }

    function cellMap(tr){
      const map = {};
      if(!tr) return map;
      Array.from(tr.children).forEach(td => {
        const k = td && td.dataset ? (td.dataset.colKey || td.dataset.col || td.getAttribute('data-col') || td.getAttribute('data-colkey')) : null;
        if(!k) return;
        map[k] = (td.textContent||'').trim();
      });
      return map;
    }

    function setIfEmpty(id, val){
      const el = document.getElementById(id);
      if(!el) return;
      if(!el.value || !el.value.trim()) el.value = (val==='—') ? '' : (val||'');
    }

    function prefillFromDOM(){
      const tr = getSelectedRow();
      if(!tr) return false;
      const map = cellMap(tr);
      setIfEmpty('e_from',       map.from);
      setIfEmpty('e_to',         map.to);
      setIfEmpty('e_container',  map.container);
      setIfEmpty('e_loadempty',  map.appt);
      setIfEmpty('e_bkpin',      map.bk);
      setIfEmpty('e_impexp',     map.ie);
      setIfEmpty('e_seal',       map.seal);
      setIfEmpty('e_window',     map.window);
      setIfEmpty('e_instruction',map.remark);
      const ddLE = document.getElementById('dd_loadempty');
      if(ddLE){ ddLE.textContent = document.getElementById('e_loadempty')?.value || ddLE.textContent || 'Select…'; }
      const ddIE = document.getElementById('dd_impexp');
      if(ddIE){ ddIE.textContent = document.getElementById('e_impexp')?.value || ddIE.textContent || 'Select…'; }
      return true;
    }

    if(typeof window.openEdit === 'function'){
      const _orig = window.openEdit;
      window.openEdit = function(){
        const r = _orig.apply(this, arguments);
        setTimeout(prefillFromDOM, 0);
        return r;
      };
    }

    const btn = document.getElementById('btn_edit_pending');
    if(btn){
      btn.addEventListener('click', function(){
        setTimeout(prefillFromDOM, 40);
      }, true);
    }
  });
})();
</script>

<!-- === CCL: Strong Edit Prefill + Anti‑Wipe Guard v5 === -->
<script>
(function(){
  if (window.__CCL_EDIT_PREFILL_V5__) return; window.__CCL_EDIT_PREFILL_V5__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const IDS = ['e_from','e_to','e_container','e_loadempty','e_bkpin','e_impexp','e_seal','e_window','e_instruction'];

    function getSelectedRow(){
      const tb = document.querySelector('#section_pending tbody'); if(!tb) return null;
      const chk = tb.querySelector('input[type="checkbox"]:checked'); if(chk) return chk.closest('tr');
      const sel = tb.querySelector('tr.selected'); if(sel) return sel;
      try{
        if(window.state && state.selectedPending && state.selectedPending.size===1){
          const id = Array.from(state.selectedPending)[0];
          const byId = tb.querySelector('tr[data-id="'+id+'"]'); if(byId) return byId;
        }
      }catch(_){}
      return null;
    }

    function readMap(tr){
      const map = {}; if(!tr) return map;
      Array.from(tr.children).forEach(td => {
        const k = td && td.dataset ? (td.dataset.colKey || td.dataset.col || td.getAttribute('data-col') || td.getAttribute('data-colkey')) : null;
        if(!k) return; map[k] = (td.textContent||'').trim();
      });
      return map;
    }

    function strongPrefill(){
      const tr = getSelectedRow(); if(!tr) return;
      const map = readMap(tr);
      const snap = {};
      function setVal(id, val){
        const el = document.getElementById(id);
        if(!el) return;
        const v = (val==='—') ? '' : (val||'');
        el.value = v;
        snap[id] = v;
      }
      setVal('e_from', map.from);
      setVal('e_to', map.to);
      setVal('e_container', map.container);
      setVal('e_loadempty', map.appt);
      setVal('e_bkpin', map.bk);
      setVal('e_impexp', map.ie);
      setVal('e_seal', map.seal);
      setVal('e_window', map.window);
      setVal('e_instruction', map.remark);
      const ddLE = document.getElementById('dd_loadempty'); if(ddLE){ ddLE.textContent = document.getElementById('e_loadempty')?.value || ddLE.textContent || 'Select…'; }
      const ddIE = document.getElementById('dd_impexp'); if(ddIE){ ddIE.textContent = document.getElementById('e_impexp')?.value || ddIE.textContent || 'Select…'; }

      // Anti-wipe: temporarily block clears and restore blanks for a short period
      window.__CCL_EDIT_PREFILL_LOCK = true;
      try{
        const origClear = window.clearEditFields;
        if(typeof origClear==='function' && !window.__CCL_CLEAR_WRAP__){
          window.__CCL_CLEAR_WRAP__ = true;
          window.clearEditFields = function(){
            if(window.__CCL_EDIT_PREFILL_LOCK) return; // swallow clears during lock window
            return origClear.apply(this, arguments);
          };
        }
      }catch(_){}

      const start = Date.now();
      const iv = setInterval(function(){
        IDS.forEach(function(id){
          const el = document.getElementById(id);
          if(el && el.value==='' && (snap[id]||'')!==''){ el.value = snap[id]; }
        });
        const ddLE2 = document.getElementById('dd_loadempty'); if(ddLE2){ ddLE2.textContent = document.getElementById('e_loadempty')?.value || ddLE2.textContent || 'Select…'; }
        const ddIE2 = document.getElementById('dd_impexp'); if(ddIE2){ ddIE2.textContent = document.getElementById('e_impexp')?.value || ddIE2.textContent || 'Select…'; }
        if(Date.now()-start > 800){ window.__CCL_EDIT_PREFILL_LOCK = false; clearInterval(iv); }
      }, 40);
    }

    if(typeof window.openEdit === 'function'){
      const orig = window.openEdit;
      window.openEdit = function(){
        const r = orig.apply(this, arguments);
        setTimeout(strongPrefill, 0);
        return r;
      };
    }
    const btn = document.getElementById('btn_edit_pending');
    if(btn){ btn.addEventListener('click', function(){ setTimeout(strongPrefill, 40); }, true); }
  });
})();
</script>

<!-- === CCL: Edit Modal Watchdog (Stop Post-Open Wipes) v6 === -->
<script>
(function(){
  if (window.__CCL_EDIT_WATCHDOG_V6__) return; window.__CCL_EDIT_WATCHDOG_V6__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const IDS = ['e_from','e_to','e_container','e_loadempty','e_bkpin','e_impexp','e_seal','e_window','e_instruction'];
    const MODAL = document.getElementById('edit_modal');
    if(!MODAL) return;

    function isVisible(el){
      return !!el && (el.offsetParent !== null || getComputedStyle(el).display !== 'none');
    }

    function snapshotFields(){
      const snap = {};
      IDS.forEach(id=>{
        const el = document.getElementById(id);
        snap[id] = el ? (el.value||'') : '';
      });
      // also snapshot dropdown text
      const dd = {
        loadempty: (document.getElementById('dd_loadempty')||{}).textContent || '',
        impexp: (document.getElementById('dd_impexp')||{}).textContent || ''
      };
      return {fields:snap, dd};
    }

    function restoreIfBlank(snap){
      let changed = false;
      IDS.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(!el.value && snap.fields[id]){ el.value = snap.fields[id]; changed = true; }
      });
      const ddLE = document.getElementById('dd_loadempty');
      if(ddLE && (!ddLE.textContent || !ddLE.textContent.trim()) && snap.dd.loadempty){
        ddLE.textContent = snap.dd.loadempty; changed = true;
      }
      const ddIE = document.getElementById('dd_impexp');
      if(ddIE && (!ddIE.textContent || !ddIE.textContent.trim()) && snap.dd.impexp){
        ddIE.textContent = snap.dd.impexp; changed = true;
      }
      return changed;
    }

    function startWatchdog(){
      if(!isVisible(MODAL)) return;
      const snap = snapshotFields();

      // MutationObserver on the modal subtree
      const mo = new MutationObserver(()=>{ restoreIfBlank(snap); });
      mo.observe(MODAL, {subtree:true, characterData:true, childList:true, attributes:true});

      // Periodic check as a belt-and-suspenders
      let alive = true;
      const iv = setInterval(()=>{
        if(!isVisible(MODAL)){ alive=false; mo.disconnect(); clearInterval(iv); return; }
        restoreIfBlank(snap);
      }, 120);

      // Patch clearEditFields to NO-OP while modal visible
      try{
        const origClear = window.clearEditFields;
        if(typeof origClear==='function' && !window.__CCL_CLEAR_WRAP_V6__){
          window.__CCL_CLEAR_WRAP_V6__ = true;
          window.clearEditFields = function(){
            if(isVisible(MODAL)) return; // block while editing
            return origClear.apply(this, arguments);
          };
        }
      }catch(_){}
    }

    // Hook after openEdit and Edit button click
    if(typeof window.openEdit === 'function'){
      const orig = window.openEdit;
      window.openEdit = function(){
        const r = orig.apply(this, arguments);
        setTimeout(startWatchdog, 0);
        return r;
      };
    }
    const btn = document.getElementById('btn_edit_pending');
    if(btn){ btn.addEventListener('click', function(){ setTimeout(startWatchdog, 40); }, true); }
  });
})();
</script>

<!-- === CCL: EDIT MUST PREFILL FROM SELECTED JOB (Final) === -->
<script>
(function(){
  if (window.__CCL_EDIT_PREFILL_FINAL__) return; window.__CCL_EDIT_PREFILL_FINAL__ = true;
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){

    const FIELD_IDS = {
      from: 'e_from',
      to: 'e_to',
      container: 'e_container',
      appt: 'e_loadempty',   // LOAD/EMPTY maps to 'appt' in data
      bk: 'e_bkpin',
      ie: 'e_impexp',
      seal: 'e_seal',
      window: 'e_window',
      remark: 'e_instruction'
    };

    function text(v){ return (v==null || v==='—') ? '' : String(v); }

    function getSelectedRow(){
      const tb = document.querySelector('#section_pending tbody'); if(!tb) return null;
      // 1) checkbox
      const chk = tb.querySelector('input[type="checkbox"]:checked');
      if(chk) return chk.closest('tr');
      // 2) highlighted row
      const sel = tb.querySelector('tr.selected');
      if(sel) return sel;
      // 3) app state
      try{
        if(window.state && state.selectedPending && state.selectedPending.size===1){
          const id = Array.from(state.selectedPending)[0];
          const byId = tb.querySelector('tr[data-id="'+id+'"]');
          if(byId) return byId;
        }
      }catch(_){}
      return null;
    }

    function getSelectedId(){
      const tr = getSelectedRow();
      return tr ? (tr.getAttribute('data-id') || '') : '';
    }

    function readDomMapByRow(tr){
      const map = {}; if(!tr) return map;
      Array.from(tr.children).forEach(td => {
        const k = td && td.dataset ? (td.dataset.colKey || td.dataset.col || td.getAttribute('data-col') || td.getAttribute('data-colkey')) : null;
        if(!k) return;
        map[k] = (td.textContent||'').trim();
      });
      return map;
    }

    function findRecordById(id){
      let rec = null;
      // from window.pending
      try{ if(Array.isArray(window.pending)){ rec = window.pending.find(r => r && String(r.id)===String(id)) || null; } }catch(_){}
      if(rec) return rec;
      // from localStorage ccl_pending
      try{
        const s = localStorage.getItem('ccl_pending');
        if(s){ const arr = JSON.parse(s)||[]; rec = arr.find(r => r && String(r.id)===String(id)) || null; }
      }catch(_){}
      return rec;
    }

    function buildRecordFromMap(map){
      // normalize minimal record using our known keys
      return {
        from: map.from, to: map.to, container: map.container, appt: map.appt,
        bk: map.bk, ie: map.ie, seal: map.seal, window: map.window, remark: map.remark
      };
    }

    function fillModal(rec, map){
      // Use rec when available; fall back to DOM map
      const src = Object.assign({}, map||{}, rec||{});
      Object.keys(FIELD_IDS).forEach(k => {
        const id = FIELD_IDS[k];
        const el = document.getElementById(id);
        if(!el) return;
        el.value = text(src[k]);
      });
      // Update dropdown labels
      const ddLE = document.getElementById('dd_loadempty');
      if(ddLE){ ddLE.textContent = document.getElementById('e_loadempty')?.value || ddLE.textContent || 'Select…'; }
      const ddIE = document.getElementById('dd_impexp');
      if(ddIE){ ddIE.textContent = document.getElementById('e_impexp')?.value || ddIE.textContent || 'Select…'; }
    }

    function prefillSelected(){
      const tr = getSelectedRow();
      const selId = getSelectedId();
      if(!tr || !selId) return false;

      // Trust table selection (sync state if needed)
      try{ state.selectedPending = new Set([selId]); }catch(_){}

      const map = readDomMapByRow(tr);
      let rec = findRecordById(selId);
      if(!rec){ rec = buildRecordFromMap(map); }

      fillModal(rec, map);
      return true;
    }

    function lockAgainstClears(ms){
      const MODAL = document.getElementById('edit_modal');
      if(!MODAL) return;
      const start = Date.now();
      // wrap clearEditFields while modal visible
      try{
        const origClear = window.clearEditFields;
        if(typeof origClear==='function' && !window.__CCL_CLEAR_WRAP_FINAL__){
          window.__CCL_CLEAR_WRAP_FINAL__ = true;
          window.clearEditFields = function(){
            if(MODAL && (MODAL.offsetParent !== null || getComputedStyle(MODAL).display !== 'none')) return;
            return origClear.apply(this, arguments);
          };
        }
      }catch(_){}
      const snap = {}; Object.keys(FIELD_IDS).forEach(k => {
        const el = document.getElementById(FIELD_IDS[k]); snap[FIELD_IDS[k]] = el ? el.value : '';
      });
      const iv = setInterval(function(){
        const elapsed = Date.now()-start;
        Object.keys(FIELD_IDS).forEach(k=>{
          const id = FIELD_IDS[k];
          const el = document.getElementById(id);
          if(el && !el.value && snap[id]) el.value = snap[id];
        });
        const ddLE2 = document.getElementById('dd_loadempty');
        if(ddLE2){ ddLE2.textContent = document.getElementById('e_loadempty')?.value || ddLE2.textContent || 'Select…'; }
        const ddIE2 = document.getElementById('dd_impexp');
        if(ddIE2){ ddIE2.textContent = document.getElementById('e_impexp')?.value || ddIE2.textContent || 'Select…'; }
        if(elapsed > ms){ clearInterval(iv); }
      }, 60);
    }

    // Wrap openEdit: open modal first, then hard prefill + guard
    if(typeof window.openEdit === 'function'){
      const _orig = window.openEdit;
      window.openEdit = function(){
        const r = _orig.apply(this, arguments);
        // schedule focused prefill and guard
        setTimeout(function(){ prefillSelected(); lockAgainstClears(1200); }, 0);
        setTimeout(function(){ prefillSelected(); }, 120);   // late pass (if a re-render happens)
        setTimeout(function(){ prefillSelected(); }, 280);   // extra insurance
        return r;
      };
    }

    // Also bind the physical Edit button in case the app calls different paths
    const btn = document.getElementById('btn_edit_pending');
    if(btn){
      btn.addEventListener('click', function(){
        setTimeout(function(){ prefillSelected(); lockAgainstClears(1200); }, 40);
      }, true);
    }
  });
})();
</script>

<script>
/* === STICKY PREFILL (prevents 1s reset) === */
(function(){
  function $(sel, root){ return (root||document).querySelector(sel); }
  function qa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function text(el){ return (el && (el.textContent||'').trim()) || ''; }
  function setVal(id, v){ var e=document.getElementById(id); if(e){ e.value = v||''; } }
  function setDD(hiddenId, btnId, v){
    var hid=document.getElementById(hiddenId), btn=document.getElementById(btnId);
    if(hid) hid.value = v||'';
    if(btn) btn.textContent = v ? String(v) : 'Select…';
  }
  function headerKeys(table){
    var ths = qa('thead tr:first-child th', table);
    var offset = 0;
    if(ths.length && text(ths[0]) === '') offset += 1;      // checkbox
    if(ths.length > offset && /driver/i.test(text(ths[offset]))) offset += 1; // optional Driver col
    var keys = ths.slice(offset).map(function(th){
      return th.dataset.key ? th.dataset.key : text(th);
    });
    return {keys: keys, offset: offset};
  }
  function extractFromRow(tr){
    var table = tr.closest('table');
    var hk = headerKeys(table);
    var tds = qa('td', tr).slice(hk.offset);
    var map = {};
    tds.forEach(function(td, i){ map[hk.keys[i] || ('COL_'+i)] = text(td); });
    map.id = map['Job #'] || tr.getAttribute('data-id') || '';
    return map;
  }
  function applyToModal(map){
    setVal('e_from',        map['From'] || map['from'] || '');
    setVal('e_to',          map['To'] || map['to'] || '');
    setVal('e_container',   map['Container #'] || map['CONTAINER'] || map['container'] || '');
    setVal('e_bkpin',       map['BK # / PIN'] || map['bk'] || map['pin'] || '');
    setVal('e_seal',        map['Seal #'] || map['seal'] || '');
    setVal('e_window',      map['Window'] || map['window'] || '');
    setVal('e_instruction', map['Instruction'] || map['remark'] || '');
    setDD('e_loadempty', 'dd_loadempty', map['LOAD / EMPTY'] || map['APPT TIME'] || map['appt'] || '');
    setDD('e_impexp',    'dd_impexp',    map['Import / Export'] || map['ie'] || '');
    var pill = document.getElementById('e_jobpill');
    if(pill){ pill.textContent = map.id || 'Job #'; }
  }
  function isVisible(el){
    if(!el) return false;
    var s = window.getComputedStyle(el);
    return s.display !== 'none' && s.visibility !== 'hidden' && s.opacity !== '0';
  }
  function stickyFill(map){
    var modal = document.getElementById('edit_modal');
    var until = Date.now() + 1500; // keep enforcing for 1.5s
    // Guard: cancel any previous timer
    if(window.__prefillTimer){ clearInterval(window.__prefillTimer); window.__prefillTimer=null; }
    // Block form.reset during sticky window
    var form = modal ? modal.querySelector('form') : null;
    var origReset = form && form.reset;
    if(form){
      form.reset = function(){ /* swallow resets while sticky */ };
      form.addEventListener('reset', function(e){ e.preventDefault(); }, {once:true});
    }
    // First pass immediately
    applyToModal(map);
    window.__prefillTimer = setInterval(function(){
      if(Date.now() > until || !isVisible(modal)){
        clearInterval(window.__prefillTimer); window.__prefillTimer=null;
        if(form && origReset) form.reset = origReset;
        return;
      }
      // Re-apply if any field got cleared
      var needs = false;
      ['e_container','e_bkpin','e_seal','e_window','e_from','e_to','e_instruction'].forEach(function(id){
        var el=document.getElementById(id);
        if(el && el.value === '') needs = true;
      });
      var dd1=document.getElementById('e_impexp'); var dd2=document.getElementById('e_loadempty');
      if((dd1 && dd1.value==='') || (dd2 && dd2.value==='')) needs=true;
      if(needs) applyToModal(map);
    }, 40);
    // Also stop on Save/Cancel
    ['btn_modal_cancel','btn_modal_save','btn_modal_close'].forEach(function(id){
      var b=document.getElementById(id);
      if(b){ b.addEventListener('click', function(){ if(window.__prefillTimer){ clearInterval(window.__prefillTimer); window.__prefillTimer=null; if(form && origReset) form.reset = origReset; }}, {once:true}); }
    });
  }
  function selectedRow(){
    return document.querySelector('#section_pending tbody input[type="checkbox"]:checked')?.closest('tr')
        || document.querySelector('#section_pending tbody tr.selected')
        || null;
  }
  function openModal(){ var m=document.getElementById('edit_modal'); if(m){ m.style.display='flex'; } }
  function bind(){
    var btn=document.getElementById('btn_edit_pending'); if(!btn) return;
    btn.addEventListener('click', function(){
      var tr = selectedRow();
      if(!tr){ if(window.toast){ toast('Select a row first'); } return; }
      var map = extractFromRow(tr);
      openModal();
      // Apply, then keep sticky for short time to defeat clearing code
      setTimeout(function(){ stickyFill(map); }, 10);
    }, true);
  }
  if(document.readyState !== 'loading'){ bind(); } else { document.addEventListener('DOMContentLoaded', bind, {once:true}); }
})();
</script>


<!-- === CCL MONOTONIC JOB ID PATCH v1 (non-invasive) === -->
<script>
(function(){
  const LS_KEY_LAST = "ccl_last_job_num_v1";   // numeric part, e.g., 5007
  const PREFIX = "CCL-";
  const START_AT = 5001;

  function readLast(){
    const v = parseInt(localStorage.getItem(LS_KEY_LAST), 10);
    return Number.isFinite(v) ? v : null;
  }
  function writeLast(n){
    try{ localStorage.setItem(LS_KEY_LAST, String(n)); }catch(_){}
  }
  function scanHighestFromList(list){
    let maxN = 0;
    (list||[]).forEach(r => {
      const m = String(r && r.id || "").match(/^CCL-(\d{4,})$/);
      if(m){
        const n = parseInt(m[1], 10);
        if(Number.isFinite(n)) maxN = Math.max(maxN, n);
      }
    });
    return maxN || null;
  }

  // Public API: next id and commit id
  window.getNextJobNumber = function(){
    let last = readLast();
    if(last == null){
      // Seed from whatever arrays exist globally
      const all = []
        .concat(Array.isArray(window.pending)?window.pending:[])
        .concat(Array.isArray(window.pickups)?window.pickups:[])
        .concat(Array.isArray(window.assigned)?window.assigned:[])
        .concat(Array.isArray(window.inprogress)?window.inprogress:[])
        .concat(Array.isArray(window.completed)?window.completed:[]);
      const inferred = scanHighestFromList(all);
      last = (inferred != null ? inferred : (START_AT-1));
    }
    return PREFIX + String(last + 1);
  };
  window.commitJobId = function(id){
    const m = String(id||"").match(/^CCL-(\d{4,})$/);
    if(!m) return;
    const n = parseInt(m[1], 10);
    const last = readLast();
    if(last == null || n > last) writeLast(n);
  };

  // Prefill #c_id whenever Create modal opens
  function tryPrefill(){
    const idEl = document.getElementById('c_id');
    if(idEl){ idEl.value = window.getNextJobNumber(); idEl.readOnly = true; }
  }

  // Hook: Create New button
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    if(t.id === 'btn_create_pending' || (t.closest && t.closest('#btn_create_pending'))){
      // Give any existing open/create logic a frame to run first
      setTimeout(tryPrefill, 50);
    }
  }, true);

  // Hook: when Update is clicked, commit the ID so it never reuses
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    if(t.id === 'btn_create_update' || (t.closest && t.closest('#btn_create_update'))){
      setTimeout(function(){
        const idEl = document.getElementById('c_id');
        if(idEl && idEl.value){ window.commitJobId(idEl.value.trim()); }
      }, 10);
    }
  }, true);

  // Safety: observe the create modal becoming visible and prefill
  const cm = document.getElementById('create_modal');
  if(cm && 'IntersectionObserver' in window){
    const obs = new MutationObserver(() => {
      const style = getComputedStyle(cm);
      if(style.display !== 'none' && style.visibility !== 'hidden'){ tryPrefill(); }
    });
    obs.observe(cm, { attributes:true, attributeFilter:['style','class'] });
  }

  // One-time seed LAST from DOM, if empty
  (function bootstrap(){
    if(readLast() != null) return;
    let maxSeen = 0;
    try{
      const cells = document.querySelectorAll('tbody td:first-child, tbody td[data-col="id"]');
      cells.forEach(td => {
        const txt = (td.textContent || '').trim();
        const m = txt.match(/^CCL-(\d{4,})/);
        if(m){ const n = parseInt(m[1], 10); if(Number.isFinite(n)) maxSeen = Math.max(maxSeen, n); }
      });
    }catch(_){}
    if(maxSeen > 0){ writeLast(maxSeen); }
  })();
})();
</script>
<!-- === /CCL MONOTONIC JOB ID PATCH v1 === -->


<!-- === Driver Match / Mismatch Auto-Advance (drop-in) === -->
<script>
(function(){
  // Guard against double-injection
  if (window.__driverMatchFlowEnabled__) return;
  window.__driverMatchFlowEnabled__ = true;

  // Ensure alert modal helpers exist; lazily create a modal if missing
  window.openAlert = window.openAlert || function(msg){
    var m = document.getElementById('alert_modal');
    var t = document.getElementById('alert_text');
    if(!m){
      m = document.createElement('div');
      m.id = 'alert_modal';
      m.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:999999;';
      var inner = document.createElement('div');
      inner.style.cssText = 'background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:14px;max-width:520px;width:92%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.4);';
      var h = document.createElement('div'); h.textContent = 'Notice'; h.style.cssText='font-weight:700;margin-bottom:8px;font-size:18px;';
      t = document.createElement('div'); t.id='alert_text'; t.style.cssText='white-space:pre-wrap;line-height:1.4;margin-bottom:16px;';
      var b = document.createElement('button'); b.textContent='OK'; b.onclick=function(){ closeAlert(); }; b.style.cssText='padding:8px 14px;border-radius:10px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;';
      inner.appendChild(h); inner.appendChild(t); inner.appendChild(b);
      m.appendChild(inner);
      document.body.appendChild(m);
      m.style.display='none';
    }
    if(t) t.textContent = msg || 'Driver mismatch.';
    m.style.display = 'flex';
  };
  window.closeAlert = window.closeAlert || function(){ var m = document.getElementById('alert_modal'); if(m) m.style.display='none'; };

  function byText(ths, text){
    for (var i=0;i<ths.length;i++){
      if (((ths[i].textContent||'').trim()||'') === text) return i;
    }
    return -1;
  }
  function getAssignedDriverColIndex(){
    var ths = document.querySelectorAll('#section_assigned thead th');
    var idx = byText(ths,'Driver');
    if (idx !== -1) return idx;
    return 1; // fallback
  }
  function getDriversDriverColIndex(){
    var ths = document.querySelectorAll('#section_drivers_bottom thead th');
    var idx = byText(ths,'Driver');
    if (idx !== -1) return idx;
    return 3; // fallback
  }

  function moveAssignedJobToInProgressById(jobId){
    if (typeof window.inprogress === 'undefined' || !Array.isArray(window.inprogress)) {
      window.inprogress = [];
    }
    try {
      var a = window.assigned || [];
      var idx = -1;
      for (var i=0;i<a.length;i++){ if(String(a[i]?.id)===String(jobId)){ idx=i; break; } }
      if (idx === -1) return false;
      var job = a[idx];
      a.splice(idx,1);
      window.inprogress.unshift(Object.assign({}, job, {status:'In-Progress'}));

      try{ if(typeof window.renderAssigned==='function') window.renderAssigned(); }catch(e){}
      try{ if(typeof window.renderInprogress==='function') window.renderInprogress(); }catch(e){}
      try{ if(typeof window.updateBadges==='function') window.updateBadges(); }catch(e){}
      try{ if(typeof window.switchTab==='function') window.switchTab('inprogress'); }catch(e){}
      try{ if(typeof window.toast==='function') window.toast('Driver matched — moved to In-Progress'); }catch(e){}
      return true;
    } catch(e){ console && console.warn && console.warn('moveAssignedJobToInProgressById error', e); return false; }
  }

  function enableDriverClickMatchFlow(){
    var drvBody = document.getElementById('drv_body');
    if(!drvBody) return;
    drvBody.addEventListener('click', function(e){
      var row = e.target.closest('tr'); if(!row) return;

      var drvColIdx = getDriversDriverColIndex();
      var selectedDriverName = ((row.children[drvColIdx]||{}).textContent||'').trim();

      var onAssigned = (window.state && window.state.currentTab === 'assigned');
      if(!onAssigned){
        if(window.state) window.state.selectedDriver = { name: selectedDriverName };
        return;
      }

      var assignedBody = document.getElementById('assigned_body'); if(!assignedBody) return;
      var cbs = assignedBody.querySelectorAll('input[type="checkbox"]:checked');
      var selectedJobRows = [];
      cbs.forEach(function(cb){ var tr = cb.closest('tr'); if(tr) selectedJobRows.push(tr); });
      if(selectedJobRows.length !== 1) return;

      var jobTr = selectedJobRows[0];
      var jobId = jobTr.getAttribute('data-id') || (jobTr.dataset && jobTr.dataset.id) || '';
      var jobDrvColIdx = getAssignedDriverColIndex();
      var jobDriverName = ((jobTr.children[jobDrvColIdx]||{}).textContent||'').trim();

      if(window.state) window.state.selectedDriver = { name: selectedDriverName };

      if(jobDriverName && selectedDriverName && jobDriverName === selectedDriverName){
        moveAssignedJobToInProgressById(jobId);
      } else {
        openAlert(
          'Driver mismatch.\n\n' +
          'Selected driver: ' + (selectedDriverName || '—') + '\n' +
          'Job is assigned to: ' + (jobDriverName || '—') + '\n\n' +
          'Pick the correct driver or update the job’s driver first.'
        );
      }
    }, true);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', enableDriverClickMatchFlow);
  } else {
    enableDriverClickMatchFlow();
  }
})();
</script>
<!-- === End Driver Match / Mismatch block === -->

<script>
// === CCL Inline Cell Editing (no modal) — v1 ===
// Works on all tables. Double‑click any data cell to edit directly.
// Saves back into the correct in‑memory array (pending/assigned/inprogress/pickups/completed).
// Also persists pending edits to localStorage (ccl_pending_extras_v1) so they stick on refresh
// with your existing seed mechanism.

(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function tableMeta(td){
    const tr = td.closest('tr'); if(!tr) return null;
    const tbody = tr.parentElement; if(!tbody) return null;
    const table = tbody.closest('table'); if(!table) return null;
    const thead = table.querySelector('thead'); if(!thead || !thead.rows.length) return null;
    const hdr = thead.rows[0];
    const colIdx = Array.prototype.indexOf.call(tr.children, td);
    if(colIdx < 0) return null;
    const th = hdr.children[colIdx];
    // Determine key for this column
    let key = th && th.dataset ? th.dataset.key : null;
    // Skip non-data columns (checkbox / Driver) and unknowns
    const label = th ? (th.textContent||'').trim().toUpperCase() : '';
    if(!key){
      if(label === '' /* checkbox col */ || label === 'DRIVER'){ return null; }
      // fallback: map by label when dataset.key missing
      const L = {
        'JOB':'id','CONTAINER':'container','CHASSIS':'chassis','SIZE TYPE':'size','PIN':'pin',
        'IMPORT / EXPORT':'ie','BK/EDO':'bk','PICK PORT':'from','P/U DATE':'pudate','APPT TIME':'appt',
        'DEL DATE':'deliveryDate','DELIVERY':'to','LFD DATE':'lfd','RETURN DATE':'returnDate',
        'RETURN PORT':'returnPort','CUSTOMER':'customer','REMARK':'remark','CARRIER NAME':'carrier',
        'MB/L NO.':'mbl','DROP / LIVE':'status','DATE OF ARRIVAL':'arrival'
      };
      key = L[label] || null;
    }
    if(!key) return null;

    // Determine which dataset this tbody represents
    const tbid = (tbody.id||'').toLowerCase();
    let arrName = null;
    if(tbid.includes('pending')) arrName = 'pending';
    else if(tbid.includes('assigned')) arrName = 'assigned';
    else if(tbid.includes('inprogress')) arrName = 'inprogress';
    else if(tbid==='p1_body' || tbid.includes('pickup')) arrName = 'pickups';
    else if(tbid.includes('completed')) arrName = 'completed';
    if(!arrName) return null;

    // Row identity
    let rowId = tr.getAttribute('data-id');
    if(!rowId){
      // Fallback: try to find the 'JOB' cell in this row by looking up header for 'id'
      // Find the header index for key 'id'
      let idCol = -1;
      for(let i=0;i<hdr.children.length;i++){
        if(hdr.children[i].dataset && hdr.children[i].dataset.key==='id'){ idCol = i; break; }
        const txt = (hdr.children[i].textContent||'').trim().toUpperCase();
        if(idCol<0 && txt==='JOB') idCol = i;
      }
      if(idCol>=0 && tr.children[idCol]){
        rowId = tr.children[idCol].textContent.trim();
      }
    }
    return {tr, tbody, table, thead, colIdx, th, key, arrName, rowId};
  }

  function getArrayByName(name){
    // Guard for missing globals
    try{
      if(name==='pending') return window.pending || [];
      if(name==='assigned') return window.assigned || [];
      if(name==='inprogress') return window.inprogress || [];
      if(name==='pickups') return window.pickups || [];
      if(name==='completed') return window.completed || [];
    }catch(_){}
    return [];
  }

  function persistIfNeeded(name){
    // Persist pending into your existing localStorage key so refresh keeps edits
    if(name==='pending'){
      try{ localStorage.setItem('ccl_pending_extras_v1', JSON.stringify(window.pending||[])); }catch(_){}
    }
  }

  function renderCell(td, value){
    // Minimal normalization: empty -> em dash, else plain text
    const v = (value==null || String(value).trim()==='') ? '—' : String(value);
    td.innerHTML = '';
    const span = document.createElement('span');
    // Keep centered dash look
    if(v==='—'){ span.className = 'dash-center'; }
    span.textContent = v;
    td.appendChild(span);
  }

  function makeEditor(td, currentText){
    // Use <input> for single-line; if original cell had a newline, use <textarea>
    const multiline = /\n/.test(currentText);
    const ed = multiline ? document.createElement('textarea') : document.createElement('input');
    if(!multiline) ed.type = 'text';
    ed.value = (currentText==='—' ? '' : currentText);
    ed.style.width = '100%';
    ed.style.background = '#0f172a';
    ed.style.color = '#e6edf7';
    ed.style.border = '1px solid #334155';
    ed.style.borderRadius = '8px';
    ed.style.padding = '6px 8px';
    ed.style.minHeight = multiline ? '64px' : 'auto';
    return ed;
  }

  function beginEdit(td){
    const meta = tableMeta(td);
    if(!meta) return;
    const { key, arrName, rowId, tr, colIdx } = meta;

    // Do not allow editing checkbox/status if you want; here we allow everything except checkbox col
    // You can special-case 'status' to keep dash behavior—already handled in renderCell.

    // Current cell text
    const currentText = td.textContent.trim();
    // If an editor already exists, skip
    if(td.querySelector('input,textarea')) return;

    const editor = makeEditor(td, currentText);
    td.innerHTML = '';
    td.appendChild(editor);
    editor.focus();
    // place caret at end
    try{ const len = editor.value.length; editor.setSelectionRange && editor.setSelectionRange(len, len); }catch(_){}

    function commit(){
      const newVal = editor.value.trim();
      // Write to array object
      const arr = getArrayByName(arrName);
      if(rowId && Array.isArray(arr)){
        const idx = arr.findIndex(x => (x && (x.id===rowId || String(x.id).trim()===String(rowId).trim())));
        if(idx >= 0){
          // Update underlying data
          arr[idx][key] = newVal;
          // Re-render only this cell to avoid flicker
          renderCell(td, newVal);
          // Ensure the <tr> keeps the latest id display if we edited 'id'
          if(key==='id'){
            tr.setAttribute('data-id', newVal);
          }
          // Persist pending set
          persistIfNeeded(arrName);
        }else{
          // Could not resolve row; still update the UI cell
          renderCell(td, newVal);
        }
      }else{
        renderCell(td, newVal);
      }
    }

    function cancel(){
      // Restore original without changing array
      renderCell(td, currentText);
    }

    editor.addEventListener('keydown', function(ev){
      if(ev.key==='Enter' && !(ev.shiftKey || ev.ctrlKey || ev.metaKey)){ commit._called = false;
        ev.preventDefault();
        editor.blur();
      }else if(ev.key==='Escape'){
        ev.preventDefault();
        cancel();
      }
    });
    editor.addEventListener('blur', commit, {once:true});
  }

  ready(function(){
    // Delegate dblclick on every table body cell
    document.getElementById('section_pending').addEventListener('dblclick', function(ev){
      // Prevent legacy modal from triggering on dblclick
      try{ ev.stopPropagation(); ev.preventDefault(); }catch(_){}
      const td = ev.target && ev.target.closest ? ev.target.closest('td') : null;
      if(!td) return;
      // Avoid editing the selection checkbox column (usually first col)
      const tr = td.closest('tr');
      const isCheckboxCol = td.cellIndex === 0;
      if(isCheckboxCol) return;
      beginEdit(td);
    }, true);
  });
})();
</script>


<!-- Inline Edit Confirmation Modal -->
<style>
#inline_confirm_modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(2,6,23,.75);}
#inline_confirm_modal .card{background:#0b1220;border:1px solid #334155;border-radius:14px;padding:14px;max-width:440px;width:92%;box-shadow:0 18px 40px rgba(0,0,0,.6);}
#inline_confirm_modal h4{margin:0 0 8px 0;color:#e6edf7;font-size:16px;font-weight:700;}
#inline_confirm_modal .kv{font-size:12px;color:#a9bdd7;margin:6px 0;}
#inline_confirm_modal .kv b{color:#dbe7ff;}
#inline_confirm_modal .diff{background:#0f172a;border:1px solid #2b3a55;border-radius:10px;padding:8px;margin-top:8px;color:#e6edf7;font-size:13px;white-space:pre-wrap;}
#inline_confirm_modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
#inline_confirm_modal .btn{padding:8px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e6edf7;cursor:pointer;}
#inline_confirm_modal .btn.primary{background:#2563eb;border-color:#1d4ed8;color:#fff;}
#inline_confirm_modal .btn:hover{filter:brightness(1.05);}
</style>
<div id="inline_confirm_modal" aria-modal="true" role="dialog">
  <div class="card">
    <h4>Confirm change?</h4>
    <div class="kv"><b>Job:</b> <span id="icm_job">—</span></div>
    <div class="kv"><b>Field:</b> <span id="icm_field">—</span></div>
    <div class="diff"><b>From:</b> <span id="icm_old">—</span>\n<b>To:</b> <span id="icm_new">—</span></div>
    <div class="actions">
      <button class="btn" id="icm_cancel">Cancel</button>
      <button class="btn primary" id="icm_save">Save</button>
    </div>
  </div>
</div>
<script>
(function(){
  const modal = document.getElementById('inline_confirm_modal');
  const fJob = document.getElementById('icm_job');
  const fField = document.getElementById('icm_field');
  const fOld = document.getElementById('icm_old');
  const fNew = document.getElementById('icm_new');
  const btnCancel = document.getElementById('icm_cancel');
  const btnSave = document.getElementById('icm_save');
  let _resolver = null;

  function openModal(data){
    fJob.textContent = data.job || '—';
    fField.textContent = data.field || '—';
    fOld.textContent = data.old || '';
    fNew.textContent = data.new || '';
    modal.style.display = 'flex';
    return new Promise(res => { _resolver = res; });
  }
  function closeModal(){ modal.style.display = 'none'; }

  btnCancel.addEventListener('click', function(){ if(_resolver){ _resolver(false); } closeModal(); });
  btnSave.addEventListener('click', function(){ if(_resolver){ _resolver(true); } closeModal(); });

  // Expose to inline editor
  window.__ccl_inline_confirm = openModal;
})();
</script>


<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn, {once:true}); }
  ready(function(){
    const LS_KEY = 'ccl_customers_v1';
    const SEED_LIST = ["MEARSK","WAN- HAI","YANG MING","EVER GREEN","MSC","ZIM LINE","OCCL","SEA LAND","SIM LINE","CMA","TS LINES","ANL","HAG PAG","COSCO","HMM","APL"];
    const ddBtn = document.getElementById('c_dd_customer');
    const ddMenu = document.getElementById('c_menu_customer');
    const inName = document.getElementById('c_customer');
    const inTo = document.getElementById('c_to');
    const inEmail = document.getElementById('c_email');
    const inPhone = document.getElementById('c_phone');
    const btnSave = document.getElementById('c_btn_save_customer');
    const btnDel  = document.getElementById('c_btn_delete_customer');

    if(!ddBtn || !ddMenu) return;
    ensureSeed();

    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function ensureSeed(){ const map = load(); if(Object.keys(map).length===0){ SEED_LIST.forEach(n=>map[n]={}); try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch(_){} } }
    function save(map){ try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch(_){ } }
    function renderMenu(active){
      const map = load();
      ddMenu.innerHTML = '';
      const keys = Object.keys(map).sort((a,b)=>a.localeCompare(b));
      if(!keys.length){
        const empty = document.createElement('div');
        empty.textContent = 'No customers yet';
        empty.style.opacity = .7;
        ddMenu.appendChild(empty);
      } else {
        keys.forEach(name=>{
          const div = document.createElement('div');
          div.textContent = name;
          div.dataset.name = name;
          if(name===active){ div.style.background = '#111827'; }
          div.addEventListener('click', ()=>selectCustomer(name));
          ddMenu.appendChild(div);
        });
      }
    }
    
    function placeMenu(){
      const r = ddBtn.getBoundingClientRect();
      ddMenu.style.left = (Math.round(r.left)+window.scrollX) + 'px';
      ddMenu.style.top  = (Math.round(r.bottom)+window.scrollY) + 'px';
      ddMenu.style.width = Math.round(r.width) + 'px';
    }

    function openMenu(){
      ddMenu.classList.remove('hidden');
      renderMenu(inName.value||'');
      placeMenu();
      const close = (ev)=>{
        if(!ddMenu.contains(ev.target) && ev.target!==ddBtn){
          ddMenu.classList.add('hidden');
          document.removeEventListener('click', close, true);
        }
      };
      setTimeout(()=>document.addEventListener('click', close, true), 0);
      window.addEventListener('resize', placeMenu);
      window.addEventListener('scroll', placeMenu, true);
    }
    function selectCustomer(name){
      const map = load(); let rec = map[name]; if(!rec){ rec = {}; map[name] = rec; }
      inName.value = name;
      ddBtn.textContent = name;
      try{ inTo.value = rec.to||''; }catch(_){}
      try{ inEmail.value = rec.email||''; }catch(_){}
      try{ inPhone.value = rec.phone||''; }catch(_){}
      ddMenu.classList.add('hidden');
    }
    function addOrUpdate(){
      const currentBtnText = ddBtn.textContent.trim();
      const name = (currentBtnText && currentBtnText!=='Select…') ? currentBtnText : prompt('Customer name:');
      if(!name) return;
      const map = load();
      map[name] = { to: (inTo.value||'').trim(), email: (inEmail.value||'').trim(), phone: (inPhone.value||'').trim() };
      save(map);
      inName.value = name;
      ddBtn.textContent = name;
      renderMenu(name);
      if(window.toast) toast('Customer saved');
    }
    function del(){
      const name = inName.value || ddBtn.textContent;
      if(!name || name==='Select…') return;
      if(!confirm('Delete \"'+name+'\"?')) return;
      const map = load(); delete map[name]; save(map);
      inName.value=''; ddBtn.textContent='Select…';
      if(window.toast) toast('Customer deleted');
      renderMenu('');
    }
    function attachConfirm(el, field){
      if(!el) return;
      el.addEventListener('change', function(){
        const name = inName.value;
        if(!name) return;
        const map = load(); let rec = map[name]; if(!rec){ rec = {}; map[name] = rec; }
        const newVal = (el.value||'').trim();
        const oldVal = (rec[field]||'').trim();
        if(newVal !== oldVal){
          const cm = document.getElementById('confirm_modal');
          const setYes = ()=>{ rec[field] = newVal; save(map); if(window.toast) toast('Updated '+field+' for '+name); };
          if(cm){
            const txt = document.getElementById('confirm_text');
            const yes = document.getElementById('confirm_yes');
            const no  = document.getElementById('confirm_no');
            txt.textContent = 'Update saved '+field+' for \"'+name+'\"?';
            cm.style.display='flex';
            const clean = ()=>{ yes.removeEventListener('click', onYes); no.removeEventListener('click', onNo); };
            function onYes(){ setYes(); cm.style.display='none'; clean(); }
            function onNo(){ cm.style.display='none'; clean(); }
            yes.addEventListener('click', onYes, {once:true});
            no.addEventListener('click', onNo, {once:true});
          } else {
            if(window.confirm('Update saved '+field+' for \"'+name+'\"?')) setYes();
          }
        }
      });
    }

    ddBtn.addEventListener('click', openMenu);

    function autoOpen(){
      ddMenu.classList.remove('hidden');
      renderMenu(inName.value||'');
      placeMenu();
    }
    ddBtn.addEventListener('focus', autoOpen);

    btnSave && btnSave.addEventListener('click', addOrUpdate);
    btnDel && btnDel.addEventListener('click', del);
    attachConfirm(inTo, 'to');
    attachConfirm(inEmail, 'email');
    attachConfirm(inPhone, 'phone');
    renderMenu(inName.value||'');
  });
})();
</script>

</body>
</html>

<script>
(function(){
  const SEC_SEL = '#section_drivers_bottom';
  let openMenu = null;
  const activeFilters = new Map(); // colIdx -> Set(values)

  function getCellValue(td){
    if(!td) return '';
    const v = td.getAttribute('data-value') || td.textContent || '';
    return v.trim();
  }

  function uniqueValuesForCol(colIdx){
    const sec = document.querySelector(SEC_SEL);
    const vals = new Set();
    sec.querySelectorAll('tbody tr').forEach(tr => {
      const v = getCellValue(tr.children[colIdx]);
      if(v) vals.add(v);
    });
    return Array.from(vals).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
  }

  function applyFilters(){
    const sec = document.querySelector(SEC_SEL);
    const rows = sec.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      let show = true;
      activeFilters.forEach((set, idx) => {
        if(set && set.size>0){
          const val = getCellValue(tr.children[idx]);
          if(!set.has(val)) show = false;
        }
      });
      tr.style.display = show ? '' : 'none';
    });
  }

  function closeMenu(){
    if(openMenu && openMenu.parentNode){
      openMenu.parentNode.removeChild(openMenu);
    }
    openMenu = null;
    document.removeEventListener('click', onDocClick, true);
    window.removeEventListener('resize', closeMenu);
    window.removeEventListener('scroll', closeMenu, true);
  }

  function onDocClick(e){
    if(!openMenu) return;
    if(!openMenu.contains(e.target)) closeMenu();
  }

  function openFilterFor(th, colIdx){
    closeMenu();
    const rect = th.getBoundingClientRect();
    const menu = document.createElement('div');
    menu.className = 'pp-col-filter';

    const head = document.createElement('div');
    head.className = 'ppf-head';
    const search = document.createElement('input');
    search.placeholder = 'Search...';
    head.appendChild(search);
    menu.appendChild(head);

    const list = document.createElement('div');
    list.className = 'ppf-list';
    menu.appendChild(list);

    const foot = document.createElement('div');
    foot.className = 'ppf-foot';
    const clearBtn = document.createElement('button');
    clearBtn.className = 'ppf-btn';
    clearBtn.textContent = 'Clear';
    const applyBtn = document.createElement('button');
    applyBtn.className = 'ppf-btn primary';
    applyBtn.textContent = 'Apply';
    foot.appendChild(clearBtn);
    foot.appendChild(applyBtn);
    menu.appendChild(foot);

    document.body.appendChild(menu);
    // position just under the header cell
    const top = rect.bottom + 6;
    const left = Math.min(rect.left, window.innerWidth - 340);
    menu.style.top = top + 'px';
    menu.style.left = left + 'px';

    const selected = new Set(activeFilters.get(colIdx) || []);

    function renderItems(){
      list.innerHTML = '';
      const allVals = uniqueValuesForCol(colIdx);
      const q = search.value.trim().toLowerCase();
      // "Select All"
      const allItem = document.createElement('div');
      allItem.className = 'ppf-item';
      const allCb = document.createElement('input'); allCb.type='checkbox';
      const allLbl = document.createElement('span'); allLbl.textContent = 'SELECT ALL';
      // selected if every visible value is selected
      const visibleVals = allVals.filter(v => !q || v.toLowerCase().includes(q));
      const everySel = visibleVals.length>0 && visibleVals.every(v => selected.has(v));
      allCb.checked = everySel;
      allItem.appendChild(allCb); allItem.appendChild(allLbl);
      list.appendChild(allItem);

      allCb.addEventListener('change', ()=>{
        if(allCb.checked){
          visibleVals.forEach(v => selected.add(v));
        }else{
          visibleVals.forEach(v => selected.delete(v));
        }
        renderItems();
      });

      // actual values
      visibleVals.forEach(v => {
        const item = document.createElement('div');
        item.className = 'ppf-item';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = selected.has(v);
        const lbl = document.createElement('span'); lbl.textContent = v || '(blank)';
        item.appendChild(cb); item.appendChild(lbl);
        list.appendChild(item);
        item.addEventListener('click', (e)=>{
          if(e.target.tagName !== 'INPUT'){ cb.checked = !cb.checked; }
          if(cb.checked) selected.add(v); else selected.delete(v);
        });
      });
    }

    renderItems();

    applyBtn.addEventListener('click', ()=>{
      if(selected.size===0){
        activeFilters.delete(colIdx);
      }else{
        activeFilters.set(colIdx, new Set(selected));
      }
      applyFilters();
      closeMenu();
    });

    clearBtn.addEventListener('click', ()=>{
      activeFilters.delete(colIdx);
      applyFilters();
      closeMenu();
    });

    search.addEventListener('input', renderItems);

    openMenu = menu;
    setTimeout(()=>{
      document.addEventListener('click', onDocClick, true);
      window.addEventListener('resize', closeMenu);
      window.addEventListener('scroll', closeMenu, true);
      search.focus();
    },0);
  }

  // Bind filter icon clicks
  function bindFilterIcons(){
    const sec = document.querySelector(SEC_SEL);
    if(!sec) return;
    const ths = sec.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      const icon = th.querySelector('.sort-btn'); // using same element as filter button
      if(icon && !icon._ppFilterBound){
        icon._ppFilterBound = true;
        icon.addEventListener('click', (e)=>{
          e.stopPropagation(); // don't trigger sorting
          openFilterFor(th, idx);
        });
      }
    });
  }

  // Observe changes (re-render)
  const sec = document.querySelector(SEC_SEL);
  if(sec){
    const obs = new MutationObserver(()=> bindFilterIcons());
    obs.observe(sec, { childList:true, subtree:true });
  }
  bindFilterIcons();
})();
</script>

<!-- ===== FORCE-BIND: Create modal Cancel/Update (safe override) ===== -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var modal = document.getElementById('create_modal');

    function resetCreateFields(){
      ['c_id','c_window','c_from','c_to','c_container','c_bkpin','c_seal','c_appt','c_pudate','c_deliveryDate','c_lfd','c_returnDate','c_returnPort','c_customer','c_chassis','c_size','c_pin','c_instruction']
      .forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
      var leH=document.getElementById('c_loadempty'); if(leH) leH.value='';
      var ieH=document.getElementById('c_impexp');   if(ieH) ieH.value='';
      var leT=document.getElementById('c_dd_loadempty'); if(leT) leT.textContent='Select…';
      var ieT=document.getElementById('c_dd_impexp');   if(ieT) ieT.textContent='Select…';
      try{
        if(typeof initDropdown==='function'){
          initDropdown('c_dd_loadempty','c_menu_loadempty', document.getElementById('c_loadempty'));
          initDropdown('c_dd_impexp','c_menu_impexp', document.getElementById('c_impexp'));
        }
      }catch(_){}
    }

    function openCreate(){
      if(!modal) return;
      resetCreateFields();
      modal.style.display='flex';
    }
    function closeCreate(){ if(modal) modal.style.display='none'; }

    // Fallback confirm dialog if openConfirm is missing
    if(typeof window.openConfirm !== 'function'){
      window.openConfirm = function(msg, onYes){
        if(confirm(msg)){ if(onYes) try{ onYes(); }catch(_){ } }
      };
    }

    function gv(id){ var el=document.getElementById(id); return (el && (el.value||'')).trim(); }

    function doCancel(){
      openConfirm('Confirm cancel? Your entries will be lost.', function(){
        closeCreate();
      });
    }

    function doUpdate(){
      var id = gv('c_id');
      if(!id){ if(typeof toast==='function') toast('Enter a Job #'); return; }
      var rec = {
        id: id,
        from: gv('c_from'),
        to: gv('c_to'),
        container: gv('c_container'),
        appt: gv('c_loadempty'),      // Load / Empty
        bk: gv('c_bkpin'),            // BK # / PIN
        ie: gv('c_impexp'),           // Import / Export
        seal: gv('c_seal'),
        window: gv('c_window'),
        remark: gv('c_instruction'),
        pudate: gv('c_pudate'),
        deliveryDate: gv('c_deliveryDate'),
        lfd: gv('c_lfd'),
        returnDate: gv('c_returnDate'),
        returnPort: gv('c_returnPort'),
        customer: gv('c_customer'),
        chassis: gv('c_chassis'),
        size: gv('c_size'),
        pin: gv('c_pin'),
        status: 'Pending'
      };
      openConfirm('Create this new pickup in Main Dispatch?', function(){
        try{
          // Ensure pending array exists
          if(!Array.isArray(window.pending)) window.pending = [];
          window.pending.unshift(rec);
          if(typeof renderPending==='function') renderPending();
          if(typeof updateBadges==='function') updateBadges();
          closeCreate();
          if(typeof switchTab==='function') switchTab('pending');
          if(typeof toast==='function') toast('Pickup created');
        }catch(e){ console.error(e); }
      });
    }

    // Utility to replace existing buttons and bind fresh handlers
    function bindFresh(id, handler){
      var el = document.getElementById(id);
      if(!el || !el.parentNode) return;
      var clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      clone.addEventListener('click', function(ev){ ev.preventDefault(); handler(); });
    }

    bindFresh('btn_create_pending', openCreate);
    bindFresh('btn_create_cancel',  doCancel);
    bindFresh('btn_create_update',  doUpdate);
  });
})();
</script>

<!-- CCL: Create->Main Dispatch (with localStorage persistence), non-invasive -->
<script>
(function(){
  if (window.__ccl_create_persist_wired__) return;
  window.__ccl_create_persist_wired__ = true;

  var LS_KEY = 'ccl_pending_extras_v1';

  function byId(id){ return document.getElementById(id); }
  function readLS(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; }
  }
  function writeLS(arr){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(arr||[])); }catch(e){}
  }
  function mergeExtrasIntoPending(){
    var extras = readLS();
    if (!extras || !extras.length) return;
    try{
      // push into the real 'pending' if available
      for (var i=0;i<extras.length;i++){
        try{ pending.push(extras[i]); }catch(e){
          window.__ccl_pending = window.__ccl_pending || [];
          window.__ccl_pending.push(extras[i]);
        }
      }
    }catch(e){}
  }

  // Fallbacks
  function ensureSwitchTab(){
    if (typeof window.switchTab === 'function') return;
    window.switchTab = function(name){
      var sections = ['pickups','assigned','inprogress','completed','pending'];
      sections.forEach(function(s){
        var sec = byId('section_'+s);
        var tab = byId('tab_'+s);
        if (!sec || !tab) return;
        if (s === name){ sec.classList.remove('hidden'); tab.classList.add('active'); }
        else { sec.classList.add('hidden'); tab.classList.remove('active'); }
      });
    };
  }
  function ensureRenderPending(){
    if (typeof window.renderPending === 'function') return;
    window.renderPending = function(){
      var table = (byId('section_pending')||{}).querySelector && byId('section_pending').querySelector('table');
      var body = byId('pending_body'); if(!table || !body) return;
      body.innerHTML = '';
      var list;
      try{ list = pending; }catch(_){ list = (window.__ccl_pending || []); }
      // simple fallback render (keeps it independent)
      for (var i=0;i<list.length;i++){
        var a = list[i];
        var tr = document.createElement('tr');
        tr.innerHTML = '<td></td><td>'+(a.driverName||'—')+'</td>' +
                       '<td>'+(a.id||'')+'</td><td>'+(a.from||'')+'</td><td>'+(a.to||'')+'</td>' +
                       '<td>'+(a.container||'')+'</td><td>'+(a.appt||'')+'</td><td>'+(a.bk||'')+'</td>' +
                       '<td>'+(a.window||'')+'</td><td>'+(a.status||'')+'</td>';
        body.appendChild(tr);
      }
    };
  }
  function updateBadgesSafe(){
    try{
      if (typeof window.updateBadges === 'function') window.updateBadges();
      else{
        var len; try{ len = pending.length; }catch(e){ len = (window.__ccl_pending||[]).length; }
        var bp = byId('badge_pending'); if (bp) bp.textContent = len;
      }
    }catch(_){}
  }
  function genId(){
    var t = Date.now();
    return 'CCL-' + (t % 1000000).toString().padStart(6,'0');
  }
  function openCreate(){ var m=byId('create_modal'); if(m) m.style.display='flex'; }
  function closeCreate(){ var m=byId('create_modal'); if(m) m.style.display='none'; }

  function collectForm(){
    function gv(id){ var el=byId(id); return (el && el.value) ? el.value : ''; }
    return {
      id: (gv('c_id') || genId()).trim(),
      from: gv('c_from'),
      to: gv('c_to'),
      container: gv('c_container'),
      appt: gv('c_appt'),
      bk: gv('c_bkpin'),
      window: gv('c_window'),
      pudate: gv('c_pudate'),
      deliveryDate: gv('c_deliveryDate'),
      lfd: gv('c_lfd'),
      returnDate: gv('c_returnDate'),
      returnPort: gv('c_returnPort'),
      customer: gv('c_customer'),
      chassis: gv('c_chassis'),
      size: gv('c_size'),
      pin: gv('c_pin'),
      ie: gv('c_impexp'),
      remark: gv('c_instruction'),
      loadempty: gv('c_loadempty'),
      status: 'Open'
    };
  }

  function wire(){
    // Make sure Main Dispatch shows
    ensureSwitchTab();
    try{ window.switchTab('pending'); }catch(_){}

    // Merge saved items into the live list once at startup
    mergeExtrasIntoPending();
    ensureRenderPending();
    try{ window.renderPending(); }catch(_){}
    updateBadgesSafe();

    // Wire Create New button
    var openBtn = byId('btn_create_pending');
    if (openBtn && !openBtn.__wired){
      openBtn.__wired = true;
      openBtn.addEventListener('click', openCreate);
    }

    // Wire Update button
    var updBtn = byId('btn_create_update');
    if (updBtn && !updBtn.__wired){
      updBtn.__wired = true;
      updBtn.addEventListener('click', function(){
        var rec = collectForm();
        // Push into real pending (or fallback buffer)
        var ok = false;
        try{ pending.unshift(rec); ok = true; }catch(e){}
        if (!ok){
          window.__ccl_pending = window.__ccl_pending || [];
          window.__ccl_pending.unshift(rec);
        }
        // Persist
        var extras = readLS();
        extras.push(rec);
        writeLS(extras);

        // Render + switch to Main Dispatch
        ensureRenderPending();
        try{ window.renderPending(); }catch(_){}
        updateBadgesSafe();
        try{ window.switchTab('pending'); }catch(_){}
        closeCreate();
        try{ if (typeof window.toast==='function') window.toast('New pickup added to Main Dispatch.'); }catch(_){}
      });
    }
  }

  if (document.readyState !== 'loading') wire();
  else document.addEventListener('DOMContentLoaded', wire, {once:true});
})();
</script>

<!-- CCL: Direct-append fallback for Create -> Main Dispatch row (additive) -->
<script>
(function(){
  if (window.__ccl_direct_append_wired__) return;
  window.__ccl_direct_append_wired__ = true;

  function byId(id){ return document.getElementById(id); }

  function appendRowDirect(rec){
    try{
      var section = byId('section_pending');
      if (!section) return;
      var table = section.querySelector('table');
      var body = byId('pending_body');
      if (!table || !body) return;

      // Ensure a header exists (attempt to use your helpers for consistent columns)
      if (!table.tHead || !table.tHead.rows || table.tHead.rows.length === 0){
        if (typeof window.buildHeader === 'function'){
          var thead = table.tHead || table.createTHead();
          window.buildHeader(thead, true, true);
        } else {
          // very simple header (fallback)
          var thead2 = table.tHead || table.createTHead();
          var trh = thead2.insertRow();
          ['','Driver','Job #','From','To','Container #','Appointment','BK/EDO','Window','Status']
            .forEach(function(h){
              var th = document.createElement('th');
              th.textContent = h;
              trh.appendChild(th);
            });
        }
      }

      // Build the row
      var tr = document.createElement('tr');
      tr.dataset.id = rec.id || '';

      // Checkbox
      var td0 = document.createElement('td');
      var cb = document.createElement('input');
      cb.type = 'checkbox'; cb.className = 'chk';
      td0.appendChild(cb); tr.appendChild(td0);

      // Driver placeholder
      var tdDriver = document.createElement('td');
      tdDriver.textContent = rec.driverName || '—';
      tr.appendChild(tdDriver);

      // Use your existing builder for the remaining columns if available
      if (typeof window.buildRowCells === 'function' && Array.isArray(window.COL_ORDER)){
        window.buildRowCells(tr, rec, 'Open');
      } else {
        // Fallback cells in a sensible order
        var cells = [
          rec.id || '',
          rec.from || '',
          rec.to || '',
          rec.container || '',
          rec.appt || '',
          rec.bk || '',
          rec.window || '',
          'Open'
        ];
        cells.forEach(function(val){
          var td = document.createElement('td');
          td.textContent = val || '';
          tr.appendChild(td);
        });
      }

      // Insert at top so it's immediately visible
      if (body.firstChild) body.insertBefore(tr, body.firstChild);
      else body.appendChild(tr);

      try{ if (typeof window.updateBadges === 'function') window.updateBadges(); }catch(_){}
    }catch(e){
      console.error('Direct append failed:', e);
    }
  }

  function wireUpdateHook(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_direct_append_hook__) return;
    btn.__ccl_direct_append_hook__ = true;
    btn.addEventListener('click', function(){
      // Slight delay to allow any other handlers to run first
      setTimeout(function(){
        // Re-collect a minimal copy in case earlier handler didn't expose it
        function gv(id){ var el=byId(id); return (el && el.value) ? el.value : ''; }
        var rec = {
          id: (gv('c_id') || ('CCL-' + (Date.now()%1000000).toString().padStart(6,'0'))).trim(),
          from: gv('c_from'),
          to: gv('c_to'),
          container: gv('c_container'),
          appt: gv('c_appt'),
          bk: gv('c_bkpin'),
          window: gv('c_window'),
          pudate: gv('c_pudate'),
          deliveryDate: gv('c_deliveryDate'),
          lfd: gv('c_lfd'),
          returnDate: gv('c_returnDate'),
          returnPort: gv('c_returnPort'),
          customer: gv('c_customer'),
          chassis: gv('c_chassis'),
          size: gv('c_size'),
          pin: gv('c_pin'),
          ie: gv('c_impexp'),
          remark: gv('c_instruction'),
          loadempty: gv('c_loadempty'),
          status: 'Open'
        };

        // Push into the real pending if available
        try{ pending.unshift(rec); }catch(_){
          window.__ccl_pending = window.__ccl_pending || [];
          window.__ccl_pending.unshift(rec);
        }

        // Ensure Main Dispatch visible
        try{
          if (typeof window.switchTab==='function'){ window.switchTab('pending'); }
          else {
            var sec = document.getElementById('section_pending');
            if (sec) sec.classList.remove('hidden');
          }
        }catch(_){}

        // Append directly so it's visible no matter what
        appendRowDirect(rec);

      }, 30);
    });
  }

  if (document.readyState !== 'loading') wireUpdateHook();
  else document.addEventListener('DOMContentLoaded', wireUpdateHook, {once:true});
})();
</script>

<!-- CCL: Cancel button = close Create modal immediately -->
<script>
(function(){
  if (window.__ccl_cancel_closes_create__) return;
  window.__ccl_cancel_closes_create__ = true;
  function byId(id){ return document.getElementById(id); }
  function closeCreate(){ var m = byId('create_modal'); if(m){ m.style.display = 'none'; } }
  function hideConfirm(){
    var cm = byId('confirm_modal');
    if (cm) cm.style.display = 'none';
  }
  function wire(){
    var btn = byId('btn_create_cancel');
    if (!btn || btn.__ccl_cancel_wired__) return;
    btn.__ccl_cancel_wired__ = true;
    // Use capture to beat other listeners and stop them
    btn.addEventListener('click', function(ev){
      try{ ev.stopImmediatePropagation(); }catch(_){}
      try{ ev.preventDefault(); }catch(_){}
      hideConfirm();
      closeCreate();
    }, true);
  }
  if (document.readyState !== 'loading') wire();
  else document.addEventListener('DOMContentLoaded', wire, {once:true});
})();
</script>

<!-- CCL: Dedupe on create + Delete button wiring (additive) -->
<script>
(function(){
  if (window.__ccl_dedupe_delete_wired__) return;
  window.__ccl_dedupe_delete_wired__ = true;

  function byId(id){ return document.getElementById(id); }
  function qs(sel,root){ return (root||document).querySelector(sel); }
  function qsa(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }

  function pendingList(){
    try { return pending; } catch(e) { return (window.__ccl_pending = window.__ccl_pending || []); }
  }

  function findIndexById(list, id){
    for (var i=0;i<list.length;i++){
      if ((list[i].id||'').trim() === id.trim()) return i;
    }
    return -1;
  }

  function ensureNotDuplicate(rec){
    var list = pendingList();
    var idx = findIndexById(list, (rec.id||''));
    if (idx >= 0){
      // Already exists: update shallow fields (optional) and return false to indicate no push
      try{
        for (var k in rec){ if (rec.hasOwnProperty(k)) list[idx][k] = rec[k]; }
      }catch(_){}
      return false;
    }
    return true;
  }

  // Global gate to prevent double-fire within a short window
  function creationGate(){
    var now = Date.now();
    var last = window.__ccl_last_create_ts__ || 0;
    if (now - last < 400) return false; // ignore repeated clicks/handlers
    window.__ccl_last_create_ts__ = now;
    return true;
  }

  // Patch into our direct-append flow if it exists: check DOM for existing row id
  function patchDirectAppend(){
    if (typeof window.appendRowDirect !== 'function') return;
    var orig = window.appendRowDirect;
    window.appendRowDirect = function(rec){
      try{
        var body = byId('pending_body');
        if (body && rec && rec.id){
          var existing = body.querySelector('tr[data-id="'+CSS.escape(rec.id)+'"]');
          if (existing){
            // Move it to top if needed
            if (body.firstChild !== existing){ body.insertBefore(existing, body.firstChild); }
            return;
          }
        }
      }catch(_){}
      return orig.apply(this, arguments);
    };
  }

  // Hook create update button: dedupe both array + DOM by id
  function wireCreateDedupe(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_create_dedupe__) return;
    btn.__ccl_create_dedupe__ = true;
    btn.addEventListener('click', function(){
      setTimeout(function(){
        try{
          // Collect minimal record (matches earlier patches)
          function gv(id){ var el=byId(id); return (el && el.value) ? el.value : ''; }
          var id = (gv('c_id') || ('CCL-' + (Date.now()%1000000).toString().padStart(6,'0'))).trim();
          var rec = {
            id: id,
            from: gv('c_from'), to: gv('c_to'), container: gv('c_container'),
            appt: gv('c_appt'), bk: gv('c_bkpin'), window: gv('c_window'),
            pudate: gv('c_pudate'), deliveryDate: gv('c_deliveryDate'),
            lfd: gv('c_lfd'), returnDate: gv('c_returnDate'), returnPort: gv('c_returnPort'),
            customer: gv('c_customer'), chassis: gv('c_chassis'), size: gv('c_size'),
            pin: gv('c_pin'), ie: gv('c_impexp'), remark: gv('c_instruction'),
            loadempty: gv('c_loadempty'), status: 'Open'
          };

          // Global gate
          if (!creationGate()) return;

          // Array dedupe
          var list = pendingList();
          var shouldPush = ensureNotDuplicate(rec);
          if (shouldPush){ try{ list.unshift(rec); }catch(_){ window.__ccl_pending = window.__ccl_pending || []; window.__ccl_pending.unshift(rec); } }

          // DOM dedupe + position at top handled by appendRowDirect (if present) or here
          var body = byId('pending_body');
          if (body){
            var ex = body.querySelector('tr[data-id="'+CSS.escape(rec.id)+'"]');
            if (ex){
              if (body.firstChild !== ex){ body.insertBefore(ex, body.firstChild); }
            } else {
              // If our helper exists, use it; else make a simple row quickly
              if (typeof window.appendRowDirect === 'function'){
                window.appendRowDirect(rec);
              } else {
                var tr = document.createElement('tr');
                tr.dataset.id = rec.id;
                // Minimal cells (checkbox + driver placeholder + a few fields)
                var td0 = document.createElement('td'); var cb = document.createElement('input'); cb.type='checkbox'; cb.className='chk'; td0.appendChild(cb); tr.appendChild(td0);
                var tdDriver = document.createElement('td'); tdDriver.textContent = rec.driverName || '—'; tr.appendChild(tdDriver);
                ['id','from','to','container','appt','bk','window'].forEach(function(k){
                  var td = document.createElement('td'); td.textContent = rec[k] || ''; tr.appendChild(td);
                });
                var tdStatus = document.createElement('td'); tdStatus.textContent = 'Open'; tr.appendChild(tdStatus);
                if (body.firstChild) body.insertBefore(tr, body.firstChild); else body.appendChild(tr);
              }
            }
          }

          try{ if (typeof window.updateBadges === 'function') window.updateBadges(); }catch(_){}

        }catch(e){ console.error('Create dedupe handler error', e); }
      }, 20);
    });
  }

  // Delete button wiring
  function wireDelete(){
    var btn = byId('btn_delete_pending');
    if (!btn || btn.__ccl_delete_wired__) return;
    btn.__ccl_delete_wired__ = true;
    btn.addEventListener('click', function(){
      var body = byId('pending_body');
      if (!body){ return; }
      var checked = qsa('input[type="checkbox"]:checked', body).map(function(cb){
        var tr = cb.closest('tr');
        return tr && tr.getAttribute('data-id');
      }).filter(Boolean);

      if (!checked.length){
        try{ if (typeof window.toast==='function') window.toast('Select a pickup to delete.'); }catch(_){}
        return;
      }

      // Use existing confirm modal if present
      var cm = byId('confirm_modal'), ct = byId('confirm_text'),
          yes = byId('confirm_yes'), no = byId('confirm_no');
      if (cm && ct && yes && no){
        ct.textContent = 'Delete ' + checked.length + ' pickup' + (checked.length>1?'s':'') + '?';
        cm.style.display = 'flex';
        var onNo = function(){ cm.style.display = 'none'; cleanup(); };
        var onYes = function(){
          try{
            var list = pendingList();
            // Remove from array
            for (var i=0;i<checked.length;i++){
              var idx = findIndexById(list, checked[i]);
              if (idx >= 0){ list.splice(idx,1); }
            }
            // Remove from DOM
            checked.forEach(function(id){
              var row = body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
              if (row) row.remove();
            });
            try{ if (typeof window.updateBadges==='function') window.updateBadges(); }catch(_){}
            try{ if (typeof window.toast==='function') window.toast('Pickup(s) deleted.'); }catch(_){}
          }finally{
            cm.style.display = 'none'; cleanup();
          }
        };
        function cleanup(){
          no.removeEventListener('click', onNo);
          yes.removeEventListener('click', onYes);
        }
        no.addEventListener('click', onNo, {once:true});
        yes.addEventListener('click', onYes, {once:true});
      } else {
        // Fallback: delete without confirm
        var list = pendingList();
        checked.forEach(function(id){
          var idx = findIndexById(list, id);
          if (idx>=0) list.splice(idx,1);
          var row = body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
          if (row) row.remove();
        });
        try{ if (typeof window.updateBadges==='function') window.updateBadges(); }catch(_){}
      }
    });
  }

  function init(){
    patchDirectAppend();
    wireCreateDedupe();
    wireDelete();
  }

  if (document.readyState !== 'loading') init();
  else document.addEventListener('DOMContentLoaded', init, {once:true});

})();
</script>

<!-- CCL: Single-submit guard & reconciliation (additive, high-priority) -->
<script>
(function(){
  if (window.__ccl_single_submit_guard__) return;
  window.__ccl_single_submit_guard__ = true;

  function byId(id){ return document.getElementById(id); }
  function genId(){ var t = Date.now(); return 'CCL-' + (t % 1000000).toString().padStart(6,'0'); }

  // Global registry of committed IDs
  window.__ccl_committed_ids__ = window.__ccl_committed_ids__ || new Set();

  // 1) Capture phase: ensure a stable Job ID exists BEFORE other handlers run
  function captureBind(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_capture_wired__) return;
    btn.__ccl_capture_wired__ = true;
    btn.addEventListener('click', function(ev){
      try{
        var idEl = byId('c_id');
        var idVal = (idEl && idEl.value || '').trim();
        if (!idVal){
          idVal = genId();
          if (idEl) idEl.value = idVal;  // freeze the id so all handlers use the same one
        }
        window.__ccl_current_submit_id__ = idVal;
      }catch(_){}
    }, true); // capture: run before other listeners
  }

  // 2) After-click reconciliation: dedupe array + DOM for that ID
  function bindAfter(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_after_wired__) return;
    btn.__ccl_after_wired__ = true;
    btn.addEventListener('click', function(){
      var id = window.__ccl_current_submit_id__;
      if (!id) return;
      // short delay: let other handlers run first
      setTimeout(function(){
        try{
          // A) Array dedupe
          var list;
          try{ list = pending; }catch(e){ list = (window.__ccl_pending = window.__ccl_pending || []); }
          if (Array.isArray(list)){
            var seen = new Set();
            for (var i=list.length-1; i>=0; i--){ // walk backwards, keep the earliest (top) one
              var pid = (list[i].id||'').trim();
              if (!pid) continue;
              if (seen.has(pid)) list.splice(i,1);
              else seen.add(pid);
            }
          }
          // B) DOM dedupe (keep the top-most row)
          var body = byId('pending_body');
          if (body){
            var rows = Array.from(body.querySelectorAll('tr[data-id="'+CSS.escape(id)+'"]'));
            if (rows.length > 1){
              // keep the first occurrence (top), remove the rest
              rows.slice(1).forEach(function(r){ r.remove(); });
            }
            // also, make sure the first occurrence is at very top
            var first = body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
            if (first && body.firstChild !== first){
              body.insertBefore(first, body.firstChild);
            }
          }
          // C) Mark committed so subsequent duplicate flows skip
          window.__ccl_committed_ids__.add(id);
        }catch(e){ console.error('Post-submit reconciliation failed', e); }
      }, 60);
    });
  }

  // 3) Optional: provide a helper for other patches to check commit registry
  window.__ccl_maybe_skip_commit__ = function(id){
    try{
      if (!id) return false;
      if (window.__ccl_committed_ids__.has(id)) return true;
    }catch(_){}
    return false;
  };

  // Initialize
  if (document.readyState !== 'loading'){ captureBind(); bindAfter(); }
  else document.addEventListener('DOMContentLoaded', function(){ captureBind(); bindAfter(); }, {once:true});
})();
</script>

<!-- CCL: Auto-switch to Pickups after Dispatch confirm -->
<script>
(function(){
  if (window.__ccl_dispatch_switch_wired__) return;
  window.__ccl_dispatch_switch_wired__ = true;

  function byId(id){ return document.getElementById(id); }

  // Patch confirm modal "Yes" specifically when text matches dispatch
  function hookConfirm(){
    var yesBtn = byId('confirm_yes');
    if (!yesBtn || yesBtn.__ccl_dispatch_hooked__) return;
    yesBtn.__ccl_dispatch_hooked__ = true;

    yesBtn.addEventListener('click', function(){
      try{
        var ct = byId('confirm_text');
        if (ct && /Move selected pickup\(s\) to Pickups\?/i.test(ct.textContent)){
          if (typeof window.switchTab === 'function'){
            setTimeout(function(){ window.switchTab('pickups'); }, 50);
          }
        }
      }catch(e){ console.error('Dispatch auto-switch failed', e); }
    });
  }

  if (document.readyState !== 'loading') hookConfirm();
  else document.addEventListener('DOMContentLoaded', hookConfirm, {once:true});
})();
</script>

<!-- CCL: Ensure new pickup always at top -->
<script>
(function(){
  if (window.__ccl_top_reconcile__) return;
  window.__ccl_top_reconcile__ = true;

  function byId(id){ return document.getElementById(id); }

  function enforceTop(id){
    try{
      var body = byId('pending_body');
      if (!body || !id) return;
      var rows = body.querySelectorAll('tr[data-id="'+CSS.escape(id)+'"]');
      if (!rows.length) return;
      var first = rows[0];
      // Move first occurrence to top
      if (body.firstChild !== first){ body.insertBefore(first, body.firstChild); }
      // Remove duplicates after first
      for (var i=1;i<rows.length;i++){ rows[i].remove(); }
    }catch(e){ console.error('enforceTop error', e); }
  }

  function wire(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_top_hook__) return;
    btn.__ccl_top_hook__ = true;
    btn.addEventListener('click', function(){
      setTimeout(function(){
        try{
          var idEl = byId('c_id');
          var idVal = (idEl && idEl.value||'').trim();
          if (!idVal) return;
          enforceTop(idVal);
        }catch(e){}
      }, 80);
    });
  }

  if (document.readyState !== 'loading') wire();
  else document.addEventListener('DOMContentLoaded', wire, {once:true});
})();
</script>

<!-- CCL: Always-top insertion for newly created pickups (data + UI) -->
<script>
(function(){
  if (window.__ccl_always_top_wired__) return;
  window.__ccl_always_top_wired__ = true;

  function byId(id){ return document.getElementById(id); }
  function bodyEl(){ return byId('pending_body'); }

  function pendingList(){
    try { return pending; } catch(e) { return (window.__ccl_pending = window.__ccl_pending || []); }
  }

  function unshiftUniqueTop(rec){
    var list = pendingList();
    // remove any existing with same id
    for (var i=list.length-1; i>=0; i--){
      if ((list[i].id||'') === (rec.id||'')) list.splice(i,1);
    }
    list.unshift(rec);
  }

  function moveRowToTopById(id){
    var body = bodyEl(); if (!body) return;
    var row = body.querySelector('tr[data-id="'+CSS.escape(id)+'"]');
    if (row && body.firstChild !== row){
      body.insertBefore(row, body.firstChild);
    }
  }

  function dedupeDOMKeepTop(){
    var body = bodyEl(); if (!body) return;
    var seen = Object.create(null);
    Array.from(body.querySelectorAll('tr[data-id]')).forEach(function(tr){
      var id = tr.getAttribute('data-id') || '';
      if (!id) return;
      if (seen[id]) tr.remove();
      else seen[id] = true;
    });
  }

  // Patch renderPending so it prefers newest-first (by _createdTs if present)
  (function patchRender(){
    if (typeof window.renderPending !== 'function') return;
    var orig = window.renderPending;
    window.renderPending = function(){
      try{
        // pre-sort list
        var list = pendingList();
        list.sort(function(a,b){
          var ta = a && a._createdTs || 0;
          var tb = b && b._createdTs || 0;
          return tb - ta; // newest first
        });
      }catch(_){}
      orig.apply(this, arguments);
      try{
        dedupeDOMKeepTop();
        // also ensure DOM order mirrors list order (by moving rows to match)
        var body = bodyEl(); if (!body) return;
        var idToRow = {};
        Array.from(body.children).forEach(function(tr){ idToRow[tr.getAttribute('data-id')||''] = tr; });
        var frag = document.createDocumentFragment();
        pendingList().forEach(function(rec){
          var r = idToRow[rec.id||''];
          if (r) frag.appendChild(r);
        });
        // append any leftovers (unlikely)
        Array.from(body.children).forEach(function(tr){ frag.appendChild(tr); });
        body.innerHTML=''; body.appendChild(frag);
      }catch(_){}
    };
  })();

  // Hook Create->Update again to enforce top insertion
  (function wireCreateTop(){
    var btn = byId('btn_create_update');
    if (!btn || btn.__ccl_top_wired__) return;
    btn.__ccl_top_wired__ = true;
    btn.addEventListener('click', function(){
      setTimeout(function(){
        try{
          function gv(id){ var el=byId(id); return (el && el.value) ? el.value : ''; }
          var id = (gv('c_id') || ('CCL-' + (Date.now()%1000000).toString().padStart(6,'0'))).trim();
          var rec = {
            id: id, from: gv('c_from'), to: gv('c_to'), container: gv('c_container'),
            appt: gv('c_appt'), bk: gv('c_bkpin'), window: gv('c_window'),
            pudate: gv('c_pudate'), deliveryDate: gv('c_deliveryDate'),
            lfd: gv('c_lfd'), returnDate: gv('c_returnDate'), returnPort: gv('c_returnPort'),
            customer: gv('c_customer'), chassis: gv('c_chassis'), size: gv('c_size'),
            pin: gv('c_pin'), ie: gv('c_impexp'), remark: gv('c_instruction'),
            loadempty: gv('c_loadempty'), status: 'Open',
            _createdTs: Date.now()
          };
          // Put newest at index 0 in data
          unshiftUniqueTop(rec);
          // If a renderer exists, let it redraw (which is already patched to keep newest-first)
          if (typeof window.renderPending === 'function') { try{ window.renderPending(); }catch(_){ } }
          // Ensure the DOM row is at the very top
          moveRowToTopById(rec.id);
          // Final dedupe
          dedupeDOMKeepTop();
        }catch(e){ console.error('always-top create handler failed', e); }
      }, 30);
    });
  })();

})();

// CCL watchdog: ensure Main Dispatch details match badge on load
(function(){
  function reconcilePendingList(){
    try{
      var body=document.getElementById('pending_body')||document.querySelector('#section_pending tbody');
      if(!body || !Array.isArray(window.pending)) return;
      var rows=body.querySelectorAll('tr').length;
      if(rows !== window.pending.length){
        if(typeof renderPending==='function') renderPending();
        if(typeof updateBadges==='function') updateBadges();
      }
    }catch(_){}
  }
  if(document.readyState!=='loading') setTimeout(reconcilePendingList, 80);
  else document.addEventListener('DOMContentLoaded', function(){ setTimeout(reconcilePendingList, 80); }, {once:true});
})();
</script>
